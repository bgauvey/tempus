@page "/settings"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Tempus.Core.Interfaces
@using Tempus.Core.Models
@using Tempus.Core.Enums
@attribute [Authorize]
@inject ISettingsService SettingsService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NotificationService NotificationService
@inject IGoogleCalendarService GoogleCalendarService
@inject IAppleCalendarService AppleCalendarService
@inject IOutlookCalendarService OutlookCalendarService
@inject ICalendarIntegrationRepository IntegrationRepository
@inject NavigationManager NavigationManager
@inject DialogService DialogService

<PageTitle>Settings - Tempus</PageTitle>

<div style="padding: var(--space-xl);">
    <RadzenStack Gap="var(--space-xl)">
        <!-- Simplified Header (no gradient) -->
        <RadzenCard class="bg-primary border-light" Style="padding: var(--space-xl);">
            <RadzenStack Gap="var(--space-sm)">
                <RadzenText TextStyle="TextStyle.H3" class="font-bold text-primary" Style="margin: 0;">Calendar Settings</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" class="text-secondary">
                    Customize your calendar experience and preferences.
                </RadzenText>
            </RadzenStack>
        </RadzenCard>

        @if (_settings != null)
        {
            <!-- Essential Settings Card -->
            <RadzenCard class="bg-primary border-light shadow-sm" Style="padding: var(--space-xl);">
                <RadzenStack Gap="var(--space-xl)">
                    <RadzenText TextStyle="TextStyle.H5" class="font-semibold text-primary">Essential Settings</RadzenText>

                    <!-- General Section -->
                    <RadzenStack Gap="var(--space-lg)">
                        <RadzenText TextStyle="TextStyle.Subtitle1" class="font-medium text-secondary">General</RadzenText>
                        <RadzenRow Gap="var(--space-lg)">
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Time Format" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenDropDown @bind-Value="_settings.TimeFormat"
                                                    Data="@(Enum.GetValues<TimeFormat>())"
                                                    Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Start of Week" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenDropDown @bind-Value="_settings.StartOfWeek"
                                                    Data="@(Enum.GetValues<DayOfWeek>())"
                                                    Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenStack>

                    <!-- Events Section -->
                    <RadzenStack Gap="var(--space-lg)">
                        <RadzenText TextStyle="TextStyle.Subtitle1" class="font-medium text-secondary">Events</RadzenText>
                        <RadzenRow Gap="var(--space-lg)">
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Default Meeting Duration (minutes)" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenNumeric @bind-Value="_settings.DefaultMeetingDuration"
                                                   Min="15"
                                                   Max="480"
                                                   Step="15"
                                                   Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Default Event Visibility" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenDropDown @bind-Value="_settings.DefaultEventVisibility"
                                                    Data="@(Enum.GetValues<EventVisibility>())"
                                                    Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenStack>

                    <!-- Work Hours Section -->
                    <RadzenStack Gap="var(--space-lg)">
                        <RadzenText TextStyle="TextStyle.Subtitle1" class="font-medium text-secondary">Work Hours</RadzenText>
                        <RadzenRow Gap="var(--space-lg)">
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Work Start Time" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenDatePicker @bind-Value="_workStartDateTime"
                                                      ShowTime="true"
                                                      TimeOnly="true"
                                                      DateFormat="@TimeFormatString"
                                                      HourFormat="@HourFormat"
                                                      Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Work End Time" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenDatePicker @bind-Value="_workEndDateTime"
                                                      ShowTime="true"
                                                      TimeOnly="true"
                                                      DateFormat="@TimeFormatString"
                                                      HourFormat="@HourFormat"
                                                      Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenStack>

                    <!-- Notifications Section -->
                    <RadzenStack Gap="var(--space-lg)">
                        <RadzenText TextStyle="TextStyle.Subtitle1" class="font-medium text-secondary">Notifications</RadzenText>
                        <RadzenRow Gap="var(--space-lg)">
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenStack Gap="var(--space-md)">
                                    <RadzenStack Gap="var(--space-sm)" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center">
                                        <RadzenCheckBox @bind-Value="_settings.EmailNotificationsEnabled" Name="emailNotif" />
                                        <RadzenLabel Text="Enable Email Notifications" Component="emailNotif" />
                                    </RadzenStack>

                                    <RadzenStack Gap="var(--space-sm)" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center">
                                        <RadzenCheckBox @bind-Value="_settings.DesktopNotificationsEnabled" Name="desktopNotif" />
                                        <RadzenLabel Text="Enable Desktop Notifications" Component="desktopNotif" />
                                    </RadzenStack>
                                </RadzenStack>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Default Reminder Times (comma-separated minutes)" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenTextBox @bind-Value="_settings.DefaultReminderTimes"
                                                   Placeholder="15,60"
                                                   Style="width: 100%;" />
                                </RadzenFormField>
                                <RadzenText TextStyle="TextStyle.Caption" class="text-tertiary" Style="margin-top: var(--space-xs);">
                                    Example: "15,60" for reminders 15 minutes and 1 hour before events
                                </RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>

            <!-- Advanced Settings (Collapsed by Default) -->
            <RadzenCard class="bg-primary border-light shadow-sm" Style="padding: var(--space-xl);">
                <RadzenExpander Expanded="_advancedSettingsExpanded">
                    <HeaderTemplate>
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="var(--space-sm)">
                            <RadzenText TextStyle="TextStyle.H5" class="font-semibold text-primary" Style="margin: 0;">Advanced Settings</RadzenText>
                            <RadzenBadge Text="Optional" BadgeStyle="BadgeStyle.Secondary" Variant="Variant.Outlined" />
                        </RadzenStack>
                    </HeaderTemplate>
                    <ChildContent>
                        <RadzenStack Gap="var(--space-xl)" Style="margin-top: var(--space-lg);">
                            <!-- Calendar Display -->
                            <RadzenStack Gap="var(--space-lg)">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="font-medium text-secondary">Calendar Display</RadzenText>
                                <RadzenRow Gap="var(--space-lg)">
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Default Calendar View" Variant="Variant.Outlined" Style="width: 100%;">
                                            <RadzenDropDown @bind-Value="_settings.DefaultCalendarView"
                                                            Data="@(Enum.GetValues<CalendarView>())"
                                                            Style="width: 100%;" />
                                        </RadzenFormField>
                                    </RadzenColumn>

                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Date Format" Variant="Variant.Outlined" Style="width: 100%;">
                                            <RadzenDropDown @bind-Value="_settings.DateFormat"
                                                            Data="@(Enum.GetValues<DateFormat>())"
                                                            Style="width: 100%;" />
                                        </RadzenFormField>
                                    </RadzenColumn>

                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenStack Gap="var(--space-md)">
                                            <RadzenStack Gap="var(--space-sm)" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center">
                                                <RadzenCheckBox @bind-Value="_settings.ShowWeekNumbers" Name="showWeekNumbers" />
                                                <RadzenLabel Text="Show Week Numbers" Component="showWeekNumbers" />
                                            </RadzenStack>
                                            <RadzenStack Gap="var(--space-sm)" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center">
                                                <RadzenCheckBox @bind-Value="_settings.ShowWeekendInWeekView" Name="showWeekend" />
                                                <RadzenLabel Text="Show Weekends in Week View" Component="showWeekend" />
                                            </RadzenStack>
                                        </RadzenStack>
                                    </RadzenColumn>
                                </RadzenRow>
                            </RadzenStack>

                            <!-- Work Hours Details -->
                            <RadzenStack Gap="var(--space-lg)">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="font-medium text-secondary">Work Hours Details</RadzenText>
                                <RadzenRow Gap="var(--space-lg)">
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Lunch Break Start (Optional)" Variant="Variant.Outlined" Style="width: 100%;">
                                            <RadzenDatePicker @bind-Value="_lunchStartDateTime"
                                                              ShowTime="true"
                                                              TimeOnly="true"
                                                              DateFormat="@TimeFormatString"
                                                              HourFormat="@HourFormat"
                                                              AllowClear="true"
                                                              Style="width: 100%;" />
                                        </RadzenFormField>
                                    </RadzenColumn>

                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Lunch Break End (Optional)" Variant="Variant.Outlined" Style="width: 100%;">
                                            <RadzenDatePicker @bind-Value="_lunchEndDateTime"
                                                              ShowTime="true"
                                                              TimeOnly="true"
                                                              DateFormat="@TimeFormatString"
                                                              HourFormat="@HourFormat"
                                                              AllowClear="true"
                                                              Style="width: 100%;" />
                                        </RadzenFormField>
                                    </RadzenColumn>

                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Time Slot Duration" Variant="Variant.Outlined" Style="width: 100%;">
                                            <RadzenDropDown @bind-Value="_settings.TimeSlotDuration"
                                                            Data="@(Enum.GetValues<TimeSlotDuration>())"
                                                            Style="width: 100%;" />
                                        </RadzenFormField>
                                    </RadzenColumn>

                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Buffer Between Events (minutes)" Variant="Variant.Outlined" Style="width: 100%;">
                                            <RadzenNumeric @bind-Value="_settings.BufferTimeBetweenEvents"
                                                           Min="0"
                                                           Max="60"
                                                           Style="width: 100%;" />
                                        </RadzenFormField>
                                    </RadzenColumn>
                                </RadzenRow>
                            </RadzenStack>

                            <!-- Event Defaults -->
                            <RadzenStack Gap="var(--space-lg)">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="font-medium text-secondary">Event Defaults</RadzenText>
                                <RadzenRow Gap="var(--space-lg)">
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Default Event Color" Variant="Variant.Outlined" Style="width: 100%;">
                                            <RadzenColorPicker @bind-Value="_settings.DefaultEventColor"
                                                             Style="width: 100%;" />
                                        </RadzenFormField>
                                    </RadzenColumn>

                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Default Location" Variant="Variant.Outlined" Style="width: 100%;">
                                            <RadzenTextBox @bind-Value="_settings.DefaultLocation"
                                                           Placeholder="e.g., Office, Remote"
                                                           Style="width: 100%;" />
                                        </RadzenFormField>
                                    </RadzenColumn>
                                </RadzenRow>
                            </RadzenStack>

                            <!-- Privacy & Sharing -->
                            <RadzenStack Gap="var(--space-lg)">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="font-medium text-secondary">Free/Busy Information Sharing</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" class="text-tertiary">
                                    Control who can see when you're available or busy without revealing event details.
                                </RadzenText>
                                <RadzenRow Gap="var(--space-lg)">
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenStack Gap="var(--space-md)">
                                            <RadzenStack Gap="var(--space-sm)" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center">
                                                <RadzenCheckBox @bind-Value="_settings.PublishFreeBusyInformation" Name="publishFreeBusy" />
                                                <RadzenLabel Text="Share my free/busy information" Component="publishFreeBusy" />
                                            </RadzenStack>

                                            <RadzenStack Gap="var(--space-sm)" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center">
                                                <RadzenCheckBox @bind-Value="_settings.ShowPrivateEventsAsBusy" Name="showPrivateAsBusy" />
                                                <RadzenLabel Text="Show private events as 'Busy'" Component="showPrivateAsBusy" />
                                            </RadzenStack>
                                        </RadzenStack>
                                    </RadzenColumn>

                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Who can see my free/busy times" Variant="Variant.Outlined" Style="width: 100%;">
                                            <RadzenDropDown @bind-Value="_settings.FreeBusySharingLevel"
                                                            Data="@(Enum.GetValues<FreeBusySharingLevel>())"
                                                            Disabled="@(!_settings.PublishFreeBusyInformation)"
                                                            Style="width: 100%;" />
                                        </RadzenFormField>
                                        <RadzenText TextStyle="TextStyle.Caption" class="text-tertiary" Style="margin-top: var(--space-xs);">
                                            @GetFreeBusySharingLevelDescription(_settings.FreeBusySharingLevel)
                                        </RadzenText>
                                    </RadzenColumn>

                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Look-ahead period (days)" Variant="Variant.Outlined" Style="width: 100%;">
                                            <RadzenNumeric @bind-Value="_settings.FreeBusyLookAheadDays"
                                                           Min="7"
                                                           Max="365"
                                                           Step="7"
                                                           Disabled="@(!_settings.PublishFreeBusyInformation)"
                                                           Style="width: 100%;" />
                                        </RadzenFormField>
                                        <RadzenText TextStyle="TextStyle.Caption" class="text-tertiary" Style="margin-top: var(--space-xs);">
                                            How many days ahead to share your availability
                                        </RadzenText>
                                    </RadzenColumn>
                                </RadzenRow>
                            </RadzenStack>
                        </RadzenStack>
                    </ChildContent>
                </RadzenExpander>
            </RadzenCard>

            <!-- Integrations Section (Collapsed by Default) -->
            <RadzenCard class="bg-primary border-light shadow-sm" Style="padding: var(--space-xl);">
                <RadzenExpander Expanded="_integrationsExpanded">
                    <HeaderTemplate>
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="var(--space-sm)">
                            <RadzenText TextStyle="TextStyle.H5" class="font-semibold text-primary" Style="margin: 0;">Calendar Integrations</RadzenText>
                            @if ((_googleIntegration?.IsEnabled ?? false) || (_outlookIntegration?.IsEnabled ?? false) || (_appleIntegration?.IsEnabled ?? false))
                            {
                                <RadzenBadge Text="Connected" BadgeStyle="BadgeStyle.Success" />
                            }
                        </RadzenStack>
                    </HeaderTemplate>
                    <ChildContent>
                        <RadzenStack Gap="var(--space-lg)" Style="margin-top: var(--space-lg);">
                            <RadzenText class="text-secondary">Connect your existing calendars to sync events with Tempus</RadzenText>

                            <RadzenRow Gap="var(--space-lg)">
                                <!-- Google Calendar -->
                                <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                                    <RadzenCard class="border-light" Style="height: 100%; padding: var(--space-lg);">
                                        <RadzenStack Gap="var(--space-md)">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="var(--space-sm)">
                                                <RadzenIcon Icon="cloud" Style="font-size: 2rem; color: var(--color-primary);" />
                                                <RadzenText TextStyle="TextStyle.H6" class="font-semibold">Google Calendar</RadzenText>
                                                @if (_googleIntegration != null && _googleIntegration.IsEnabled)
                                                {
                                                    <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Connected" />
                                                }
                                            </RadzenStack>
                                            <RadzenText TextStyle="TextStyle.Body2" class="text-secondary">
                                                Sync your Google Calendar events with Tempus. Two-way synchronization keeps everything up to date.
                                            </RadzenText>

                                            @if (_googleIntegration != null && _googleIntegration.IsEnabled)
                                            {
                                                <RadzenStack Gap="var(--space-sm)">
                                                    <RadzenText TextStyle="TextStyle.Caption" class="text-tertiary">
                                                        <strong>Calendar:</strong> @_googleIntegration.CalendarName
                                                    </RadzenText>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="text-tertiary">
                                                        <strong>Last synced:</strong> @(_googleIntegration.LastSyncedAt?.ToLocalTime().ToString("g") ?? "Never")
                                                    </RadzenText>

                                                    <RadzenStack Gap="var(--space-sm)" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Style="margin-top: var(--space-sm);">
                                                        <RadzenCheckBox @bind-Value="_googleIntegration.SyncEnabled" Name="syncEnabled" />
                                                        <RadzenLabel Text="Enable automatic synchronization" Component="syncEnabled" />
                                                    </RadzenStack>

                                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="var(--space-sm)" Style="margin-top: var(--space-sm);">
                                                        <RadzenButton ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Icon="sync" Text="Sync Now" Click="@SyncGoogleCalendar" Disabled="_isSyncing" />
                                                        <RadzenButton ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Icon="link_off" Text="Disconnect" Click="@DisconnectGoogleCalendar" />
                                                    </RadzenStack>
                                                    @if (_isSyncing)
                                                    {
                                                        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                                                    }
                                                </RadzenStack>
                                            }
                                            else
                                            {
                                                <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="link" Text="Connect Google Calendar" Click="@ConnectGoogleCalendar" Style="margin-top: var(--space-sm);" />
                                            }
                                        </RadzenStack>
                                    </RadzenCard>
                                </RadzenColumn>

                                <!-- Outlook Calendar -->
                                <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                                    <RadzenCard class="border-light" Style="height: 100%; padding: var(--space-lg);">
                                        <RadzenStack Gap="var(--space-md)">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="var(--space-sm)">
                                                <RadzenIcon Icon="mail" Style="font-size: 2rem; color: var(--color-primary);" />
                                                <RadzenText TextStyle="TextStyle.H6" class="font-semibold">Microsoft Outlook</RadzenText>
                                                @if (_outlookIntegration != null && _outlookIntegration.IsEnabled)
                                                {
                                                    <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Connected" />
                                                }
                                            </RadzenStack>
                                            <RadzenText TextStyle="TextStyle.Body2" class="text-secondary">
                                                Connect your Outlook or Office 365 calendar for seamless event synchronization.
                                            </RadzenText>

                                            @if (_outlookIntegration != null && _outlookIntegration.IsEnabled)
                                            {
                                                <RadzenStack Gap="var(--space-sm)">
                                                    <RadzenText TextStyle="TextStyle.Caption" class="text-tertiary">
                                                        <strong>Calendar:</strong> @_outlookIntegration.CalendarName
                                                    </RadzenText>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="text-tertiary">
                                                        <strong>Last synced:</strong> @(_outlookIntegration.LastSyncedAt?.ToLocalTime().ToString("g") ?? "Never")
                                                    </RadzenText>

                                                    <RadzenStack Gap="var(--space-sm)" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Style="margin-top: var(--space-sm);">
                                                        <RadzenCheckBox @bind-Value="_outlookIntegration.SyncEnabled" Name="syncEnabledOutlook" />
                                                        <RadzenLabel Text="Enable automatic synchronization" Component="syncEnabledOutlook" />
                                                    </RadzenStack>

                                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="var(--space-sm)" Style="margin-top: var(--space-sm);">
                                                        <RadzenButton ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Icon="sync" Text="Sync Now" Click="@SyncOutlookCalendar" Disabled="_isSyncingOutlook" />
                                                        <RadzenButton ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Icon="link_off" Text="Disconnect" Click="@DisconnectOutlookCalendar" />
                                                    </RadzenStack>
                                                    @if (_isSyncingOutlook)
                                                    {
                                                        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                                                    }
                                                </RadzenStack>
                                            }
                                            else
                                            {
                                                <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="link" Text="Connect Outlook Calendar" Click="@ConnectOutlookCalendar" Style="margin-top: var(--space-sm);" />
                                            }
                                        </RadzenStack>
                                    </RadzenCard>
                                </RadzenColumn>

                                <!-- Apple Calendar -->
                                <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                                    <RadzenCard class="border-light" Style="height: 100%; padding: var(--space-lg);">
                                        <RadzenStack Gap="var(--space-md)">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="var(--space-sm)">
                                                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink: 0; color: var(--color-primary);">
                                                    <path d="M 16.125 1 C 14.972 1.067 13.648328 1.7093438 12.861328 2.5273438 C 12.150328 3.2713438 11.589359 4.3763125 11.818359 5.4453125 C 13.071359 5.4783125 14.329031 4.8193281 15.082031 3.9863281 C 15.785031 3.2073281 16.318 2.12 16.125 1 z M 16.193359 5.4433594 C 14.384359 5.4433594 13.628 6.5546875 12.375 6.5546875 C 11.086 6.5546875 9.9076562 5.5136719 8.3476562 5.5136719 C 6.2256562 5.5146719 3 7.4803281 3 12.111328 C 3 16.324328 6.8176563 21 8.9726562 21 C 10.281656 21.013 10.599 20.176969 12.375 20.167969 C 14.153 20.154969 14.536656 21.011 15.847656 21 C 17.323656 20.989 18.476359 19.367031 19.318359 18.082031 C 19.922359 17.162031 20.170672 16.692344 20.638672 15.652344 C 17.165672 14.772344 16.474672 9.1716719 20.638672 8.0136719 C 19.852672 6.6726719 17.558359 5.4433594 16.193359 5.4433594 z"/>
                                                </svg>
                                                <RadzenText TextStyle="TextStyle.H6" class="font-semibold">Apple Calendar</RadzenText>
                                                @if (_appleIntegration != null && _appleIntegration.IsEnabled)
                                                {
                                                    <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Connected" />
                                                }
                                            </RadzenStack>
                                            <RadzenText TextStyle="TextStyle.Body2" class="text-secondary">
                                                Sync with Apple Calendar using CalDAV protocol for iCloud calendar integration.
                                            </RadzenText>

                                            @if (_appleIntegration != null && _appleIntegration.IsEnabled)
                                            {
                                                <RadzenStack Gap="var(--space-sm)">
                                                    <RadzenText TextStyle="TextStyle.Caption" class="text-tertiary">
                                                        <strong>Calendar:</strong> @_appleIntegration.CalendarName
                                                    </RadzenText>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="text-tertiary">
                                                        <strong>Last synced:</strong> @(_appleIntegration.LastSyncedAt?.ToLocalTime().ToString("g") ?? "Never")
                                                    </RadzenText>

                                                    <RadzenStack Gap="var(--space-sm)" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Style="margin-top: var(--space-sm);">
                                                        <RadzenCheckBox @bind-Value="_appleIntegration.SyncEnabled" Name="syncEnabledApple" />
                                                        <RadzenLabel Text="Enable automatic synchronization" Component="syncEnabledApple" />
                                                    </RadzenStack>

                                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="var(--space-sm)" Style="margin-top: var(--space-sm);">
                                                        <RadzenButton ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Icon="sync" Text="Sync Now" Click="@SyncAppleCalendar" Disabled="_isSyncingApple" />
                                                        <RadzenButton ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Icon="link_off" Text="Disconnect" Click="@DisconnectAppleCalendar" />
                                                    </RadzenStack>
                                                    @if (_isSyncingApple)
                                                    {
                                                        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                                                    }
                                                </RadzenStack>
                                            }
                                            else
                                            {
                                                <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="link" Text="Connect Apple Calendar" Click="@ConnectAppleCalendar" Style="margin-top: var(--space-sm);" />
                                            }
                                        </RadzenStack>
                                    </RadzenCard>
                                </RadzenColumn>
                            </RadzenRow>

                            <!-- Integration Features Info -->
                            <RadzenCard class="bg-secondary border-light" Style="padding: var(--space-lg); margin-top: var(--space-md);">
                                <RadzenStack Gap="var(--space-md)">
                                    <RadzenText TextStyle="TextStyle.Subtitle1" class="font-semibold">Integration Features</RadzenText>
                                    <RadzenStack Gap="var(--space-sm)">
                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="var(--space-sm)" AlignItems="AlignItems.Start">
                                            <RadzenIcon Icon="sync" Style="color: var(--color-primary);" />
                                            <RadzenText class="text-secondary"><strong>Two-way synchronization</strong> - Changes in Tempus reflect in your connected calendars and vice versa</RadzenText>
                                        </RadzenStack>
                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="var(--space-sm)" AlignItems="AlignItems.Start">
                                            <RadzenIcon Icon="security" Style="color: var(--color-primary);" />
                                            <RadzenText class="text-secondary"><strong>Secure OAuth2 authentication</strong> - Your credentials are never stored, only secure access tokens</RadzenText>
                                        </RadzenStack>
                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="var(--space-sm)" AlignItems="AlignItems.Start">
                                            <RadzenIcon Icon="cloud_queue" Style="color: var(--color-primary);" />
                                            <RadzenText class="text-secondary"><strong>Real-time updates</strong> - Events sync automatically when enabled</RadzenText>
                                        </RadzenStack>
                                    </RadzenStack>
                                </RadzenStack>
                            </RadzenCard>

                            @if ((_googleIntegration == null || !_googleIntegration.IsEnabled) &&
                                 (_appleIntegration == null || !_appleIntegration.IsEnabled) &&
                                 (_outlookIntegration == null || !_outlookIntegration.IsEnabled))
                            {
                                <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter">
                                    Connect your Google Calendar, Outlook, or Apple Calendar to enable two-way synchronization. You can also use the ICS import feature to bring in events from your existing calendars.
                                </RadzenAlert>
                            }
                        </RadzenStack>
                    </ChildContent>
                </RadzenExpander>
            </RadzenCard>

            <!-- Save Button -->
            <RadzenStack Orientation="Orientation.Horizontal" Gap="var(--space-md)" JustifyContent="JustifyContent.End">
                <RadzenButton Text="Save Settings"
                              Icon="save"
                              ButtonStyle="ButtonStyle.Primary"
                              Click="@SaveSettings"
                              Style="padding: var(--space-sm) var(--space-xl); border-radius: var(--radius-md);" />
            </RadzenStack>
        }
        else
        {
            <RadzenCard class="bg-primary border-light" Style="padding: var(--space-2xl); text-align: center;">
                <RadzenStack Gap="var(--space-md)" AlignItems="AlignItems.Center">
                    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                    <RadzenText class="text-secondary">Loading settings...</RadzenText>
                </RadzenStack>
            </RadzenCard>
        }
    </RadzenStack>
</div>

<style>
    /* Settings Page Styling - Simplified Design System */

    /* Expander styling */
    .rz-expander {
        border: none;
    }

    .rz-expander-header {
        padding: 0;
        background: transparent;
        border: none;
    }

    .rz-expander-header:hover {
        background: transparent;
    }

    .rz-expander-content {
        padding: 0;
        border: none;
    }

    /* Card transitions */
    .rz-card {
        transition: box-shadow var(--transition-base);
    }

    .rz-card:hover {
        box-shadow: var(--shadow-md);
    }

    /* Form field improvements */
    .rz-formfield {
        margin-bottom: 0;
    }

    /* Checkbox label alignment */
    .rz-checkbox + .rz-label {
        cursor: pointer;
        user-select: none;
    }
</style>

@code {
    private CalendarSettings? _settings;
    private DateTime _workStartDateTime;
    private DateTime _workEndDateTime;
    private DateTime? _lunchStartDateTime;
    private DateTime? _lunchEndDateTime;

    // Expander state variables
    private bool _advancedSettingsExpanded = false;
    private bool _integrationsExpanded = false;

    // Calendar integrations
    private CalendarIntegration? _googleIntegration;
    private CalendarIntegration? _appleIntegration;
    private CalendarIntegration? _outlookIntegration;
    private bool _isSyncing = false;
    private bool _isSyncingApple = false;
    private bool _isSyncingOutlook = false;
    private string _userId = string.Empty;

    private string TimeFormatString => _settings?.TimeFormat == TimeFormat.TwelveHour ? "hh:mm tt" : "HH:mm";
    private string HourFormat => _settings?.TimeFormat == TimeFormat.TwelveHour ? "12" : "24";

    protected override async Task OnInitializedAsync()
    {
        // Get current user
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user?.Identity?.IsAuthenticated == true)
        {
            var appUser = await UserManager.GetUserAsync(user);
            if (appUser != null)
            {
                _userId = appUser.Id;

                // Load or create settings
                _settings = await SettingsService.GetOrCreateDefaultSettingsAsync(appUser.Id);

                // Apply smart defaults for settings simplification
                if (_settings.ShowWeekNumbers == false)
                {
                    _settings.ShowWeekNumbers = true; // Smart default: show week numbers
                }

                // Convert TimeSpan to DateTime for the time pickers
                _workStartDateTime = DateTime.Today.Add(_settings.WorkHoursStart);
                _workEndDateTime = DateTime.Today.Add(_settings.WorkHoursEnd);

                if (_settings.LunchBreakStart.HasValue)
                    _lunchStartDateTime = DateTime.Today.Add(_settings.LunchBreakStart.Value);

                if (_settings.LunchBreakEnd.HasValue)
                    _lunchEndDateTime = DateTime.Today.Add(_settings.LunchBreakEnd.Value);

                // Load calendar integrations
                await LoadIntegrations();
            }
        }
    }

    private async Task SaveSettings()
    {
        if (_settings == null) return;

        // Convert DateTime back to TimeSpan
        _settings.WorkHoursStart = _workStartDateTime.TimeOfDay;
        _settings.WorkHoursEnd = _workEndDateTime.TimeOfDay;
        _settings.LunchBreakStart = _lunchStartDateTime?.TimeOfDay;
        _settings.LunchBreakEnd = _lunchEndDateTime?.TimeOfDay;

        await SettingsService.CreateOrUpdateSettingsAsync(_settings);

        // Save calendar integration sync settings if changed
        if (_googleIntegration != null)
        {
            await IntegrationRepository.UpdateAsync(_googleIntegration);
        }

        if (_appleIntegration != null)
        {
            await IntegrationRepository.UpdateAsync(_appleIntegration);
        }

        if (_outlookIntegration != null)
        {
            await IntegrationRepository.UpdateAsync(_outlookIntegration);
        }

        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Success,
            Summary = "Settings Saved",
            Detail = "Your calendar settings have been updated successfully.",
            Duration = 4000
        });
    }

    // Calendar Integration Methods
    private async Task LoadIntegrations()
    {
        _googleIntegration = await IntegrationRepository.GetByProviderAsync(_userId, "Google");
        _appleIntegration = await IntegrationRepository.GetByProviderAsync(_userId, "Apple");
        _outlookIntegration = await IntegrationRepository.GetByProviderAsync(_userId, "Outlook");
        StateHasChanged();
    }

    private void ConnectGoogleCalendar()
    {
        try
        {
            var redirectUri = $"{NavigationManager.BaseUri}google-callback";
            var authUrl = GoogleCalendarService.GetAuthorizationUrl(_userId, redirectUri);
            NavigationManager.NavigateTo(authUrl, forceLoad: true);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Connection Failed",
                Detail = ex.Message,
                Duration = 5000
            });
        }
    }

    private async Task SyncGoogleCalendar()
    {
        _isSyncing = true;
        StateHasChanged();

        try
        {
            var result = await GoogleCalendarService.SyncBothWaysAsync(_userId);

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Sync Complete",
                Detail = $"Imported {result.imported} events from Google, exported {result.exported} events to Google",
                Duration = 5000
            });

            await LoadIntegrations();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Sync Failed",
                Detail = ex.Message,
                Duration = 5000
            });
        }
        finally
        {
            _isSyncing = false;
            StateHasChanged();
        }
    }

    private async Task DisconnectGoogleCalendar()
    {
        var confirmed = await DialogService.Confirm(
            "Are you sure you want to disconnect Google Calendar? This will stop synchronization but won't delete any existing events.",
            "Disconnect Google Calendar",
            new ConfirmOptions { OkButtonText = "Disconnect", CancelButtonText = "Cancel" }
        );

        if (confirmed == true && _googleIntegration != null)
        {
            try
            {
                await IntegrationRepository.DeleteAsync(_googleIntegration.Id);
                _googleIntegration = null;

                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Info,
                    Summary = "Google Calendar Disconnected",
                    Detail = "Your Google Calendar has been disconnected from Tempus",
                    Duration = 5000
                });

                StateHasChanged();
            }
            catch (Exception ex)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Disconnect Failed",
                    Detail = ex.Message,
                    Duration = 5000
                });
            }
        }
    }

    // Apple Calendar methods
    private void ConnectAppleCalendar()
    {
        NavigationManager.NavigateTo("/apple-calendar-connect");
    }

    private async Task SyncAppleCalendar()
    {
        _isSyncingApple = true;
        StateHasChanged();

        try
        {
            var result = await AppleCalendarService.SyncBothWaysAsync(_userId);

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Sync Complete",
                Detail = $"Imported {result.imported} events from Apple Calendar, exported {result.exported} events to Apple Calendar",
                Duration = 5000
            });

            await LoadIntegrations();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Sync Failed",
                Detail = ex.Message,
                Duration = 5000
            });
        }
        finally
        {
            _isSyncingApple = false;
            StateHasChanged();
        }
    }

    private async Task DisconnectAppleCalendar()
    {
        var confirmed = await DialogService.Confirm(
            "Are you sure you want to disconnect Apple Calendar? This will stop synchronization but won't delete any existing events.",
            "Disconnect Apple Calendar",
            new ConfirmOptions { OkButtonText = "Disconnect", CancelButtonText = "Cancel" }
        );

        if (confirmed == true && _appleIntegration != null)
        {
            try
            {
                await IntegrationRepository.DeleteAsync(_appleIntegration.Id);
                _appleIntegration = null;

                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Info,
                    Summary = "Apple Calendar Disconnected",
                    Detail = "Your Apple Calendar has been disconnected from Tempus",
                    Duration = 5000
                });

                StateHasChanged();
            }
            catch (Exception ex)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Disconnect Failed",
                    Detail = ex.Message,
                    Duration = 5000
                });
            }
        }
    }

    // Outlook Calendar methods
    private void ConnectOutlookCalendar()
    {
        try
        {
            var redirectUri = $"{NavigationManager.BaseUri}outlook-callback";
            var authUrl = OutlookCalendarService.GetAuthorizationUrl(_userId, redirectUri);
            NavigationManager.NavigateTo(authUrl, forceLoad: true);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Connection Failed",
                Detail = ex.Message,
                Duration = 5000
            });
        }
    }

    private async Task SyncOutlookCalendar()
    {
        _isSyncingOutlook = true;
        StateHasChanged();

        try
        {
            var result = await OutlookCalendarService.SyncBothWaysAsync(_userId);

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Sync Complete",
                Detail = $"Imported {result.imported} events from Outlook, exported {result.exported} events to Outlook",
                Duration = 5000
            });

            await LoadIntegrations();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Sync Failed",
                Detail = ex.Message,
                Duration = 5000
            });
        }
        finally
        {
            _isSyncingOutlook = false;
            StateHasChanged();
        }
    }

    private async Task DisconnectOutlookCalendar()
    {
        var confirmed = await DialogService.Confirm(
            "Are you sure you want to disconnect Outlook Calendar? This will stop synchronization but won't delete any existing events.",
            "Disconnect Outlook Calendar",
            new ConfirmOptions { OkButtonText = "Disconnect", CancelButtonText = "Cancel" }
        );

        if (confirmed == true && _outlookIntegration != null)
        {
            try
            {
                await IntegrationRepository.DeleteAsync(_outlookIntegration.Id);
                _outlookIntegration = null;

                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Info,
                    Summary = "Outlook Calendar Disconnected",
                    Detail = "Your Outlook Calendar has been disconnected from Tempus",
                    Duration = 5000
                });

                StateHasChanged();
            }
            catch (Exception ex)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Disconnect Failed",
                    Detail = ex.Message,
                    Duration = 5000
                });
            }
        }
    }

    private string GetFreeBusySharingLevelDescription(FreeBusySharingLevel level)
    {
        return level switch
        {
            FreeBusySharingLevel.None => "Your free/busy information will not be shared with anyone",
            FreeBusySharingLevel.TeamMembers => "Only team members can see when you're free or busy",
            FreeBusySharingLevel.Organization => "All users in your organization can see when you're free or busy",
            FreeBusySharingLevel.Public => "Anyone with a link can see when you're free or busy",
            _ => ""
        };
    }
}
