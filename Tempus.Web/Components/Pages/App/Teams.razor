@page "/teams"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Tempus.Core.Interfaces
@using Tempus.Core.Models
@using Tempus.Core.Enums
@using Tempus.Web.Components.Account
@using Tempus.Web.Components.Shared
@attribute [Authorize]
@inject ITeamService TeamService
@inject IdentityUserAccessor IdentityUserAccessor
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject ILogger<Teams> Logger

<PageTitle>Teams - Tempus</PageTitle>

<SecondaryNav Items="@_navItems" />

<RadzenStack Gap="1.5rem">
    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
        <RadzenText TextStyle="TextStyle.H3">Teams</RadzenText>
        <RadzenButton Text="Create Team"
                    Icon="add"
                    ButtonStyle="ButtonStyle.Primary"
                    Click="@ShowCreateTeamDialog" />
    </RadzenStack>

    @if (_isLoading)
    {
        <RadzenStack Gap="1rem" Style="padding: 2rem;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            <RadzenText TextStyle="TextStyle.Body1" Style="text-align: center;">Loading teams...</RadzenText>
        </RadzenStack>
    }
    else if (!_teams.Any())
    {
        <RadzenCard Style="padding: 3rem; text-align: center;">
            <RadzenStack Gap="1rem" AlignItems="AlignItems.Center">
                <RadzenIcon Icon="groups" Style="font-size: 4rem; color: #a0aec0;" />
                <RadzenText TextStyle="TextStyle.H5">No teams yet</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" Style="color: #718096;">
                    Create a team to collaborate with others
                </RadzenText>
                <RadzenButton Text="Create Your First Team"
                            Icon="add"
                            ButtonStyle="ButtonStyle.Primary"
                            Click="@ShowCreateTeamDialog" />
            </RadzenStack>
        </RadzenCard>
    }
    else
    {
        <RadzenRow Gap="1rem">
            @foreach (var team in _teams)
            {
                <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                    <RadzenCard Style="height: 100%; cursor: pointer;" @onclick="@(() => ViewTeamDetails(team))">
                        <RadzenStack Gap="1rem">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Start">
                                <RadzenStack Gap="0.5rem" Style="flex: 1;">
                                    <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">
                                        @team.Name
                                    </RadzenText>
                                    @if (!string.IsNullOrEmpty(team.Description))
                                    {
                                        <RadzenText TextStyle="TextStyle.Body2" Style="color: #718096;">
                                            @team.Description
                                        </RadzenText>
                                    }
                                </RadzenStack>
                                @if (team.IsUserOwner(_userId))
                                {
                                    <RadzenBadge Text="Owner" BadgeStyle="BadgeStyle.Success" />
                                }
                                else if (team.IsUserAdmin(_userId))
                                {
                                    <RadzenBadge Text="Admin" BadgeStyle="BadgeStyle.Info" />
                                }
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem" AlignItems="AlignItems.Center">
                                    <RadzenIcon Icon="people" />
                                    <RadzenText TextStyle="TextStyle.Body2">
                                        @team.GetMemberCount() @(team.GetMemberCount() == 1 ? "member" : "members")
                                    </RadzenText>
                                </RadzenStack>
                                <RadzenText TextStyle="TextStyle.Caption" Style="color: #a0aec0;">
                                    Created @team.CreatedAt.ToLocalTime().ToString("MMM d, yyyy")
                                </RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenCard>
                </RadzenColumn>
            }
        </RadzenRow>
    }
</RadzenStack>

@code {
    private List<Team> _teams = new();
    private string _userId = string.Empty;
    private bool _isLoading = true;

    private List<SecondaryNav.SecondaryNavItem> _navItems = new()
    {
        new() { Text = "Contacts", Path = "/addresses", Icon = "contact_mail" },
        new() { Text = "Teams", Path = "/teams", Icon = "groups" }
    };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var appUser = await IdentityUserAccessor.GetUserAsync(user);
            if (appUser != null)
            {
                _userId = appUser.Id;
                await LoadTeams();
            }
        }

        _isLoading = false;
    }

    private async Task LoadTeams()
    {
        try
        {
            _teams = await TeamService.GetUserTeamsAsync(_userId);
            Logger.LogInformation("Loaded {Count} teams for user {UserId}", _teams.Count, _userId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading teams for user {UserId}", _userId);
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = "Failed to load teams",
                Duration = 4000
            });
        }
    }

    private async Task ShowCreateTeamDialog()
    {
        var result = await DialogService.OpenAsync("Create Team",
            ds => @<CreateTeamDialog OnTeamCreated="@OnTeamCreated" UserId="@_userId" />,
            new DialogOptions { Width = "600px" });
    }

    private async Task OnTeamCreated(Team team)
    {
        await LoadTeams();
        DialogService.Close();

        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Success,
            Summary = "Team Created",
            Detail = $"Team '{team.Name}' created successfully",
            Duration = 3000
        });
    }

    private void ViewTeamDetails(Team team)
    {
        NavigationManager.NavigateTo($"/teams/{team.Id}");
    }
}
