@page "/dashboard"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Tempus.Core.Interfaces
@using Tempus.Core.Models
@using Tempus.Web.Services
@using Microsoft.JSInterop
@using Tempus.Web.Components.Account
@using Tempus.Web.Components.Shared
@attribute [Authorize]
@inject IEventRepository EventRepository
@inject ISettingsService SettingsService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IdentityUserAccessor IdentityUserAccessor
@inject IPdfAgendaService PdfAgendaService
@inject IJSRuntime JSRuntime
@inject ITimeZoneConversionService TimeZoneConversionService
@inject ILogger<Dashboard> Logger

<PageTitle>Dashboard - Tempus</PageTitle>

<div class="dashboard-container">
    @if (_isLoading)
    {
        <SkeletonLoader Type="SkeletonType.Dashboard" Count="2" />
    }
    else
    {
        <RadzenStack Gap="var(--space-xl)">

        <!-- Card 1: Hero Section - "Today's Focus" -->
        <RadzenCard class="hero-card">
            <RadzenStack Gap="var(--space-sm)">
                <RadzenText TextStyle="TextStyle.DisplayH4" class="hero-greeting">
                    @GetGreeting()
                </RadzenText>
                <RadzenText TextStyle="TextStyle.H6" class="hero-date text-secondary">
                    @DateTime.Now.ToString("dddd, MMMM dd, yyyy")
                </RadzenText>
                <RadzenText TextStyle="TextStyle.H5" class="hero-event-count">
                    @if (_todayEvents == 0)
                    {
                        <text>No events scheduled today</text>
                    }
                    else if (_todayEvents == 1)
                    {
                        <text>You have 1 event today</text>
                    }
                    else
                    {
                        <text>You have @_todayEvents events today</text>
                    }
                </RadzenText>
            </RadzenStack>
        </RadzenCard>

        <!-- Card 2: Next Up -->
        <RadzenCard class="next-up-card">
            <RadzenStack Gap="var(--space-lg)">
                <RadzenText TextStyle="TextStyle.H5" class="font-bold">
                    Next Up
                </RadzenText>

                @if (_nextEvent != null)
                {
                    <div class="next-event-content">
                        <RadzenStack Gap="var(--space-md)">
                            <RadzenStack Gap="var(--space-xs)">
                                <RadzenText TextStyle="TextStyle.H6" class="font-semibold text-primary">
                                    @_nextEvent.Title @GetTimeZoneIndicator(_nextEvent)
                                </RadzenText>
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="var(--space-md)" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap">
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="var(--space-xs)" AlignItems="AlignItems.Center">
                                        <RadzenIcon Icon="schedule" Style="font-size: 1.25rem; color: var(--text-secondary);" />
                                        <RadzenText TextStyle="TextStyle.Body1" class="text-secondary">
                                            @GetDisplayTime(_nextEvent).ToString(DateTimeFormatString)
                                        </RadzenText>
                                    </RadzenStack>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Primary" Text="@_nextEvent.EventType.ToString()" />
                                </RadzenStack>
                            </RadzenStack>

                            @if (!string.IsNullOrEmpty(_nextEvent.Location))
                            {
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="var(--space-xs)" AlignItems="AlignItems.Start">
                                    <RadzenIcon Icon="location_on" Style="font-size: 1.25rem; color: var(--text-secondary);" />
                                    <RadzenText TextStyle="TextStyle.Body2" class="text-secondary">
                                        @_nextEvent.Location
                                    </RadzenText>
                                </RadzenStack>
                            }

                            @if (!string.IsNullOrEmpty(_nextEvent.Description))
                            {
                                <RadzenText TextStyle="TextStyle.Body2" class="text-secondary" Style="line-height: 1.6;">
                                    @_nextEvent.Description
                                </RadzenText>
                            }

                            <RadzenStack Orientation="Orientation.Horizontal" Gap="var(--space-sm)" Wrap="FlexWrap.Wrap">
                                @if (_nextEvent.VideoConference != null && !string.IsNullOrEmpty(_nextEvent.VideoConference.MeetingUrl))
                                {
                                    <RadzenButton ButtonStyle="ButtonStyle.Success"
                                                  Icon="videocam"
                                                  Text="Join Meeting"
                                                  Click="@(() => JoinMeeting(_nextEvent.VideoConference.MeetingUrl))"
                                                  Style="font-weight: 600;" />
                                }
                                <RadzenButton ButtonStyle="ButtonStyle.Light"
                                              Icon="info"
                                              Text="View Details"
                                              Click="@(() => NavigateToEvent(_nextEvent.Id))"
                                              Style="font-weight: 600;" />
                            </RadzenStack>
                        </RadzenStack>
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <RadzenStack Gap="var(--space-md)" AlignItems="AlignItems.Center" Style="text-align: center; padding: var(--space-2xl) var(--space-md);">
                            <RadzenIcon Icon="event_available" Style="font-size: 4rem; color: var(--color-gray-300);" />
                            <RadzenStack Gap="var(--space-xs)" AlignItems="AlignItems.Center">
                                <RadzenText TextStyle="TextStyle.H6" class="text-secondary">
                                    No upcoming events
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" class="text-tertiary">
                                    You're all caught up! Time to plan your next event.
                                </RadzenText>
                            </RadzenStack>
                            <RadzenButton ButtonStyle="ButtonStyle.Primary"
                                          Icon="add"
                                          Text="Create Event"
                                          Click="@(() => NavigationManager.NavigateTo("/events"))"
                                          Style="font-weight: 600; margin-top: var(--space-sm);" />
                        </RadzenStack>
                    </div>
                }
            </RadzenStack>
        </RadzenCard>

        <!-- Card 3: Today's Agenda -->
        <RadzenCard class="agenda-card">
            <RadzenStack Gap="var(--space-lg)">
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                    <RadzenText TextStyle="TextStyle.H5" class="font-bold">
                        Today's Agenda
                    </RadzenText>
                    @if (_todayEventsList.Any())
                    {
                        <RadzenButton ButtonStyle="ButtonStyle.Light"
                                      Icon="picture_as_pdf"
                                      Text="Download PDF"
                                      Click="DownloadTodayAgenda"
                                      Size="ButtonSize.Small"
                                      Style="font-weight: 600;" />
                    }
                </RadzenStack>

                @if (_todayEventsList.Any())
                {
                    <div class="agenda-list">
                        <RadzenStack Gap="var(--space-sm)">
                            @foreach (var evt in _todayEventsList)
                            {
                                <div class="agenda-item @GetEventTypeClass(evt.EventType)" @onclick="@(() => NavigateToEvent(evt.Id))">
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="var(--space-md)" AlignItems="AlignItems.Start">
                                        <div class="agenda-time">
                                            <RadzenText TextStyle="TextStyle.Body2" class="font-semibold">
                                                @GetDisplayTime(evt).ToString(_settings?.TimeFormat == Core.Enums.TimeFormat.TwentyFourHour ? "HH:mm" : "h:mm tt")
                                            </RadzenText>
                                        </div>
                                        <div class="agenda-details">
                                            <RadzenStack Gap="var(--space-xs)">
                                                <RadzenStack Orientation="Orientation.Horizontal" Gap="var(--space-sm)" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap">
                                                    <RadzenText TextStyle="TextStyle.Body1" class="font-semibold">
                                                        @evt.Title @GetTimeZoneIndicator(evt)
                                                    </RadzenText>
                                                    <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@evt.EventType.ToString()" Style="font-size: var(--text-xs);" />
                                                </RadzenStack>
                                                @if (!string.IsNullOrEmpty(evt.Location))
                                                {
                                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="var(--space-xs)" AlignItems="AlignItems.Center">
                                                        <RadzenIcon Icon="location_on" Style="font-size: 1rem; color: var(--text-tertiary);" />
                                                        <RadzenText TextStyle="TextStyle.Body2" class="text-tertiary">
                                                            @evt.Location
                                                        </RadzenText>
                                                    </RadzenStack>
                                                }
                                                @if (evt.VideoConference != null && !string.IsNullOrEmpty(evt.VideoConference.MeetingUrl))
                                                {
                                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="var(--space-xs)" AlignItems="AlignItems.Center">
                                                        <RadzenIcon Icon="videocam" Style="font-size: 1rem; color: var(--color-primary);" />
                                                        <RadzenText TextStyle="TextStyle.Body2" class="text-primary">
                                                            Video conference available
                                                        </RadzenText>
                                                    </RadzenStack>
                                                }
                                            </RadzenStack>
                                        </div>
                                    </RadzenStack>
                                </div>
                            }
                        </RadzenStack>
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <RadzenStack Gap="var(--space-md)" AlignItems="AlignItems.Center" Style="text-align: center; padding: var(--space-xl) var(--space-md);">
                            <RadzenIcon Icon="event_note" Style="font-size: 3rem; color: var(--color-gray-300);" />
                            <RadzenStack Gap="var(--space-xs)" AlignItems="AlignItems.Center">
                                <RadzenText TextStyle="TextStyle.Body1" class="text-secondary">
                                    No events scheduled for today
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" class="text-tertiary">
                                    Enjoy your free day or create a new event.
                                </RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                    </div>
                }
            </RadzenStack>
        </RadzenCard>

        </RadzenStack>
    }
</div>

<style>
    .dashboard-container {
        padding: var(--space-xl);
        max-width: 1200px;
        margin: 0 auto;
    }

    /* Hero Card - Today's Focus */
    .hero-card {
        background: var(--hero-gradient);
        color: white;
        padding: var(--space-2xl);
        border: none;
        box-shadow: var(--shadow-lg);
    }

    .hero-greeting {
        font-weight: 800;
        margin: 0;
    }

    .hero-date {
        opacity: 0.95;
        font-weight: 500;
    }

    .hero-event-count {
        margin-top: var(--space-sm);
        font-weight: 600;
        opacity: 0.95;
    }

    /* Next Up Card */
    .next-up-card {
        padding: var(--space-xl);
        border: 1px solid var(--border-light);
        box-shadow: var(--shadow-md);
    }

    .next-event-content {
        background: var(--bg-secondary);
        padding: var(--space-lg);
        border-radius: var(--radius-lg);
        border-left: 4px solid var(--color-primary);
    }

    /* Agenda Card */
    .agenda-card {
        padding: var(--space-xl);
        border: 1px solid var(--border-light);
        box-shadow: var(--shadow-sm);
    }

    .agenda-list {
        max-height: 600px;
        overflow-y: auto;
        padding-right: var(--space-xs);
    }

    .agenda-list::-webkit-scrollbar {
        width: 6px;
    }

    .agenda-list::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: var(--radius-sm);
    }

    .agenda-list::-webkit-scrollbar-thumb {
        background: var(--color-gray-300);
        border-radius: var(--radius-sm);
    }

    .agenda-list::-webkit-scrollbar-thumb:hover {
        background: var(--color-gray-400);
    }

    .agenda-item {
        padding: var(--space-md);
        background: var(--bg-primary);
        border: 1px solid var(--border-light);
        border-left: 4px solid var(--color-gray-300);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .agenda-item:hover {
        box-shadow: var(--shadow-sm);
        transform: translateX(4px);
        border-left-width: 4px;
    }

    .agenda-item.meeting { border-left-color: var(--color-meeting); }
    .agenda-item.task { border-left-color: var(--color-timeblock); }
    .agenda-item.appointment { border-left-color: var(--color-personal); }
    .agenda-item.deadline { border-left-color: var(--color-deadline); }
    .agenda-item.reminder { border-left-color: var(--color-work); }
    .agenda-item.other { border-left-color: var(--color-focus); }

    .agenda-time {
        min-width: 80px;
        text-align: left;
    }

    .agenda-details {
        flex: 1;
    }

    .empty-state {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
    }

    /* Mobile Responsive */
    @@media (max-width: 768px) {
        .dashboard-container {
            padding: var(--space-md);
        }

        .hero-card {
            padding: var(--space-xl);
        }

        .next-up-card,
        .agenda-card {
            padding: var(--space-md);
        }

        .next-event-content {
            padding: var(--space-md);
        }

        .agenda-item {
            padding: var(--space-sm);
        }

        .agenda-time {
            min-width: 60px;
            font-size: var(--text-xs);
        }

        .agenda-list {
            max-height: 400px;
        }
    }

    @@media (max-width: 480px) {
        .hero-greeting {
            font-size: var(--text-2xl) !important;
        }

        .hero-date {
            font-size: var(--text-base) !important;
        }

        .hero-event-count {
            font-size: var(--text-lg) !important;
        }
    }
</style>

@code {
    private bool _isLoading = true;
    private int _todayEvents;
    private Event? _nextEvent;
    private List<Event> _todayEventsList = new();

    private string _userId = string.Empty;
    private string _userName = "there";
    private string _userTimeZone = TimeZoneInfo.Local.Id;
    private CalendarSettings? _settings;

    private string DateTimeFormatString => _settings?.TimeFormat == Core.Enums.TimeFormat.TwentyFourHour
        ? "MMM dd, yyyy • HH:mm"
        : "MMM dd, yyyy • hh:mm tt";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            var appUser = await IdentityUserAccessor.GetUserAsync(user);
            if (appUser != null)
            {
                _userId = appUser.Id;
                _userTimeZone = appUser.TimeZone;

                // Get user's first name for greeting
                _userName = !string.IsNullOrWhiteSpace(appUser.FirstName)
                    ? appUser.FirstName
                    : (!string.IsNullOrWhiteSpace(appUser.Email) ? appUser.Email.Split('@')[0] : "there");

                // Load user's calendar settings for time format preference
                _settings = await SettingsService.GetOrCreateDefaultSettingsAsync(_userId);
            }
        }
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            _isLoading = true;
            var today = DateTime.Today;
            var now = DateTime.Now;

            var allEvents = await EventRepository.GetAllAsync(_userId);

            // Count today's events
            _todayEvents = allEvents.Count(e => GetDisplayTime(e).Date == today);

            // Get today's events list (sorted by time)
            _todayEventsList = allEvents
                .Where(e => GetDisplayTime(e).Date == today)
                .OrderBy(e => GetDisplayTime(e))
                .ToList();

            // Get the next upcoming event (could be today or future)
            _nextEvent = allEvents
                .Where(e => GetDisplayTime(e) >= now)
                .OrderBy(e => GetDisplayTime(e))
                .FirstOrDefault();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetGreeting()
    {
        var hour = DateTime.Now.Hour;
        string timeGreeting;

        if (hour >= 5 && hour < 12)
        {
            timeGreeting = "Good morning";
        }
        else if (hour >= 12 && hour < 17)
        {
            timeGreeting = "Good afternoon";
        }
        else
        {
            timeGreeting = "Good evening";
        }

        return $"{timeGreeting}, {_userName}";
    }

    private string GetEventTypeClass(Core.Enums.EventType eventType)
    {
        return eventType.ToString().ToLower();
    }

    private void NavigateToEvent(Guid eventId)
    {
        NavigationManager.NavigateTo($"/events/{eventId}");
    }

    private async Task JoinMeeting(string joinUrl)
    {
        await JSRuntime.InvokeVoidAsync("open", joinUrl, "_blank");
    }

    private async Task DownloadTodayAgenda()
    {
        try
        {
            var today = DateTime.Today;

            // Get user name
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var userName = "User";
            if (user.Identity?.IsAuthenticated == true)
            {
                var appUser = await IdentityUserAccessor.GetUserAsync(user);
                if (appUser != null)
                {
                    userName = $"{appUser.FirstName} {appUser.LastName}".Trim();
                    if (string.IsNullOrWhiteSpace(userName))
                    {
                        userName = appUser.Email ?? "User";
                    }
                }
            }

            // Generate PDF
            var pdfBytes = PdfAgendaService.GenerateDailyAgenda(_todayEventsList, today, userName);

            // Download file using inline JavaScript to avoid timing issues
            var fileName = $"Daily-Agenda-{today:yyyy-MM-dd}.pdf";
            var base64 = Convert.ToBase64String(pdfBytes);

            await JSRuntime.InvokeVoidAsync("eval", $@"
                (function() {{
                    const byteCharacters = atob('{base64}');
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {{
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }}
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], {{ type: 'application/pdf' }});
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = '{fileName}';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                }})();
            ");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error generating PDF");
        }
    }

    // Timezone helper methods
    private DateTime GetDisplayTime(Event evt)
    {
        // If event has a timezone different from user's, convert it
        if (!string.IsNullOrEmpty(evt.TimeZoneId) && evt.TimeZoneId != _userTimeZone)
        {
            var convertedEvent = TimeZoneConversionService.ConvertEventToUserTimeZone(evt, _userTimeZone);
            return convertedEvent.StartTime;
        }
        return evt.StartTime;
    }

    private string GetTimeZoneIndicator(Event evt)
    {
        if (!string.IsNullOrEmpty(evt.TimeZoneId) && evt.TimeZoneId != _userTimeZone)
        {
            try
            {
                var tz = TimeZoneInfo.FindSystemTimeZoneById(evt.TimeZoneId);
                var abbreviation = GetTimeZoneAbbreviation(tz);
                return $" ({abbreviation})";
            }
            catch
            {
                return "";
            }
        }
        return string.Empty;
    }

    private string GetTimeZoneAbbreviation(TimeZoneInfo tz)
    {
        var abbreviation = tz.IsDaylightSavingTime(DateTime.Now)
            ? tz.DaylightName
            : tz.StandardName;

        // Try to get a shorter abbreviation
        if (abbreviation.Contains("Standard") || abbreviation.Contains("Daylight"))
        {
            var words = abbreviation.Split(' ');
            if (words.Length > 1)
            {
                abbreviation = string.Join("", words.Select(w => char.IsLetter(w.FirstOrDefault()) ? w.First() : ' ')).Trim();
            }
        }

        // If abbreviation is still long, use UTC offset instead
        if (abbreviation.Length > 5)
        {
            abbreviation = $"UTC{tz.BaseUtcOffset:hh\\:mm}";
        }

        return abbreviation;
    }
}
