@page "/profile"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Tempus.Core.Models
@attribute [Authorize]
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NotificationService NotificationService
@inject Tempus.Core.Interfaces.ITimeZoneConversionService TimeZoneConversionService

<PageTitle>Profile - Tempus</PageTitle>

<div style="padding: 2rem;">
    <RadzenStack Gap="2rem">
        <!-- Header -->
        <RadzenCard Style="background: var(--hero-gradient); color: white; border-radius: 16px; padding: 2rem; box-shadow: var(--shadow-lg);">
            <RadzenStack Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.H3" Style="font-weight: 700; margin: 0;">üë§ My Profile</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" Style="opacity: 0.9;">
                    Manage your account information and preferences.
                </RadzenText>
            </RadzenStack>
        </RadzenCard>

        @if (_user != null)
        {
            <!-- Profile Card -->
            <RadzenCard>
                <RadzenStack Gap="2rem">
                    <!-- Avatar and Basic Info -->
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="2rem">
                        <div class="profile-avatar">
                            <span class="avatar-initials">@_initials</span>
                        </div>
                        <RadzenStack Gap="0.25rem">
                            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">@GetFullName()</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0; opacity: 0.7;">@_user.Email</RadzenText>
                        </RadzenStack>
                    </RadzenStack>

                    <RadzenStack Style="height: 1px; opacity: 0.2; background: currentColor;"></RadzenStack>

                    <!-- Profile Form -->
                    <RadzenStack Gap="1.5rem">
                        <RadzenText TextStyle="TextStyle.H5" Style="font-weight: 700;">üìù Account Information</RadzenText>

                        <RadzenRow Gap="1.5rem">
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="First Name" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenTextBox @bind-Value="_user.FirstName"
                                                   Placeholder="Enter your first name"
                                                   Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Last Name" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenTextBox @bind-Value="_user.LastName"
                                                   Placeholder="Enter your last name"
                                                   Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Email Address" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenTextBox Value="@_user.Email"
                                                   Disabled="true"
                                                   Style="width: 100%;" />
                                </RadzenFormField>
                                <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.7; margin-top: 0.5rem;">
                                    Email cannot be changed at this time
                                </RadzenText>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Phone Number (Optional)" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenTextBox @bind-Value="_user.PhoneNumber"
                                                   Placeholder="Enter your phone number"
                                                   Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Date of Birth (Optional)" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenDatePicker @bind-Value="_user.DateOfBirth"
                                                      DateFormat="MM/dd/yyyy"
                                                      Placeholder="Select your date of birth"
                                                      ShowTime="false"
                                                      Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Time Zone" Variant="Variant.Outlined" Style="width: 100%;">
                                    <ChildContent>
                                        <RadzenDropDown @bind-Value="_user.TimeZone"
                                                        Data="@_timeZones"
                                                        TextProperty="DisplayName"
                                                        ValueProperty="Id"
                                                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                                        AllowFiltering="true"
                                                        Placeholder="Select your timezone"
                                                        Style="width: 100%;" />
                                    </ChildContent>
                                    <Helper>
                                        <RadzenText TextStyle="TextStyle.Caption" Style="color: #718096;">
                                            Your timezone is used for all events you create and for displaying shared events.
                                        </RadzenText>
                                    </Helper>
                                </RadzenFormField>
                            </RadzenColumn>

                            <RadzenColumn Size="12">
                                <RadzenFormField Text="Address (Optional)" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenTextBox @bind-Value="_user.Address"
                                                   Placeholder="Enter your street address"
                                                   Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="City (Optional)" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenTextBox @bind-Value="_user.City"
                                                   Placeholder="Enter your city"
                                                   Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="State/Province (Optional)" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenTextBox @bind-Value="_user.State"
                                                   Placeholder="Enter your state or province"
                                                   Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Zip/Postal Code (Optional)" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenTextBox @bind-Value="_user.ZipCode"
                                                   Placeholder="Enter your zip or postal code"
                                                   Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Country (Optional)" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenTextBox @bind-Value="_user.Country"
                                                   Placeholder="Enter your country"
                                                   Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>
                        </RadzenRow>

                        <!-- Save Profile Button -->
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.End">
                            <RadzenButton Text="Save Profile"
                                          Icon="save"
                                          ButtonStyle="ButtonStyle.Primary"
                                          Click="@SaveProfile"
                                          Style="padding: 0.75rem 2rem; border-radius: 10px;" />
                        </RadzenStack>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>

            <!-- Change Password Card -->
            <RadzenCard>
                <RadzenStack Gap="1.5rem">
                    <RadzenText TextStyle="TextStyle.H5" Style="font-weight: 700;">üîí Change Password</RadzenText>

                    <RadzenRow Gap="1.5rem">
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Current Password" Variant="Variant.Outlined" Style="width: 100%;">
                                <RadzenPassword @bind-Value="_currentPassword"
                                                Placeholder="Enter current password"
                                                Style="width: 100%;" />
                            </RadzenFormField>
                        </RadzenColumn>

                        <RadzenColumn Size="12" SizeMD="6">
                            <!-- Spacer for layout -->
                        </RadzenColumn>

                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="New Password" Variant="Variant.Outlined" Style="width: 100%;">
                                <RadzenPassword @bind-Value="_newPassword"
                                                Placeholder="Enter new password"
                                                Style="width: 100%;" />
                            </RadzenFormField>
                        </RadzenColumn>

                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Confirm New Password" Variant="Variant.Outlined" Style="width: 100%;">
                                <RadzenPassword @bind-Value="_confirmPassword"
                                                Placeholder="Confirm new password"
                                                Style="width: 100%;" />
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>

                    <!-- Change Password Button -->
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.End">
                        <RadzenButton Text="Change Password"
                                      Icon="lock"
                                      ButtonStyle="ButtonStyle.Primary"
                                      Click="@ChangePassword"
                                      Style="padding: 0.75rem 2rem; border-radius: 10px;" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>

            <!-- Account Statistics Card -->
            <RadzenCard>
                <RadzenStack Gap="1.5rem">
                    <RadzenText TextStyle="TextStyle.H5" Style="font-weight: 700;">üìä Account Statistics</RadzenText>

                    <RadzenRow Gap="1.5rem">
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenStack Gap="0.5rem">
                                <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.7;">Member Since</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body1" Style="font-weight: 600;">
                                    @_user.CreatedAt.ToString("MMMM dd, yyyy")
                                </RadzenText>
                            </RadzenStack>
                        </RadzenColumn>

                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenStack Gap="0.5rem">
                                <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.7;">Email Confirmed</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body1" Style="font-weight: 600;">
                                    @(_user.EmailConfirmed ? "Yes" : "No")
                                </RadzenText>
                            </RadzenStack>
                        </RadzenColumn>

                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenStack Gap="0.5rem">
                                <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.7;">Two-Factor Authentication</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body1" Style="font-weight: 600;">
                                    @(_user.TwoFactorEnabled ? "Enabled" : "Disabled")
                                </RadzenText>
                            </RadzenStack>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenStack>
            </RadzenCard>
        }
        else
        {
            <RadzenCard Style="padding: 3rem; text-align: center;">
                <RadzenStack Gap="1rem" AlignItems="AlignItems.Center">
                    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                    <RadzenText Style="opacity: 0.7;">Loading profile...</RadzenText>
                </RadzenStack>
            </RadzenCard>
        }
    </RadzenStack>
</div>

<style>
    /* Profile Page Styling - Theme-aware */
    .rz-card {
        transition: box-shadow 0.3s ease;
    }

    .rz-card:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .profile-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--primary-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
        transition: transform 0.3s ease;
    }

    .profile-avatar:hover {
        transform: scale(1.05);
    }

    /* Scope avatar initials to only profile page - don't affect menubar */
    .profile-avatar .avatar-initials {
        color: white;
        font-size: 2rem;
        font-weight: 700;
        text-transform: uppercase;
    }
</style>

@code {
    private ApplicationUser? _user;
    private string _initials = "U";
    private List<TimeZoneInfo> _timeZones = new();

    private string _currentPassword = "";
    private string _newPassword = "";
    private string _confirmPassword = "";

    protected override async Task OnInitializedAsync()
    {
        // Load common timezones for dropdown
        _timeZones = TimeZoneConversionService.GetCommonTimeZones();

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userPrincipal = authState.User;

        if (userPrincipal?.Identity?.IsAuthenticated == true)
        {
            _user = await UserManager.GetUserAsync(userPrincipal);

            if (_user != null)
            {
                // Generate initials from FirstName and LastName
                _initials = GenerateInitials();
            }
        }
    }

    private string GetFullName()
    {
        if (_user == null)
            return "User";

        var firstName = _user.FirstName?.Trim() ?? "";
        var lastName = _user.LastName?.Trim() ?? "";

        if (string.IsNullOrEmpty(firstName) && string.IsNullOrEmpty(lastName))
            return _user.Email?.Split('@')[0] ?? "User";

        return $"{firstName} {lastName}".Trim();
    }

    private string GenerateInitials()
    {
        if (_user == null)
            return "U";

        var firstName = _user.FirstName?.Trim() ?? "";
        var lastName = _user.LastName?.Trim() ?? "";

        if (string.IsNullOrEmpty(firstName) && string.IsNullOrEmpty(lastName))
        {
            var email = _user.Email?.Split('@')[0] ?? "U";
            return email.Substring(0, Math.Min(2, email.Length)).ToUpper();
        }

        if (string.IsNullOrEmpty(lastName))
            return firstName.Substring(0, Math.Min(2, firstName.Length)).ToUpper();

        if (string.IsNullOrEmpty(firstName))
            return lastName.Substring(0, Math.Min(2, lastName.Length)).ToUpper();

        return $"{firstName[0]}{lastName[0]}".ToUpper();
    }

    private async Task SaveProfile()
    {
        if (_user == null) return;

        try
        {
            // Note: UserName is typically the email in ASP.NET Core Identity
            // You would need to add a custom field for display name if you want to store it separately

            var result = await UserManager.UpdateAsync(_user);

            if (result.Succeeded)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Profile Updated",
                    Detail = "Your profile has been updated successfully.",
                    Duration = 4000
                });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Update Failed",
                    Detail = "Failed to update profile. " + string.Join(", ", result.Errors.Select(e => e.Description)),
                    Duration = 6000
                });
            }
        }
        catch (Exception)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = "An error occurred while updating your profile.",
                Duration = 4000
            });
        }
    }

    private async Task ChangePassword()
    {
        if (_user == null) return;

        if (string.IsNullOrWhiteSpace(_currentPassword) || string.IsNullOrWhiteSpace(_newPassword))
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = "Validation Error",
                Detail = "Please fill in all password fields.",
                Duration = 4000
            });
            return;
        }

        if (_newPassword != _confirmPassword)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = "Validation Error",
                Detail = "New password and confirmation do not match.",
                Duration = 4000
            });
            return;
        }

        try
        {
            var result = await UserManager.ChangePasswordAsync(_user, _currentPassword, _newPassword);

            if (result.Succeeded)
            {
                // Clear password fields
                _currentPassword = "";
                _newPassword = "";
                _confirmPassword = "";

                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Password Changed",
                    Detail = "Your password has been changed successfully.",
                    Duration = 4000
                });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Password Change Failed",
                    Detail = string.Join(", ", result.Errors.Select(e => e.Description)),
                    Duration = 6000
                });
            }
        }
        catch (Exception)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = "An error occurred while changing your password.",
                Duration = 4000
            });
        }
    }
}
