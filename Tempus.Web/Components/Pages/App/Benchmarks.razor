@* DEPRECATED: This page has been merged into Insights.razor - route is handled by BenchmarksRedirect.razor *@
@* @page "/benchmarks" *@
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Tempus.Core.Interfaces
@using Tempus.Core.Models
@attribute [Authorize]
@inject IBenchmarkService BenchmarkService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject Tempus.Web.Components.Account.IdentityUserAccessor IdentityUserAccessor
@inject ILogger<Benchmarks> Logger

<PageTitle>Benchmarks - Tempus</PageTitle>

<style>
    .benchmark-score-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        margin-bottom: 2rem;
    }

    .benchmark-metric-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border-radius: 12px;
    }

    .benchmark-metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .status-excellent {
        color: #4CAF50;
        background: rgba(76, 175, 80, 0.1);
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-weight: 600;
    }

    .status-at-standard {
        color: #2196F3;
        background: rgba(33, 150, 243, 0.1);
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-weight: 600;
    }

    .status-near-standard {
        color: #FF9800;
        background: rgba(255, 152, 0, 0.1);
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-weight: 600;
    }

    .status-below-standard {
        color: #F44336;
        background: rgba(244, 67, 54, 0.1);
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-weight: 600;
    }

    .recommendation-box {
        background: linear-gradient(135deg, #FFF9C4 0%, #FFEB3B 100%);
        border-left: 4px solid #FBC02D;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
    }
</style>

@if (_loading)
{
    <div style="display: flex; justify-content: center; align-items: center; min-height: 400px;">
        <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
    </div>
}
else if (_report != null)
{
    <!-- Header Card -->
    <div class="benchmark-score-card">
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center" Gap="1rem" Wrap="FlexWrap.Wrap">
            <div>
                <RadzenText TextStyle="TextStyle.DisplayH4" Style="font-weight: 800; margin: 0 0 0.5rem 0;">ðŸ“Š Industry Benchmarks</RadzenText>
                <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin: 0;">Compare your time management against industry standards</RadzenText>
            </div>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                <RadzenButton Icon="refresh" Text="Refresh" Click="@LoadBenchmarkData" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Medium" />
                <RadzenDropDown TValue="int" @bind-Value="@_selectedPeriod" Data="@_periodOptions" TextProperty="Text" ValueProperty="Value"
                              Change="@OnPeriodChanged" Style="width: 120px;" />
            </RadzenStack>
        </RadzenStack>
    </div>

    <!-- Overall Score -->
    <RadzenCard Style="margin-bottom: 2rem;">
        <RadzenStack Gap="1.5rem">
            <RadzenText TextStyle="TextStyle.H5" Style="font-weight: 700;">Overall Performance Score</RadzenText>

            <RadzenRow>
                <RadzenColumn Size="12" SizeMD="4">
                    <div style="text-align: center;">
                        <RadzenArcGauge Style="width: 200px; height: 200px; margin: 0 auto;">
                            <RadzenArcGaugeScale Min="0" Max="100" Y="0.8">
                                <RadzenArcGaugeScaleValue Value="@_report.OverallScore" Fill="@GetScoreColor(_report.OverallScore)" />
                            </RadzenArcGaugeScale>
                        </RadzenArcGauge>
                        <RadzenText TextStyle="TextStyle.H4" Style="margin-top: 1rem;">@_report.OverallScore.ToString("F0") / 100</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body1" Style="color: #666;">@GetScoreLabel(_report.OverallScore)</RadzenText>
                    </div>
                </RadzenColumn>

                <RadzenColumn Size="12" SizeMD="8">
                    <RadzenStack Gap="1rem">
                        <RadzenRow>
                            <RadzenColumn Size="4">
                                <div style="text-align: center; padding: 1rem; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                                    <RadzenText TextStyle="TextStyle.H4" Style="color: #4CAF50; margin: 0;">@_report.MetricsAboveStandard</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="color: #666; margin: 0;">Excellent</RadzenText>
                                </div>
                            </RadzenColumn>
                            <RadzenColumn Size="4">
                                <div style="text-align: center; padding: 1rem; background: rgba(33, 150, 243, 0.1); border-radius: 8px;">
                                    <RadzenText TextStyle="TextStyle.H4" Style="color: #2196F3; margin: 0;">@_report.MetricsAtStandard</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="color: #666; margin: 0;">At Standard</RadzenText>
                                </div>
                            </RadzenColumn>
                            <RadzenColumn Size="4">
                                <div style="text-align: center; padding: 1rem; background: rgba(244, 67, 54, 0.1); border-radius: 8px;">
                                    <RadzenText TextStyle="TextStyle.H4" Style="color: #F44336; margin: 0;">@_report.MetricsBelowStandard</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="color: #666; margin: 0;">Needs Attention</RadzenText>
                                </div>
                            </RadzenColumn>
                        </RadzenRow>

                        @if (_report.TopRecommendations.Any())
                        {
                            <div class="recommendation-box">
                                <RadzenStack Gap="0.5rem">
                                    <RadzenText TextStyle="TextStyle.Subtitle2" Style="font-weight: 700; margin: 0;">ðŸ’¡ Top Recommendations</RadzenText>
                                    @foreach (var recommendation in _report.TopRecommendations)
                                    {
                                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">â€¢ @recommendation</RadzenText>
                                    }
                                </RadzenStack>
                            </div>
                        }
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>
        </RadzenStack>
    </RadzenCard>

    <!-- Benchmark Categories -->
    @foreach (var category in _report.Comparisons.GroupBy(c => c.Category))
    {
        <RadzenCard Style="margin-bottom: 2rem;">
            <RadzenStack Gap="1rem">
                <RadzenText TextStyle="TextStyle.H5" Style="font-weight: 700;">@category.Key</RadzenText>

                @foreach (var comparison in category)
                {
                    <div class="benchmark-metric-card" style="border: 1px solid #e0e0e0; padding: 1.5rem; border-radius: 8px;">
                        <RadzenStack Gap="0.75rem">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                    <RadzenIcon Icon="@comparison.Icon" Style="font-size: 1.5rem; color: #667eea;" />
                                    <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-weight: 600; margin: 0;">@comparison.MetricName</RadzenText>
                                </RadzenStack>
                                <span class="@GetStatusClass(comparison.Status)">@GetStatusText(comparison.Status)</span>
                            </RadzenStack>

                            <RadzenRow Gap="1rem">
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenStack Gap="0.25rem">
                                        <RadzenText TextStyle="TextStyle.Caption" Style="color: #666; margin: 0;">Your Value</RadzenText>
                                        <RadzenText TextStyle="TextStyle.H6" Style="color: #667eea; margin: 0;">@FormatValue(comparison.ActualValue, comparison.MetricName)</RadzenText>
                                    </RadzenStack>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenStack Gap="0.25rem">
                                        <RadzenText TextStyle="TextStyle.Caption" Style="color: #666; margin: 0;">Industry Standard</RadzenText>
                                        <RadzenText TextStyle="TextStyle.H6" Style="color: #333; margin: 0;">@FormatValue(comparison.BenchmarkValue, comparison.MetricName)</RadzenText>
                                    </RadzenStack>
                                </RadzenColumn>
                            </RadzenRow>

                            <RadzenProgressBar Value="@GetProgressPercentage(comparison)" ShowValue="false"
                                             ProgressBarStyle="@GetProgressBarStyle(comparison.Status)" Style="height: 8px;" />

                            <RadzenText TextStyle="TextStyle.Body2" Style="color: #666; margin: 0;">@comparison.Description</RadzenText>

                            @if (!string.IsNullOrEmpty(comparison.Recommendation))
                            {
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Style="background: #f5f5f5; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem;">
                                    <RadzenIcon Icon="lightbulb" Style="color: #FBC02D; font-size: 1.25rem;" />
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; flex: 1;">@comparison.Recommendation</RadzenText>
                                </RadzenStack>
                            }
                        </RadzenStack>
                    </div>
                }
            </RadzenStack>
        </RadzenCard>
    }
}

@code {
    private bool _loading = true;
    private BenchmarkReport? _report;
    private string _userId = string.Empty;
    private int _selectedPeriod = 30;

    private List<PeriodOption> _periodOptions = new()
    {
        new PeriodOption { Text = "7 Days", Value = 7 },
        new PeriodOption { Text = "30 Days", Value = 30 },
        new PeriodOption { Text = "90 Days", Value = 90 }
    };

    public class PeriodOption
    {
        public string Text { get; set; } = string.Empty;
        public int Value { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var appUser = await IdentityUserAccessor.GetUserAsync(user);
            if (appUser != null)
            {
                _userId = appUser.Id;
                await LoadBenchmarkData();
            }
        }
    }

    private async Task LoadBenchmarkData()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            _report = await BenchmarkService.GenerateBenchmarkReportAsync(_userId, _selectedPeriod);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading benchmark data");
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task OnPeriodChanged()
    {
        await LoadBenchmarkData();
    }

    private string GetStatusClass(BenchmarkStatus status)
    {
        return status switch
        {
            BenchmarkStatus.Excellent => "status-excellent",
            BenchmarkStatus.AtStandard => "status-at-standard",
            BenchmarkStatus.NearStandard => "status-near-standard",
            BenchmarkStatus.BelowStandard => "status-below-standard",
            _ => "status-at-standard"
        };
    }

    private string GetStatusText(BenchmarkStatus status)
    {
        return status switch
        {
            BenchmarkStatus.Excellent => "Excellent",
            BenchmarkStatus.AtStandard => "At Standard",
            BenchmarkStatus.NearStandard => "Near Standard",
            BenchmarkStatus.BelowStandard => "Below Standard",
            _ => "At Standard"
        };
    }

    private ProgressBarStyle GetProgressBarStyle(BenchmarkStatus status)
    {
        return status switch
        {
            BenchmarkStatus.Excellent => ProgressBarStyle.Success,
            BenchmarkStatus.AtStandard => ProgressBarStyle.Info,
            BenchmarkStatus.NearStandard => ProgressBarStyle.Warning,
            BenchmarkStatus.BelowStandard => ProgressBarStyle.Danger,
            _ => ProgressBarStyle.Info
        };
    }

    private double GetProgressPercentage(BenchmarkComparison comparison)
    {
        var percentage = comparison.BenchmarkValue > 0
            ? (comparison.ActualValue / comparison.BenchmarkValue) * 100
            : 100;

        return Math.Min(Math.Max(percentage, 0), 100);
    }

    private string FormatValue(double value, string metricName)
    {
        if (metricName.Contains("Percentage") || metricName.Contains("Rate"))
            return $"{value:F1}%";
        if (metricName.Contains("Duration") || metricName.Contains("Minutes") || metricName.Contains("Block"))
            return $"{value:F0} min";
        if (metricName.Contains("Hours"))
            return $"{value:F1} hrs";
        if (metricName.Contains("Attendees") || metricName.Contains("Size"))
            return $"{value:F0} people";
        if (metricName.Contains("Fragmentation") || metricName.Contains("Score"))
            return $"{value:F1}";

        return $"{value:F1}";
    }

    private string GetScoreColor(double score)
    {
        if (score >= 85) return "#4CAF50";  // Green - Excellent
        if (score >= 70) return "#2196F3";  // Blue - Good
        if (score >= 60) return "#FF9800";  // Orange - Fair
        return "#F44336";  // Red - Needs Improvement
    }

    private string GetScoreLabel(double score)
    {
        if (score >= 85) return "Excellent Performance";
        if (score >= 70) return "Good Performance";
        if (score >= 60) return "Fair Performance";
        return "Needs Improvement";
    }
}
