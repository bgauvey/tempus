@page "/import"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Tempus.Core.Interfaces
@using Tempus.Core.Models
@using Tempus.Web.Components.Account
@using Tempus.Web.Components.Shared
@attribute [Authorize]
@inject IIcsImportService IcsImportService
@inject IPstImportService PstImportService
@inject IEventRepository EventRepository
@inject ISettingsService SettingsService
@inject NotificationService NotificationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IdentityUserAccessor IdentityUserAccessor
@inject ILogger<Import> Logger

<PageTitle>Import Calendar - Tempus</PageTitle>

<SecondaryNav Items="@_navItems" />

<RadzenText TextStyle="TextStyle.H3" class="rz-mb-2">Import Calendar File</RadzenText>
<RadzenText class="rz-mb-4">Upload an ICS or PST calendar file to import events into Tempus</RadzenText>

<RadzenRow Gap="1rem">
    <RadzenColumn Size="12" SizeMD="8">
        <RadzenCard>
            <RadzenStack Gap="1rem">
                <div style="border: 2px dashed var(--rz-border-color); border-radius: 4px; padding: 3rem; text-align: center; min-height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <InputFile OnChange="HandleFileSelected" accept=".ics,.pst" id="fileUpload" style="display: none;" />
                    <label for="fileUpload" style="cursor: pointer; display: flex; flex-direction: column; align-items: center;">
                        <RadzenIcon Icon="cloud_upload" IconStyle="IconStyle.Primary" Style="font-size: 3rem; margin-bottom: 1rem;" />
                        <RadzenText TextStyle="TextStyle.H6" class="rz-mt-2">Click to upload calendar file</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">ICS or PST format</RadzenText>
                    </label>
                </div>

                @if (_selectedFile != null)
                {
                    <RadzenCard Variant="Variant.Outlined" class="rz-mt-2">
                        <RadzenText TextStyle="TextStyle.Body1">Selected file: <strong>@_selectedFile.Name</strong></RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">
                            Size: @FormatFileSize(_selectedFile.Size) | Type: @GetFileType(_selectedFile.Name)
                        </RadzenText>
                    </RadzenCard>

                    <RadzenButton ButtonStyle="ButtonStyle.Primary"
                                Style="width: 100%;"
                                Click="ImportFile"
                                Disabled="@_importing">
                        @if (_importing)
                        {
                            <RadzenProgressBarCircular class="rz-mr-2" ProgressBarStyle="ProgressBarStyle.Light" Mode="ProgressBarMode.Indeterminate"
                                                     Style="width: 20px; height: 20px;" />
                            <span>Importing...</span>
                        }
                        else
                        {
                            <span>Import Events</span>
                        }
                    </RadzenButton>
                }
            </RadzenStack>
        </RadzenCard>

        @if (_importedEvents.Any())
        {
            <RadzenCard class="rz-mt-4">
                <RadzenStack Gap="1rem">
                    <RadzenText TextStyle="TextStyle.H6">Import Preview</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-2">
                        <strong>@_importedEvents.Count</strong> events ready to import
                    </RadzenText>
                    <RadzenStack Gap="0.5rem">
                        @foreach (var evt in _importedEvents.Take(10))
                        {
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                <RadzenIcon Icon="event" />
                                <RadzenText TextStyle="TextStyle.Body2">
                                    <strong>@evt.Title</strong> - @evt.StartTime.ToString(DateTimeFormatString)
                                </RadzenText>
                            </RadzenStack>
                        }
                    </RadzenStack>
                    @if (_importedEvents.Count > 10)
                    {
                        <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);" class="rz-mt-2">
                            ...and @(_importedEvents.Count - 10) more events
                        </RadzenText>
                    }

                    <RadzenButton ButtonStyle="ButtonStyle.Success"
                                Style="width: 100%;"
                                Click="SaveImportedEvents"
                                Disabled="@_saving">
                        @if (_saving)
                        {
                            <RadzenProgressBarCircular class="rz-mr-2" ProgressBarStyle="ProgressBarStyle.Light" Mode="ProgressBarMode.Indeterminate"
                                                     Style="width: 20px; height: 20px;" />
                            <span>Saving...</span>
                        }
                        else
                        {
                            <span>Save All Events</span>
                        }
                    </RadzenButton>
                </RadzenStack>
            </RadzenCard>
        }
    </RadzenColumn>

    <RadzenColumn Size="12" SizeMD="4">
        <RadzenCard>
            <RadzenStack Gap="1rem">
                <RadzenText TextStyle="TextStyle.H6">Supported Formats</RadzenText>

                <div>
                    <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-1" Style="font-weight: 600;">ICS (iCalendar)</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-2">
                        Universal calendar format supported by:
                    </RadzenText>
                    <RadzenStack Gap="0.5rem">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                            <RadzenIcon Icon="check" Style="color: #43e97b;" />
                            <RadzenText>Google Calendar</RadzenText>
                        </RadzenStack>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                            <RadzenIcon Icon="check" Style="color: #43e97b;" />
                            <RadzenText>Microsoft Outlook</RadzenText>
                        </RadzenStack>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                            <RadzenIcon Icon="check" Style="color: #43e97b;" />
                            <RadzenText>Apple Calendar</RadzenText>
                        </RadzenStack>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                            <RadzenIcon Icon="check" Style="color: #43e97b;" />
                            <RadzenText>Mozilla Thunderbird</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </div>

                <div style="height: 1px; background: #e2e8f0; margin: 1rem 0;"></div>

                <div>
                    <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-1" Style="font-weight: 600;">PST (Outlook Personal Storage)</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-2">
                        Microsoft Outlook's native format containing:
                    </RadzenText>
                    <RadzenStack Gap="0.5rem">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                            <RadzenIcon Icon="check" Style="color: #667eea;" />
                            <RadzenText>Calendar Events</RadzenText>
                        </RadzenStack>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                            <RadzenIcon Icon="check" Style="color: #667eea;" />
                            <RadzenText>Appointments</RadzenText>
                        </RadzenStack>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                            <RadzenIcon Icon="check" Style="color: #667eea;" />
                            <RadzenText>Meeting Invites</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </div>

                <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter" class="rz-mt-3">
                    <RadzenText TextStyle="TextStyle.Caption">
                        Export your calendar and upload it here to migrate to Tempus.
                    </RadzenText>
                </RadzenAlert>
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

@code {
    private List<SecondaryNav.SecondaryNavItem> _navItems = new()
    {
        new() { Text = "General", Path = "/settings", Icon = "tune" },
        new() { Text = "Calendar Sources", Path = "/calendar-sources", Icon = "event" },
        new() { Text = "Integrations", Path = "/integrations", Icon = "sync" },
        new() { Text = "Import/Export", Path = "/import", Icon = "upload" },
        new() { Text = "Availability", Path = "/out-of-office", Icon = "beach_access" },
        new() { Text = "Working Location", Path = "/working-location", Icon = "location_on" }
    };

    private IBrowserFile? _selectedFile;
    private bool _importing;
    private bool _saving;
    private List<Event> _importedEvents = new();
    private string _userId = string.Empty;
    private CalendarSettings? _settings;

    private string DateTimeFormatString => _settings?.TimeFormat == Core.Enums.TimeFormat.TwentyFourHour
        ? "MMM dd, yyyy HH:mm"
        : "MMM dd, yyyy hh:mm tt";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            var appUser = await IdentityUserAccessor.GetUserAsync(user);
            if (appUser != null)
            {
                _userId = appUser.Id;
                // Load user's calendar settings for time format preference
                _settings = await SettingsService.GetOrCreateDefaultSettingsAsync(_userId);
            }
        }
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
        _importedEvents.Clear();
    }

    private async Task ImportFile()
    {
        if (_selectedFile == null) return;

        _importing = true;
        try
        {
            var fileType = GetFileType(_selectedFile.Name);
            var maxFileSize = fileType == "PST" ? 100 * 1024 * 1024 : 10 * 1024 * 1024; // 100MB for PST, 10MB for ICS

            using var stream = _selectedFile.OpenReadStream(maxAllowedSize: maxFileSize);

            // Route to appropriate parser based on file type
            if (fileType == "PST")
            {
                _importedEvents = await PstImportService.ImportFromStreamAsync(stream);
            }
            else if (fileType == "ICS")
            {
                _importedEvents = await IcsImportService.ImportFromStreamAsync(stream);
            }
            else
            {
                throw new InvalidOperationException("Unsupported file type. Please upload an ICS or PST file.");
            }

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Success",
                Detail = $"Successfully parsed {_importedEvents.Count} events from {fileType} file",
                Duration = 4000
            });
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Error importing file: {ex.Message}",
                Duration = 4000
            });
        }
        finally
        {
            _importing = false;
        }
    }

    private async Task SaveImportedEvents()
    {
        _saving = true;
        Logger.LogInformation("=== STARTING SAVE IMPORTED EVENTS ===");
        Logger.LogInformation("Total events to save: {EventCount}", _importedEvents.Count);
        Logger.LogInformation("Current user ID: {UserId}", _userId);

        // Log date range of events being imported
        if (_importedEvents.Any())
        {
            var minDate = _importedEvents.Min(e => e.StartTime);
            var maxDate = _importedEvents.Max(e => e.StartTime);
            Logger.LogInformation("Event date range: {MinDate:yyyy-MM-dd} to {MaxDate:yyyy-MM-dd}", minDate, maxDate);
        }

        try
        {
            int savedCount = 0;
            int eventIndex = 0;

            foreach (var evt in _importedEvents)
            {
                eventIndex++;
                Logger.LogDebug("--- Processing event {EventIndex}/{TotalEvents} ---", eventIndex, _importedEvents.Count);
                Logger.LogDebug("Event ID: {EventId}", evt.Id);
                Logger.LogDebug("Title: {Title}", evt.Title);
                Logger.LogDebug("StartTime: {StartTime}", evt.StartTime);
                Logger.LogDebug("EndTime: {EndTime}", evt.EndTime);
                Logger.LogDebug("UserId (before): {UserId}", evt.UserId);
                Logger.LogDebug("Attendees count: {AttendeeCount}", evt.Attendees?.Count ?? 0);

                try
                {
                    evt.UserId = _userId; // Set the current user ID before saving
                    Logger.LogDebug("UserId (after set): {UserId}", evt.UserId);

                    if (evt.Attendees != null && evt.Attendees.Any())
                    {
                        Logger.LogDebug("Attendee details:");
                        foreach (var attendee in evt.Attendees)
                        {
                            Logger.LogDebug("  - Attendee ID: {AttendeeId}, Name: {Name}, Email: {Email}, EventId: {EventId}", attendee.Id, attendee.Name, attendee.Email, attendee.EventId);
                        }
                    }

                    Logger.LogDebug("Calling EventRepository.CreateAsync...");
                    var result = await EventRepository.CreateAsync(evt);
                    Logger.LogDebug("CreateAsync returned. Result ID: {EventId}", result.Id);

                    savedCount++;
                    Logger.LogDebug("✓ Event saved successfully. Total saved so far: {SavedCount}", savedCount);
                }
                catch (Exception eventEx)
                {
                    // Log individual event errors but continue
                    Logger.LogError(eventEx, "✗ ERROR saving event '{Title}'", evt.Title);
                }
            }

            Logger.LogInformation("=== SAVE COMPLETE ===");
            Logger.LogInformation("Total saved: {SavedCount} of {TotalCount}", savedCount, _importedEvents.Count);

            // Verify events are in database
            Logger.LogInformation("=== VERIFYING DATABASE ===");
            try
            {
                var allUserEvents = await EventRepository.GetAllAsync(_userId);
                Logger.LogInformation("Total events in database for user: {EventCount}", allUserEvents.Count);

                if (allUserEvents.Any())
                {
                    var dbMinDate = allUserEvents.Min(e => e.StartTime);
                    var dbMaxDate = allUserEvents.Max(e => e.StartTime);
                    Logger.LogInformation("Database event date range: {MinDate:yyyy-MM-dd} to {MaxDate:yyyy-MM-dd}", dbMinDate, dbMaxDate);

                    // Show a few sample events
                    Logger.LogDebug("Sample events from database:");
                    foreach (var evt in allUserEvents.Take(5))
                    {
                        Logger.LogDebug("  - {Title}: {StartTime:yyyy-MM-dd HH:mm} to {EndTime:yyyy-MM-dd HH:mm}", evt.Title, evt.StartTime, evt.EndTime);
                    }
                }
            }
            catch (Exception verifyEx)
            {
                Logger.LogError(verifyEx, "Error verifying database");
            }
            Logger.LogInformation("=== VERIFICATION COMPLETE ===");

            if (savedCount > 0)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Success",
                    Detail = $"Successfully imported {savedCount} of {_importedEvents.Count} events",
                    Duration = 4000
                });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Warning",
                    Detail = "No events were saved. Check console for details.",
                    Duration = 4000
                });
            }

            _importedEvents.Clear();
            _selectedFile = null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "✗ CRITICAL ERROR in SaveImportedEvents");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Error saving events: {ex.Message}",
                Duration = 4000
            });
        }
        finally
        {
            _saving = false;
            Logger.LogInformation("=== SaveImportedEvents FINISHED ===");
        }
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private string GetFileType(string fileName)
    {
        var extension = Path.GetExtension(fileName)?.ToLower();
        return extension switch
        {
            ".ics" => "ICS",
            ".pst" => "PST",
            _ => "Unknown"
        };
    }
}
