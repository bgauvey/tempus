@page "/integrations"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Tempus.Core.Interfaces
@using Tempus.Core.Models
@using Tempus.Web.Components.Dialogs
@using System.Security.Claims
@attribute [Authorize]
@inject IGoogleCalendarService GoogleCalendarService
@inject IAppleCalendarService AppleCalendarService
@inject IOutlookCalendarService OutlookCalendarService
@inject ICalendarIntegrationRepository IntegrationRepository
@inject IBookingPageRepository BookingPageRepository
@inject IBookingPageService BookingPageService
@inject ICalendarRepository CalendarRepository
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject ILogger<Integrations> Logger

<PageTitle>Integrations & Booking - Tempus</PageTitle>

<RadzenText TextStyle="TextStyle.H3" class="rz-mb-2">Calendar Integrations</RadzenText>
<RadzenText class="rz-mb-4">Connect your existing calendars to sync events with Tempus</RadzenText>

<RadzenRow Gap="1rem">
    <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
        <RadzenCard>
            <RadzenStack Gap="1rem">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenIcon Icon="cloud" Style="font-size: 2rem;" />
                    <RadzenText TextStyle="TextStyle.H6">Google Calendar</RadzenText>
                    @if (_googleIntegration != null && _googleIntegration.IsEnabled)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Connected" />
                    }
                </RadzenStack>
                <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-2">
                    Sync your Google Calendar events with Tempus. Two-way synchronization keeps everything up to date.
                </RadzenText>

                @if (_googleIntegration != null && _googleIntegration.IsEnabled)
                {
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Caption">
                            <strong>Calendar:</strong> @_googleIntegration.CalendarName
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption">
                            <strong>Last synced:</strong> @(_googleIntegration.LastSyncedAt?.ToLocalTime().ToString("g") ?? "Never")
                        </RadzenText>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" class="rz-mt-2">
                            <RadzenButton ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Icon="sync" Text="Sync Now" Click="@SyncGoogleCalendar" Disabled="_isSyncing" />
                            <RadzenButton ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Icon="link_off" Text="Disconnect" Click="@DisconnectGoogleCalendar" />
                        </RadzenStack>
                        @if (_isSyncing)
                        {
                            <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                        }
                    </RadzenStack>
                }
                else
                {
                    <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="link" Text="Connect Google Calendar" Click="@ConnectGoogleCalendar" />
                }
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
        <RadzenCard>
            <RadzenStack Gap="1rem">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenIcon Icon="mail" Style="font-size: 2rem;" />
                    <RadzenText TextStyle="TextStyle.H6">Microsoft Outlook</RadzenText>
                    @if (_outlookIntegration != null && _outlookIntegration.IsEnabled)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Connected" />
                    }
                </RadzenStack>
                <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-2">
                    Connect your Outlook or Office 365 calendar for seamless event synchronization.
                </RadzenText>

                @if (_outlookIntegration != null && _outlookIntegration.IsEnabled)
                {
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Caption">
                            <strong>Calendar:</strong> @_outlookIntegration.CalendarName
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption">
                            <strong>Last synced:</strong> @(_outlookIntegration.LastSyncedAt?.ToLocalTime().ToString("g") ?? "Never")
                        </RadzenText>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" class="rz-mt-2">
                            <RadzenButton ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Icon="sync" Text="Sync Now" Click="@SyncOutlookCalendar" Disabled="_isSyncingOutlook" />
                            <RadzenButton ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Icon="link_off" Text="Disconnect" Click="@DisconnectOutlookCalendar" />
                        </RadzenStack>
                        @if (_isSyncingOutlook)
                        {
                            <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                        }
                    </RadzenStack>
                }
                else
                {
                    <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="link" Text="Connect Outlook Calendar" Click="@ConnectOutlookCalendar" />
                }
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
        <RadzenCard>
            <RadzenStack Gap="1rem">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink: 0;">
                        <path d="M 16.125 1 C 14.972 1.067 13.648328 1.7093438 12.861328 2.5273438 C 12.150328 3.2713438 11.589359 4.3763125 11.818359 5.4453125 C 13.071359 5.4783125 14.329031 4.8193281 15.082031 3.9863281 C 15.785031 3.2073281 16.318 2.12 16.125 1 z M 16.193359 5.4433594 C 14.384359 5.4433594 13.628 6.5546875 12.375 6.5546875 C 11.086 6.5546875 9.9076562 5.5136719 8.3476562 5.5136719 C 6.2256562 5.5146719 3 7.4803281 3 12.111328 C 3 16.324328 6.8176563 21 8.9726562 21 C 10.281656 21.013 10.599 20.176969 12.375 20.167969 C 14.153 20.154969 14.536656 21.011 15.847656 21 C 17.323656 20.989 18.476359 19.367031 19.318359 18.082031 C 19.922359 17.162031 20.170672 16.692344 20.638672 15.652344 C 17.165672 14.772344 16.474672 9.1716719 20.638672 8.0136719 C 19.852672 6.6726719 17.558359 5.4433594 16.193359 5.4433594 z"/>
                    </svg>
                    <RadzenText TextStyle="TextStyle.H6">Apple Calendar</RadzenText>
                    @if (_appleIntegration != null && _appleIntegration.IsEnabled)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Connected" />
                    }
                </RadzenStack>
                <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-2">
                    Sync with Apple Calendar using CalDAV protocol for iCloud calendar integration.
                </RadzenText>

                @if (_appleIntegration != null && _appleIntegration.IsEnabled)
                {
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Caption">
                            <strong>Calendar:</strong> @_appleIntegration.CalendarName
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption">
                            <strong>Last synced:</strong> @(_appleIntegration.LastSyncedAt?.ToLocalTime().ToString("g") ?? "Never")
                        </RadzenText>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" class="rz-mt-2">
                            <RadzenButton ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Icon="sync" Text="Sync Now" Click="@SyncAppleCalendar" Disabled="_isSyncingApple" />
                            <RadzenButton ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Icon="link_off" Text="Disconnect" Click="@DisconnectAppleCalendar" />
                        </RadzenStack>
                        @if (_isSyncingApple)
                        {
                            <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                        }
                    </RadzenStack>
                }
                else
                {
                    <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="link" Text="Connect Apple Calendar" Click="@ConnectAppleCalendar" />
                }
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

<RadzenCard class="rz-mt-4">
    <RadzenStack Gap="1rem">
        <RadzenText TextStyle="TextStyle.H6" class="rz-mb-2">Integration Features</RadzenText>
        <RadzenStack Gap="0.75rem">
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" AlignItems="AlignItems.Start">
                <RadzenIcon Icon="sync" />
                <RadzenText><strong>Two-way synchronization</strong> - Changes in Tempus reflect in your connected calendars and vice versa</RadzenText>
            </RadzenStack>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" AlignItems="AlignItems.Start">
                <RadzenIcon Icon="security" />
                <RadzenText><strong>Secure OAuth2 authentication</strong> - Your credentials are never stored, only secure access tokens</RadzenText>
            </RadzenStack>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" AlignItems="AlignItems.Start">
                <RadzenIcon Icon="cloud_queue" />
                <RadzenText><strong>Real-time updates</strong> - Events sync automatically in the background</RadzenText>
            </RadzenStack>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" AlignItems="AlignItems.Start">
                <RadzenIcon Icon="manage_accounts" />
                <RadzenText><strong>Multiple accounts</strong> - Connect multiple calendars from different providers</RadzenText>
            </RadzenStack>
        </RadzenStack>
    </RadzenStack>
</RadzenCard>

@if ((_googleIntegration == null || !_googleIntegration.IsEnabled) && (_appleIntegration == null || !_appleIntegration.IsEnabled) && (_outlookIntegration == null || !_outlookIntegration.IsEnabled))
{
    <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter" class="rz-mt-4">
        Connect your Google Calendar, Outlook Calendar, or Apple Calendar to enable two-way synchronization. You can also use the ICS import feature to bring in events from your existing calendars.
    </RadzenAlert>
}

<!-- Booking Pages Section -->
<RadzenText TextStyle="TextStyle.H3" class="rz-mb-2 rz-mt-6">Booking Pages</RadzenText>
<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" class="rz-mb-4">
    <RadzenText>Create public booking pages to let others schedule time with you automatically - like Calendly.</RadzenText>
    <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="add_circle" Text="Create Booking Page" Click="@CreateNewBookingPage" />
</RadzenStack>

@if (_isLoadingBookingPages)
{
    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="margin: 2rem auto;" />
}
else if (!_bookingPages.Any())
{
    <RadzenCard>
        <RadzenStack Gap="1rem" AlignItems="AlignItems.Center" Style="text-align: center; padding: 2rem;">
            <RadzenIcon Icon="event_available" Style="font-size: 4rem; color: var(--rz-text-tertiary-color);" />
            <RadzenText TextStyle="TextStyle.H6">No booking pages yet</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">
                Create your first booking page to start accepting appointments.
            </RadzenText>
            <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="add_circle" Text="Create Booking Page" Click="@CreateNewBookingPage" />
        </RadzenStack>
    </RadzenCard>
}
else
{
    <RadzenRow Gap="1rem">
        @foreach (var page in _bookingPages)
        {
            <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                <RadzenCard Style="height: 100%;">
                    <RadzenStack Gap="1rem">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                            <RadzenIcon Icon="event_available" Style="font-size: 1.5rem;" />
                            <RadzenText TextStyle="TextStyle.H6">@(page.Title)</RadzenText>
                            @if (page.IsActive)
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Active" />
                            }
                            else
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="Inactive" />
                            }
                        </RadzenStack>

                        @if (!string.IsNullOrEmpty(page.Description))
                        {
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-2" Style="color: var(--rz-text-secondary-color);">
                                @(page.Description)
                            </RadzenText>
                        }

                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Caption">
                                <strong>Link:</strong> /book/@(page.Slug)
                            </RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption">
                                <strong>Duration:</strong> @(page.DurationMinutes) minutes
                            </RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption">
                                <strong>Bookings:</strong> @(page.TotalBookings)
                            </RadzenText>
                            @if (page.LastBookingAt.HasValue)
                            {
                                <RadzenText TextStyle="TextStyle.Caption">
                                    <strong>Last booking:</strong> @(page.LastBookingAt.Value.ToString("MMM dd, yyyy"))
                                </RadzenText>
                            }
                        </RadzenStack>

                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" class="rz-mt-2">
                            <RadzenButton ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Icon="content_copy" title="Copy link" Click="@(() => CopyBookingLink(page))" />
                            <RadzenButton ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Icon="visibility" title="View" Click="@(() => ViewBookingPage(page))" />
                            <RadzenButton ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Icon="edit" title="Edit" Click="@(() => EditBookingPage(page))" />
                            <RadzenButton ButtonStyle="@(page.IsActive ? ButtonStyle.Warning : ButtonStyle.Success)" Size="ButtonSize.Small" Icon="@(page.IsActive ? "pause_circle" : "play_circle")" title="@(page.IsActive ? "Deactivate" : "Activate")" Click="@(() => ToggleActive(page))" />
                            <RadzenButton ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Icon="delete" title="Delete" Click="@(() => DeleteBookingPage(page))" />
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        }
    </RadzenRow>
}

@code {
    // Calendar integration state
    private CalendarIntegration? _googleIntegration;
    private CalendarIntegration? _appleIntegration;
    private CalendarIntegration? _outlookIntegration;
    private bool _isSyncing = false;
    private bool _isSyncingApple = false;
    private bool _isSyncingOutlook = false;
    private string _userId = string.Empty;

    // Booking pages state
    private List<BookingPage> _bookingPages = new();
    private bool _isLoadingBookingPages = true;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;

        if (!string.IsNullOrEmpty(_userId))
        {
            await LoadIntegrations();
            await LoadBookingPages();
        }
    }

    private async Task LoadIntegrations()
    {
        _googleIntegration = await IntegrationRepository.GetByProviderAsync(_userId, "Google");
        _appleIntegration = await IntegrationRepository.GetByProviderAsync(_userId, "Apple");
        _outlookIntegration = await IntegrationRepository.GetByProviderAsync(_userId, "Outlook");
        StateHasChanged();
    }

    private void ConnectGoogleCalendar()
    {
        try
        {
            var redirectUri = $"{NavigationManager.BaseUri}google-callback";
            var authUrl = GoogleCalendarService.GetAuthorizationUrl(_userId, redirectUri);
            NavigationManager.NavigateTo(authUrl, forceLoad: true);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Connection Failed",
                Detail = ex.Message,
                Duration = 5000
            });
        }
    }

    private async Task SyncGoogleCalendar()
    {
        _isSyncing = true;
        StateHasChanged();

        try
        {
            var result = await GoogleCalendarService.SyncBothWaysAsync(_userId);

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Sync Complete",
                Detail = $"Imported {result.imported} events from Google, exported {result.exported} events to Google",
                Duration = 5000
            });

            await LoadIntegrations();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Sync Failed",
                Detail = ex.Message,
                Duration = 5000
            });
        }
        finally
        {
            _isSyncing = false;
            StateHasChanged();
        }
    }

    private async Task DisconnectGoogleCalendar()
    {
        var confirmed = await DialogService.Confirm(
            "Are you sure you want to disconnect Google Calendar? This will stop synchronization but won't delete any existing events.",
            "Disconnect Google Calendar",
            new ConfirmOptions { OkButtonText = "Disconnect", CancelButtonText = "Cancel" }
        );

        if (confirmed == true && _googleIntegration != null)
        {
            try
            {
                await IntegrationRepository.DeleteAsync(_googleIntegration.Id);
                _googleIntegration = null;

                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Info,
                    Summary = "Google Calendar Disconnected",
                    Detail = "Your Google Calendar has been disconnected from Tempus",
                    Duration = 5000
                });

                StateHasChanged();
            }
            catch (Exception ex)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Disconnect Failed",
                    Detail = ex.Message,
                    Duration = 5000
                });
            }
        }
    }

    // Apple Calendar methods
    private void ConnectAppleCalendar()
    {
        NavigationManager.NavigateTo("/apple-calendar-connect");
    }

    private async Task SyncAppleCalendar()
    {
        _isSyncingApple = true;
        StateHasChanged();

        try
        {
            var result = await AppleCalendarService.SyncBothWaysAsync(_userId);

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Sync Complete",
                Detail = $"Imported {result.imported} events from Apple Calendar, exported {result.exported} events to Apple Calendar",
                Duration = 5000
            });

            await LoadIntegrations();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Sync Failed",
                Detail = ex.Message,
                Duration = 5000
            });
        }
        finally
        {
            _isSyncingApple = false;
            StateHasChanged();
        }
    }

    private async Task DisconnectAppleCalendar()
    {
        var confirmed = await DialogService.Confirm(
            "Are you sure you want to disconnect Apple Calendar? This will stop synchronization but won't delete any existing events.",
            "Disconnect Apple Calendar",
            new ConfirmOptions { OkButtonText = "Disconnect", CancelButtonText = "Cancel" }
        );

        if (confirmed == true && _appleIntegration != null)
        {
            try
            {
                await IntegrationRepository.DeleteAsync(_appleIntegration.Id);
                _appleIntegration = null;

                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Info,
                    Summary = "Apple Calendar Disconnected",
                    Detail = "Your Apple Calendar has been disconnected from Tempus",
                    Duration = 5000
                });

                StateHasChanged();
            }
            catch (Exception ex)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Disconnect Failed",
                    Detail = ex.Message,
                    Duration = 5000
                });
            }
        }
    }

    // Outlook Calendar methods
    private void ConnectOutlookCalendar()
    {
        try
        {
            var redirectUri = $"{NavigationManager.BaseUri}outlook-callback";
            var authUrl = OutlookCalendarService.GetAuthorizationUrl(_userId, redirectUri);
            NavigationManager.NavigateTo(authUrl, forceLoad: true);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Connection Failed",
                Detail = ex.Message,
                Duration = 5000
            });
        }
    }

    private async Task SyncOutlookCalendar()
    {
        _isSyncingOutlook = true;
        StateHasChanged();

        try
        {
            var result = await OutlookCalendarService.SyncBothWaysAsync(_userId);

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Sync Complete",
                Detail = $"Imported {result.imported} events from Outlook, exported {result.exported} events to Outlook",
                Duration = 5000
            });

            await LoadIntegrations();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Sync Failed",
                Detail = ex.Message,
                Duration = 5000
            });
        }
        finally
        {
            _isSyncingOutlook = false;
            StateHasChanged();
        }
    }

    private async Task DisconnectOutlookCalendar()
    {
        var confirmed = await DialogService.Confirm(
            "Are you sure you want to disconnect Outlook Calendar? This will stop synchronization but won't delete any existing events.",
            "Disconnect Outlook Calendar",
            new ConfirmOptions { OkButtonText = "Disconnect", CancelButtonText = "Cancel" }
        );

        if (confirmed == true && _outlookIntegration != null)
        {
            try
            {
                await IntegrationRepository.DeleteAsync(_outlookIntegration.Id);
                _outlookIntegration = null;

                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Info,
                    Summary = "Outlook Calendar Disconnected",
                    Detail = "Your Outlook Calendar has been disconnected from Tempus",
                    Duration = 5000
                });

                StateHasChanged();
            }
            catch (Exception ex)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Disconnect Failed",
                    Detail = ex.Message,
                    Duration = 5000
                });
            }
        }
    }

    // Booking Pages methods
    private async Task LoadBookingPages()
    {
        _isLoadingBookingPages = true;
        try
        {
            _bookingPages = await BookingPageRepository.GetAllAsync(_userId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading booking pages");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = "Failed to load booking pages",
                Duration = 5000
            });
        }
        finally
        {
            _isLoadingBookingPages = false;
        }
    }

    private async Task CreateNewBookingPage()
    {
        var result = await DialogService.OpenAsync<BookingPageDialog>("Create Booking Page",
            new Dictionary<string, object> { { "UserId", _userId } },
            new DialogOptions { Width = "800px", Height = "80vh", Resizable = true, Draggable = true });

        if (result != null)
        {
            await LoadBookingPages();
        }
    }

    private async Task EditBookingPage(BookingPage page)
    {
        var result = await DialogService.OpenAsync<BookingPageDialog>($"Edit {page.Title}",
            new Dictionary<string, object> { { "BookingPage", page }, { "UserId", _userId } },
            new DialogOptions { Width = "800px", Height = "80vh", Resizable = true, Draggable = true });

        if (result != null)
        {
            await LoadBookingPages();
        }
    }

    private void ViewBookingPage(BookingPage page)
    {
        var url = $"/book/{page.Slug}";
        NavigationManager.NavigateTo(url, forceLoad: true);
    }

    private async Task CopyBookingLink(BookingPage page)
    {
        var baseUrl = NavigationManager.BaseUri.TrimEnd('/');
        var fullUrl = $"{baseUrl}/book/{page.Slug}";

        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Info,
            Summary = "Booking Link",
            Detail = $"Copy this link: {fullUrl}",
            Duration = 5000
        });
    }

    private async Task ToggleActive(BookingPage page)
    {
        try
        {
            page.IsActive = !page.IsActive;
            await BookingPageRepository.UpdateAsync(page);
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Success",
                Detail = $"Booking page {(page.IsActive ? "activated" : "deactivated")}",
                Duration = 5000
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error toggling booking page status");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = "Failed to update booking page",
                Duration = 5000
            });
            page.IsActive = !page.IsActive; // Revert on error
        }
    }

    private async Task DeleteBookingPage(BookingPage page)
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to delete '{page.Title}'? This action cannot be undone.",
            "Delete Booking Page",
            new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            try
            {
                await BookingPageRepository.DeleteAsync(page.Id, _userId);
                _bookingPages.Remove(page);
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Success",
                    Detail = "Booking page deleted",
                    Duration = 5000
                });
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error deleting booking page");
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = "Failed to delete booking page",
                    Duration = 5000
                });
            }
        }
    }
}
