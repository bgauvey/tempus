@page "/calendar"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Tempus.Core.Interfaces
@using Tempus.Core.Models
@using Tempus.Core.Enums
@using Tempus.Web.Components.Dialogs
@using Tempus.Web.Components.Shared
@using Tempus.Web.Services
@using Tempus.Web.Helpers
@using Microsoft.JSInterop
@attribute [Authorize]
@inject IEventRepository EventRepository
@inject ISettingsService SettingsService
@inject DialogService DialogService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject Tempus.Web.Components.Account.IdentityUserAccessor IdentityUserAccessor
@inject IPdfAgendaService PdfAgendaService
@inject IJSRuntime JSRuntime
@inject IEmailNotificationService EmailNotificationService
@inject ContextMenuService ContextMenuService
@inject ITimeZoneConversionService TimeZoneConversionService

<PageTitle>Calendar - Tempus</PageTitle>

<style>
    /* Calendar Page Layout */
    .calendar-page-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 80px); /* Subtract header height */
        overflow: hidden;
    }

    .calendar-header-section {
        flex-shrink: 0;
    }

    .calendar-templates-section {
        flex-shrink: 0;
    }

    .calendar-main-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0; /* Important for flex children */
        overflow: hidden;
    }

    .calendar-scheduler-card {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .calendar-scheduler-card .rz-card-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* Make RadzenScheduler fill available space */
    .calendar-scheduler-card .rz-scheduler {
        height: 100% !important;
        min-height: 500px;
    }

    .calendar-scheduler-card .rz-scheduler .rz-scheduler-content {
        height: calc(100% - 60px) !important; /* Subtract scheduler header */
    }

    /* Calendar Styling */
    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 400px;
    }

    :root {
        --transition-smooth: all 0.3s ease-in-out;
    }

    /* Time Block Templates */
    .template-buttons-container {
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        animation: fadeInUp 0.6s ease-out 0.15s backwards;
    }

    .template-buttons-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .template-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
        border-radius: 10px;
        font-weight: 600;
        transition: var(--transition-smooth);
        padding: 10px 16px;
        font-size: 0.85rem;
    }

    .template-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.35);
    }

    .template-btn.deep-work {
        background: linear-gradient(135deg, #8E24AA 0%, #6A1B9A 100%);
    }

    .template-btn.meeting {
        background: linear-gradient(135deg, #1E88E5 0%, #1565C0 100%);
    }

    .template-btn.break {
        background: linear-gradient(135deg, #43A047 0%, #2E7D32 100%);
    }

    .template-btn.focus {
        background: linear-gradient(135deg, #FB8C00 0%, #EF6C00 100%);
    }
</style>

<div class="calendar-page-container">

<div class="calendar-header-section">
    <RadzenCard Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; padding: 2rem; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); margin-bottom: 2rem;">
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center" Gap="1rem">
            <RadzenText TextStyle="TextStyle.DisplayH4" Style="font-weight: 800; margin: 0;">ðŸ“… Calendar</RadzenText>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                <RadzenButton Icon="@(_selectionMode ? "check_box" : "check_box_outline_blank")"
                            ButtonStyle="@(_selectionMode ? ButtonStyle.Warning : ButtonStyle.Secondary)"
                            Click="ToggleSelectionMode"
                            Size="ButtonSize.Medium"
                            Text="@(_selectionMode ? "Exit Selection" : "Select Events")"
                            title="Toggle event selection mode" />
                <RadzenButton Icon="search" ButtonStyle="ButtonStyle.Info" Click="OpenAdvancedSearch" Size="ButtonSize.Medium" Text="Advanced Search" title="Advanced search and filtering" />
                <RadzenButton Icon="picture_as_pdf" ButtonStyle="ButtonStyle.Success" Click="DownloadDailyAgenda" Size="ButtonSize.Medium" Text="Day Agenda" title="Download daily agenda as PDF" />
                @if (_isSearchActive)
                {
                    <RadzenButton Icon="clear" ButtonStyle="ButtonStyle.Warning" Click="ClearSearch" Size="ButtonSize.Medium" Text="Clear Search" title="Show all events" />
                }
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>
</div>

@if (_selectedEventIds.Any())
{
    <div class="calendar-bulk-section">
        <BulkOperationsToolbar SelectedCount="@_selectedEventIds.Count"
                             OnClearSelection="@ClearSelection"
                             OnShowBulkDialog="@OpenBulkActionsDialog"
                             OnBulkComplete="@BulkComplete"
                             OnBulkDelete="@ConfirmBulkDelete" />
    </div>
}

<div class="calendar-templates-section">
    <RadzenCard Style="margin-bottom: 2rem;">
        <RadzenStack Gap="1rem">
            <RadzenText TextStyle="TextStyle.H6" Style="font-weight: 700;">âš¡ Quick Time Block Templates</RadzenText>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" Wrap="FlexWrap.Wrap">
                <RadzenButton Click="@(() => CreateFromTemplate("Deep Work", 120))" class="template-btn deep-work" Size="ButtonSize.Small">
                    ðŸ§  Deep Work (2h)
                </RadzenButton>
                <RadzenButton Click="@(() => CreateFromTemplate("Meeting", 30))" class="template-btn meeting" Size="ButtonSize.Small">
                    ðŸ‘¥ Meeting (30m)
                </RadzenButton>
                <RadzenButton Click="@(() => CreateFromTemplate("Focus Block", 90))" class="template-btn focus" Size="ButtonSize.Small">
                    ðŸŽ¯ Focus Block (1.5h)
                </RadzenButton>
                <RadzenButton Click="@(() => CreateFromTemplate("Break", 15))" class="template-btn break" Size="ButtonSize.Small">
                    â˜• Break (15m)
                </RadzenButton>
                <RadzenButton Click="@(() => CreateFromTemplate("Planning", 60))" class="template-btn" Size="ButtonSize.Small">
                    ðŸ“‹ Planning (1h)
                </RadzenButton>
                <RadzenButton Click="@(() => CreateFromTemplate("Review", 45))" class="template-btn" Size="ButtonSize.Small">
                    âœ… Review (45m)
                </RadzenButton>
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>
</div>

<div class="calendar-main-section">
    <RadzenCard class="calendar-scheduler-card">
        @if (_loading)
        {
            <div class="loading-container">
                <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            </div>
        }
        else
        {
            <RadzenScheduler @ref="_scheduler" TItem="AppointmentData" Data="@_appointments"
                           StartProperty="Start" EndProperty="End" TextProperty="Text"
                           SelectedIndex="@_selectedViewIndex"
                           AppointmentSelect="@OnAppointmentSelect"
                           SlotSelect="@OnSlotSelect"
                           AppointmentRender="@OnAppointmentRender"
                           AppointmentMove="@OnAppointmentMove"
                           @oncontextmenu:preventDefault>
                <ChildContent>
                    <RadzenMonthView />
                    <RadzenWeekView />
                    <RadzenDayView />
                    <RadzenYearView />
                    <RadzenYearPlannerView />
                    <RadzenYearTimelineView />
                </ChildContent>
                <NavigationTemplate>
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Style="margin-bottom: 1rem;">
                        <RadzenButton Text="Month" Click="@(() => ChangeView(0))"
                                    ButtonStyle="@(_selectedViewIndex == 0 ? ButtonStyle.Primary : ButtonStyle.Light)"
                                    Size="ButtonSize.Small" />
                        <RadzenButton Text="Week" Click="@(() => ChangeView(1))"
                                    ButtonStyle="@(_selectedViewIndex == 1 ? ButtonStyle.Primary : ButtonStyle.Light)"
                                    Size="ButtonSize.Small" />
                        <RadzenButton Text="Day" Click="@(() => ChangeView(2))"
                                    ButtonStyle="@(_selectedViewIndex == 2 ? ButtonStyle.Primary : ButtonStyle.Light)"
                                    Size="ButtonSize.Small" />
                        <RadzenButton Text="Year" Click="@(() => ChangeView(3))"
                                    ButtonStyle="@(_selectedViewIndex == 3 ? ButtonStyle.Primary : ButtonStyle.Light)"
                                    Size="ButtonSize.Small" />
                        <RadzenButton Text="Planner" Click="@(() => ChangeView(4))"
                                    ButtonStyle="@(_selectedViewIndex == 4 ? ButtonStyle.Primary : ButtonStyle.Light)"
                                    Size="ButtonSize.Small" />
                        <RadzenButton Text="Timeline" Click="@(() => ChangeView(5))"
                                    ButtonStyle="@(_selectedViewIndex == 5 ? ButtonStyle.Primary : ButtonStyle.Light)"
                                    Size="ButtonSize.Small" />
                    </RadzenStack>
                </NavigationTemplate>
            </RadzenScheduler>
        }
    </RadzenCard>
</div>


</div>

@code {
    // Appointment wrapper class for RadzenScheduler
    public class AppointmentData
    {
        public DateTime Start { get; set; }
        public DateTime End { get; set; }
        public string Text { get; set; } = string.Empty;
        public Event Event { get; set; } = null!;
    }

    // State variables
    private DateTime _selectedDate = DateTime.Today;
    private List<Event> _events = new();
    private List<AppointmentData> _appointments = new();
    private bool _loading = true;
    private CalendarSettings? _settings;
    private string _userId = string.Empty;
    private string _userTimeZone = TimeZoneInfo.Local.Id;
    private RadzenScheduler<AppointmentData>? _scheduler;
    private int _selectedViewIndex = 1; // Default to Week view (index 1)
    private bool _isSearchActive = false;
    private List<Event> _allEvents = new(); // Store all events when search is active

    // Bulk operations
    private bool _selectionMode = false;
    private HashSet<Guid> _selectedEventIds = new();

    // Helper classes
    private CalendarEventManager? _eventManager;
    private CalendarDragDropManager? _dragDropManager;
    private CalendarFormatter? _formatter;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            var appUser = await IdentityUserAccessor.GetUserAsync(user);
            if (appUser != null)
            {
                _userId = appUser.Id;
                _userTimeZone = appUser.TimeZone;
                _settings = await SettingsService.GetOrCreateDefaultSettingsAsync(_userId);

                // Load saved view preference
                // If RememberLastView is enabled and there's a LastUsedView, use it; otherwise use DefaultCalendarView
                var viewToLoad = _settings.RememberLastView && _settings.LastUsedView.HasValue
                    ? _settings.LastUsedView.Value
                    : _settings.DefaultCalendarView;

                _selectedViewIndex = GetSchedulerIndexFromCalendarView(viewToLoad);
            }
        }

        // Initialize helper classes
        _eventManager = new CalendarEventManager(
            EventRepository, DialogService, EmailNotificationService,
            AuthenticationStateProvider, IdentityUserAccessor);
        _dragDropManager = new CalendarDragDropManager(DialogService, _eventManager);
        _formatter = new CalendarFormatter(_settings);

        await LoadEvents();
    }



    private async Task LoadEvents()
    {
        _loading = true;
        StateHasChanged();

        Console.WriteLine("[Calendar.LoadEvents] Loading events...");

        // Load ALL events for the user (no date filter)
        // This ensures imported PST events from any date range are visible
        _events = await EventRepository.GetAllAsync(_userId);

        Console.WriteLine($"[Calendar.LoadEvents] Loaded {_events.Count} total events");
        if (_events.Any())
        {
            var minDate = _events.Min(e => e.StartTime);
            var maxDate = _events.Max(e => e.StartTime);
            Console.WriteLine($"[Calendar.LoadEvents] Event date range: {minDate:yyyy-MM-dd} to {maxDate:yyyy-MM-dd}");
        }

        // Convert events to appointments for RadzenScheduler
        // If event has a timezone, convert it to user's timezone for display
        _appointments = _events.Select(e =>
        {
            var displayEvent = e;

            // If event has a timezone different from user's, convert it
            if (!string.IsNullOrEmpty(e.TimeZoneId) && e.TimeZoneId != _userTimeZone)
            {
                displayEvent = TimeZoneConversionService.ConvertEventToUserTimeZone(e, _userTimeZone);
            }

            return new AppointmentData
            {
                Start = displayEvent.StartTime,
                End = displayEvent.EndTime,
                Text = displayEvent.Title,
                Event = e // Keep original event for editing
            };
        }).ToList();

        _loading = false;
        StateHasChanged();
    }

    private async Task DownloadDailyAgenda()
    {
        try
        {
            // Get events for the selected date
            var eventsForDay = GetEventsForDay(_selectedDate);

            // Get user name
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var userName = "User";
            if (user.Identity?.IsAuthenticated == true)
            {
                var appUser = await IdentityUserAccessor.GetUserAsync(user);
                if (appUser != null)
                {
                    userName = $"{appUser.FirstName} {appUser.LastName}".Trim();
                    if (string.IsNullOrWhiteSpace(userName))
                    {
                        userName = appUser.Email ?? "User";
                    }
                }
            }

            // Generate PDF
            var pdfBytes = PdfAgendaService.GenerateDailyAgenda(eventsForDay, _selectedDate, userName);

            // Download file using inline JavaScript to avoid timing issues
            var fileName = $"Daily-Agenda-{_selectedDate:yyyy-MM-dd}.pdf";
            var base64 = Convert.ToBase64String(pdfBytes);

            await JSRuntime.InvokeVoidAsync("eval", $@"
                (function() {{
                    const byteCharacters = atob('{base64}');
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {{
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }}
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], {{ type: 'application/pdf' }});
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = '{fileName}';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                }})();
            ");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error generating PDF: {ex.Message}");
        }
    }

    private List<Event> GetEventsForDay(DateTime date)
    {
        return _events
            .Where(e => e.StartTime.Date == date.Date)
            .OrderBy(e => e.StartTime)
            .ToList();
    }


    private async Task OnAppointmentSelect(SchedulerAppointmentSelectEventArgs<AppointmentData> args)
    {
        var appointment = args.Data;
        if (appointment?.Event != null)
        {
            // If in selection mode, toggle selection instead of opening dialog
            if (_selectionMode)
            {
                ToggleEventSelection(appointment.Event.Id);
            }
            else
            {
                await OpenEventDialogAsync(appointment.Event.RecurrenceParentId ?? appointment.Event.Id);
            }
        }
    }

    private async Task OnSlotSelect(SchedulerSlotSelectEventArgs args)
    {
        await OpenEventDialogAsync(null, args.Start);
    }

    private void OnAppointmentRender(SchedulerAppointmentRenderEventArgs<AppointmentData> args)
    {
        var evt = args.Data.Event;
        if (evt != null && _formatter != null)
        {
            // Check if event is selected
            var isSelected = _selectedEventIds.Contains(evt.Id);

            // Apply event color
            var backgroundColor = _formatter.GetEventBackgroundColor(evt);

            // Add selection styling if selected
            if (isSelected)
            {
                args.Attributes["style"] = $"background-color: {backgroundColor}; border: 3px solid #FFD700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);";
            }
            else
            {
                args.Attributes["style"] = $"background-color: {backgroundColor}; border-left: 4px solid {backgroundColor};";
            }

            // Add icon based on event type
            var icon = _formatter.GetEventIcon(evt.EventType);

            // Add selection indicator
            var selectionIndicator = isSelected ? "âœ“ " : "";

            // Add timezone indicator if event is in a different timezone
            var timeZoneIndicator = "";
            if (!string.IsNullOrEmpty(evt.TimeZoneId) && evt.TimeZoneId != _userTimeZone)
            {
                try
                {
                    var tz = TimeZoneInfo.FindSystemTimeZoneById(evt.TimeZoneId);
                    var abbreviation = GetTimeZoneAbbreviation(tz);
                    timeZoneIndicator = $" ðŸŒ {abbreviation}";
                }
                catch
                {
                    timeZoneIndicator = " ðŸŒ";
                }
            }

            args.Data.Text = $"{selectionIndicator}{icon} {evt.Title}{timeZoneIndicator}";
        }

        // Add context menu to appointment
        args.Attributes["oncontextmenu"] = (MouseEventArgs mouseArgs) =>
        {
            ShowContextMenu(mouseArgs, args.Data);
        };
    }

    private string GetTimeZoneAbbreviation(TimeZoneInfo tz)
    {
        var abbreviation = tz.IsDaylightSavingTime(DateTime.Now)
            ? tz.DaylightName
            : tz.StandardName;

        // Try to get a shorter abbreviation
        if (abbreviation.Contains("Standard") || abbreviation.Contains("Daylight"))
        {
            var words = abbreviation.Split(' ');
            if (words.Length > 1)
            {
                abbreviation = string.Join("", words.Select(w => char.IsLetter(w.FirstOrDefault()) ? w.First() : ' ')).Trim();
            }
        }

        // If abbreviation is still long, use UTC offset instead
        if (abbreviation.Length > 5)
        {
            abbreviation = $"UTC{tz.BaseUtcOffset:hh\\:mm}";
        }

        return abbreviation;
    }


    private async Task OpenEventDialogAsync(Guid? eventId, DateTime? prefilledDate = null)
    {
        if (_eventManager != null)
        {
            var saved = await _eventManager.OpenEventDialogAsync(eventId, prefilledDate);
            if (saved)
            {
                await LoadEvents();
            }
        }
    }

    private async Task EditSingleOccurrenceAsync(Event instance)
    {
        if (_eventManager != null)
        {
            var saved = await _eventManager.EditSingleOccurrenceAsync(instance);
            if (saved)
            {
                await LoadEvents();
            }
        }
    }

    private async Task DeleteSingleOccurrenceAsync(Event instance)
    {
        if (_eventManager != null)
        {
            var deleted = await _eventManager.DeleteSingleOccurrenceAsync(instance, _userId);
            if (deleted)
            {
                await LoadEvents();
            }
        }
    }

    private async Task DeleteEventAsync(Guid id)
    {
        if (_eventManager != null)
        {
            var deleted = await _eventManager.DeleteEventAsync(id, _userId);
            if (deleted)
            {
                await LoadEvents();
            }
        }
    }

    // Event Icon Mapping
    private string GetEventIcon(Core.Enums.EventType eventType)
    {
        return _formatter?.GetEventIcon(eventType) ?? "ðŸ“Œ";
    }

    // Template Creation
    private async Task CreateFromTemplate(string templateName, int durationMinutes)
    {
        if (_eventManager != null)
        {
            await _eventManager.CreateFromTemplateAsync(templateName, durationMinutes, _selectedDate, _settings, _userId);
            await LoadEvents();
            StateHasChanged();
        }
    }

    // AppointmentMove - handles drag and drop using RadzenScheduler's built-in functionality
    private async Task OnAppointmentMove(SchedulerAppointmentMoveEventArgs args)
    {
        if (_dragDropManager == null) return;

        try
        {
            var appointment = (AppointmentData)args.Appointment.Data;
            var evt = appointment?.Event;

            if (evt == null || appointment == null) return;

            // Calculate new start and end times
            var newStartTime = evt.StartTime + args.TimeSpan;
            var newEndTime = evt.EndTime + args.TimeSpan;

            // Handle recurring events with confirmation dialog
            await _dragDropManager.HandleEventDropAsync(
                evt,
                newStartTime,
                newEndTime,
                _userId,
                async () =>
                {
                    // Update the appointment data immediately for UI responsiveness
                    appointment.Start = newStartTime;
                    appointment.End = newEndTime;

                    // Reload events from database
                    await LoadEvents();

                    // Reload the scheduler
                    if (_scheduler != null)
                    {
                        await _scheduler.Reload();
                    }
                });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in OnAppointmentMove: {ex.Message}");
        }
    }


    // Context Menu
    private void ShowContextMenu(MouseEventArgs args, AppointmentData data)
    {
        var evt = data.Event;
        if (evt == null) return;

        var menuItems = new List<ContextMenuItem>();

        // Add selection option if in selection mode
        if (_selectionMode)
        {
            var isSelected = _selectedEventIds.Contains(evt.Id);
            menuItems.Add(new ContextMenuItem
            {
                Text = isSelected ? "Deselect" : "Select",
                Value = data,
                Icon = isSelected ? "check_box_outline_blank" : "check_box"
            });
        }
        else
        {
            menuItems.Add(new ContextMenuItem { Text = "Edit", Value = data, Icon = "edit" });

            // Add "Edit Series" option if this is a recurring event
            if (evt.IsRecurring || evt.RecurrenceParentId.HasValue)
            {
                menuItems.Add(new ContextMenuItem { Text = "Edit Series", Value = data, Icon = "event_repeat" });
            }

            menuItems.Add(new ContextMenuItem { Text = "Duplicate", Value = data, Icon = "content_copy" });
            menuItems.Add(new ContextMenuItem { Text = "Delete", Value = data, Icon = "delete" });
        }

        ContextMenuService.Open(args, menuItems, OnMenuItemClick);
    }

    private async void OnMenuItemClick(MenuItemEventArgs item)
    {
        ContextMenuService.Close();

        var data = item.Value as AppointmentData;
        if (data?.Event == null) return;

        switch (item.Text)
        {
            case "Select":
            case "Deselect":
                ToggleEventSelection(data.Event.Id);
                break;

            case "Edit":
                await OpenEventDialogAsync(data.Event.Id);
                break;

            case "Edit Series":
                // For recurring events, edit the parent event
                var eventIdToEdit = data.Event.RecurrenceParentId ?? data.Event.Id;
                await OpenEventDialogAsync(eventIdToEdit);
                break;

            case "Duplicate":
                await DuplicateEventAsync(data.Event);
                break;

            case "Delete":
                await DeleteEventAsync(data.Event.Id);
                break;
        }
    }

    private async Task DuplicateEventAsync(Event originalEvent)
    {
        try
        {
            // Create a duplicate of the event
            var duplicateEvent = new Event
            {
                Id = Guid.NewGuid(),
                Title = $"{originalEvent.Title} (Copy)",
                Description = originalEvent.Description,
                StartTime = originalEvent.StartTime,
                EndTime = originalEvent.EndTime,
                Location = originalEvent.Location,
                EventType = originalEvent.EventType,
                Priority = originalEvent.Priority,
                Color = originalEvent.Color,
                UserId = _userId,
                IsAllDay = originalEvent.IsAllDay,
                IsRecurring = false, // Don't duplicate recurrence
                RecurrencePattern = RecurrencePattern.None,
                RecurrenceEndDate = null,
                RecurrenceParentId = null,
                IsRecurrenceException = false,
                RecurrenceExceptionDate = null,
                Tags = new List<string>(originalEvent.Tags),
                Attendees = new List<Attendee>(originalEvent.Attendees.Select(a => new Attendee
                {
                    Id = Guid.NewGuid(),
                    Name = a.Name,
                    Email = a.Email,
                    EventId = Guid.Empty // Will be set when saved
                })),
                CreatedAt = DateTime.UtcNow,
                HourlyCostPerAttendee = originalEvent.HourlyCostPerAttendee,
                MeetingCost = originalEvent.MeetingCost
            };

            await EventRepository.CreateAsync(duplicateEvent);
            await LoadEvents();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error duplicating event: {ex.Message}");
        }
    }

    // View management
    private async Task ChangeView(int newIndex)
    {
        _selectedViewIndex = newIndex;

        // Use JSRuntime to log to browser console
        await JSRuntime.InvokeVoidAsync("console.log", $"[Calendar ChangeView] Changing view to index: {newIndex}");

        // Save the selected view to settings
        if (_settings != null)
        {
            var newView = GetCalendarViewFromSchedulerIndex(newIndex);

            // Update last used view if RememberLastView is enabled
            if (_settings.RememberLastView)
            {
                _settings.LastUsedView = newView;
                _settings.LastViewChangeDate = DateTime.UtcNow;
            }

            // Also update default view
            _settings.DefaultCalendarView = newView;
            _settings.UpdatedAt = DateTime.UtcNow;

            await JSRuntime.InvokeVoidAsync("console.log", $"[Calendar ChangeView] Saving view preference: {newView}");

            try
            {
                var savedSettings = await SettingsService.CreateOrUpdateSettingsAsync(_settings);
                await JSRuntime.InvokeVoidAsync("console.log", $"[Calendar ChangeView] Saved successfully. DefaultCalendarView: {savedSettings.DefaultCalendarView}, LastUsedView: {savedSettings.LastUsedView}");
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("console.error", $"[Calendar ChangeView] Error saving: {ex.Message}");
            }
        }

        StateHasChanged();
    }

    private int GetSchedulerIndexFromCalendarView(CalendarView view)
    {
        return view switch
        {
            CalendarView.Month => 0,         // RadzenMonthView
            CalendarView.Week => 1,          // RadzenWeekView
            CalendarView.Day => 2,           // RadzenDayView
            CalendarView.Year => 3,          // RadzenYearView
            CalendarView.YearPlanner => 4,   // RadzenYearPlannerView
            CalendarView.YearTimeline => 5,  // RadzenYearTimelineView
            CalendarView.WorkWeek => 1,      // RadzenWeekView (no separate WorkWeek view in scheduler)
            _ => 1                           // Default to Week
        };
    }

    private CalendarView GetCalendarViewFromSchedulerIndex(int index)
    {
        return index switch
        {
            0 => CalendarView.Month,         // RadzenMonthView
            1 => CalendarView.Week,          // RadzenWeekView
            2 => CalendarView.Day,           // RadzenDayView
            3 => CalendarView.Year,          // RadzenYearView
            4 => CalendarView.YearPlanner,   // RadzenYearPlannerView
            5 => CalendarView.YearTimeline,  // RadzenYearTimelineView
            _ => CalendarView.Week        // Default to Week
        };
    }

    // Advanced Search
    private async Task OpenAdvancedSearch()
    {
        var result = await DialogService.OpenAsync<AdvancedSearchDialog>("Advanced Search",
            new Dictionary<string, object>(),
            new DialogOptions() { Width = "700px", Height = "600px", Resizable = true, Draggable = true });

        if (result is AdvancedSearchFilter filter)
        {
            await PerformSearch(filter);
        }
    }

    private async Task PerformSearch(AdvancedSearchFilter filter)
    {
        _loading = true;
        StateHasChanged();

        try
        {
            // Store all events if this is the first search
            if (!_isSearchActive)
            {
                _allEvents = new List<Event>(_events);
            }

            // Perform the search
            var searchResults = await EventRepository.AdvancedSearchAsync(filter, _userId);

            // Update the events list with search results
            _events = searchResults;

            // Convert search results to appointments
            _appointments = _events.Select(e =>
            {
                var displayEvent = e;

                // If event has a timezone different from user's, convert it
                if (!string.IsNullOrEmpty(e.TimeZoneId) && e.TimeZoneId != _userTimeZone)
                {
                    displayEvent = TimeZoneConversionService.ConvertEventToUserTimeZone(e, _userTimeZone);
                }

                return new AppointmentData
                {
                    Start = displayEvent.StartTime,
                    End = displayEvent.EndTime,
                    Text = displayEvent.Title,
                    Event = e
                };
            }).ToList();

            _isSearchActive = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error performing search: {ex.Message}");
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task ClearSearch()
    {
        _loading = true;
        StateHasChanged();

        // Restore all events
        if (_allEvents.Any())
        {
            _events = new List<Event>(_allEvents);
        }
        else
        {
            // If no stored events, reload from database
            await LoadEvents();
        }

        // Convert back to appointments
        _appointments = _events.Select(e =>
        {
            var displayEvent = e;

            // If event has a timezone different from user's, convert it
            if (!string.IsNullOrEmpty(e.TimeZoneId) && e.TimeZoneId != _userTimeZone)
            {
                displayEvent = TimeZoneConversionService.ConvertEventToUserTimeZone(e, _userTimeZone);
            }

            return new AppointmentData
            {
                Start = displayEvent.StartTime,
                End = displayEvent.EndTime,
                Text = displayEvent.Title,
                Event = e
            };
        }).ToList();

        _isSearchActive = false;
        _allEvents.Clear();

        _loading = false;
        StateHasChanged();
    }

    // Bulk Operations
    private void ToggleSelectionMode()
    {
        _selectionMode = !_selectionMode;

        if (!_selectionMode)
        {
            // Clear selection when exiting selection mode
            _selectedEventIds.Clear();
        }

        StateHasChanged();
    }

    private void ToggleEventSelection(Guid eventId)
    {
        if (_selectedEventIds.Contains(eventId))
        {
            _selectedEventIds.Remove(eventId);
        }
        else
        {
            _selectedEventIds.Add(eventId);
        }

        StateHasChanged();
    }

    private void ClearSelection()
    {
        _selectedEventIds.Clear();
        StateHasChanged();
    }

    private async Task OpenBulkActionsDialog(string actionType)
    {
        var parameters = new Dictionary<string, object>
        {
            { "ActionType", actionType },
            { "SelectedCount", _selectedEventIds.Count }
        };

        var result = await DialogService.OpenAsync<BulkActionsDialog>($"Bulk {actionType.ToUpper()}",
            parameters,
            new DialogOptions() { Width = "500px", Height = "auto", Resizable = true, Draggable = true });

        if (result != null)
        {
            await ApplyBulkAction(actionType, result);
        }
    }

    private async Task ApplyBulkAction(string actionType, object value)
    {
        _loading = true;
        StateHasChanged();

        try
        {
            var selectedIds = _selectedEventIds.ToList();
            int affectedCount = 0;

            switch (actionType)
            {
                case "type":
                    affectedCount = await EventRepository.BulkUpdateEventTypeAsync(selectedIds, (EventType)value, _userId);
                    break;

                case "priority":
                    affectedCount = await EventRepository.BulkUpdatePriorityAsync(selectedIds, (Priority)value, _userId);
                    break;

                case "color":
                    affectedCount = await EventRepository.BulkUpdateColorAsync(selectedIds, (string)value, _userId);
                    break;

                case "move":
                    affectedCount = await EventRepository.BulkMoveAsync(selectedIds, (TimeSpan)value, _userId);
                    break;
            }

            // Reload events
            await LoadEvents();

            // Clear selection
            _selectedEventIds.Clear();

            // Show success message
            Console.WriteLine($"Successfully updated {affectedCount} event(s)");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error performing bulk action: {ex.Message}");
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task BulkComplete(bool isCompleted)
    {
        _loading = true;
        StateHasChanged();

        try
        {
            var selectedIds = _selectedEventIds.ToList();
            var affectedCount = await EventRepository.BulkCompleteAsync(selectedIds, isCompleted, _userId);

            // Reload events
            await LoadEvents();

            // Clear selection
            _selectedEventIds.Clear();

            Console.WriteLine($"Successfully marked {affectedCount} event(s) as {(isCompleted ? "complete" : "incomplete")}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error marking events: {ex.Message}");
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task ConfirmBulkDelete()
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to delete {_selectedEventIds.Count} selected event(s)? This action cannot be undone.",
            "Confirm Bulk Delete",
            new ConfirmOptions() { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            await BulkDelete();
        }
    }

    private async Task BulkDelete()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            var selectedIds = _selectedEventIds.ToList();
            var affectedCount = await EventRepository.BulkDeleteAsync(selectedIds, _userId);

            // Reload events
            await LoadEvents();

            // Clear selection
            _selectedEventIds.Clear();

            Console.WriteLine($"Successfully deleted {affectedCount} event(s)");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting events: {ex.Message}");
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }
}
