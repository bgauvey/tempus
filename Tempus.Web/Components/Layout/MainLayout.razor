@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Extensions.Options
@using Tempus.Core.Models
@using Microsoft.AspNetCore.Identity
@using Tempus.Web.Components.Shared
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject CookieThemeService CookieThemeService
@inject ThemeService ThemeService
@inject IOptions<CookieThemeServiceOptions> Options 

<RadzenComponents @rendermode="InteractiveServer" />
<RadzenContextMenu @rendermode="InteractiveServer" />
<ScrollToTopHandler />

<!-- Notification Poller for logged-in users -->
<AuthorizeView>
    <Authorized>
        <NotificationPoller @rendermode="InteractiveServer" />
    </Authorized>
</AuthorizeView>

<CascadingValue Value="@_helpPopover">
    <RadzenLayout>
    <!-- Public Header for Unauthenticated Users -->
    <AuthorizeView>
        <NotAuthorized>
            <RadzenHeader>
                <!-- wrap public header in container-max so it gets the same horizontal padding as other pages
                     and add a small top padding so it doesn't touch the very top of the browser -->
                <div class="container-max header-container">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                            <RadzenImage Path="./images/favicon-gray.png" Style="width: 32px; height: 32px; background-color: transparent;" Class="tempus-icon" AlternateText="Tempus Icon" />
                            <RadzenText TextStyle="TextStyle.H5">
                                Tempus
                            </RadzenText>
                        </RadzenStack>                    
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="2rem">
                            <RadzenLink Path="/">Home</RadzenLink>
                            <RadzenLink Path="/features">Features</RadzenLink>
                            <RadzenLink Path="/about">About</RadzenLink>
                            <RadzenLink Path="/Account/Login">Login</RadzenLink>
                        </RadzenStack>
                    </RadzenStack>
                </div>
            </RadzenHeader>
        </NotAuthorized>
        <Authorized>
            <RadzenHeader>
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                        <!-- Mobile Hamburger Menu Button (44px touch target) -->
                        <RadzenButton Icon="menu"
                                      ButtonStyle="ButtonStyle.Light"
                                      Click="@(() => _drawerOpen = !_drawerOpen)"
                                      Class="mobile-menu-toggle"
                                      Style="min-width: 44px; min-height: 44px; padding: 0;"
                                      title="Toggle navigation menu" />

                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                            <RadzenImage Path="./images/favicon2.png" Style="width: 32px; height: 32px; background-color: transparent;" Class="tempus-icon" AlternateText="Tempus Icon" />
                            <RadzenText TextStyle="TextStyle.H5">
                                Tempus
                            </RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                        <RadzenAppearanceToggle />
                        <NavMenu />
                    </RadzenStack>
                </RadzenStack>
            </RadzenHeader>
        </Authorized>
    </AuthorizeView>

    <!-- Sidebar only for Authenticated Users -->
    <AuthorizeView>
        <Authorized>
            <div class="custom-sidebar @(_sidebarPinned ? "pinned" : "collapsed") @(_sidebarHovered ? "hovered" : "") @(!_drawerOpen ? "hidden" : "")"
                 @onmouseenter="@(() => { if (!_sidebarPinned) _sidebarHovered = true; })"
                 @onmouseleave="@(() => _sidebarHovered = false)">

                <!-- Simplified Navigation -->
                <RadzenPanelMenu @rendermode="InteractiveServer" class="sidebar-menu">
                    <!-- Calendar: Main view -->
                    <RadzenPanelMenuItem Text="Calendar" Path="/calendar" Icon="calendar_month" />

                    <!-- Tasks: Task-focused view -->
                    <RadzenPanelMenuItem Text="Tasks" Path="/tasks" Icon="check_circle" />

                    <!-- People: Contacts + Teams -->
                    <RadzenPanelMenuItem Text="People" Icon="people">
                        <RadzenPanelMenuItem Text="Contacts" Path="/addresses" Icon="contact_mail" />
                        <RadzenPanelMenuItem Text="Teams" Path="/teams" Icon="groups" />
                    </RadzenPanelMenuItem>

                    <!-- Insights: Analytics + Benchmarks -->
                    <RadzenPanelMenuItem Text="Insights" Path="/insights" Icon="insights" />

                    <!-- Settings: All configuration -->
                    <RadzenPanelMenuItem Text="Settings" Icon="settings">
                        <RadzenPanelMenuItem Text="General" Path="/settings" Icon="tune" />
                        <RadzenPanelMenuItem Text="Calendar Sources" Path="/calendar-sources" Icon="event" />
                        <RadzenPanelMenuItem Text="Integrations" Path="/integrations" Icon="sync" />
                        <RadzenPanelMenuItem Text="Import/Export" Path="/import" Icon="upload" />
                        <RadzenPanelMenuItem Text="Availability" Path="/out-of-office" Icon="beach_access" />
                    </RadzenPanelMenuItem>
                </RadzenPanelMenu>

                <!-- Pin/Unpin Button -->
                <div class="sidebar-pin-button">
                    <RadzenButton Icon="@(_sidebarPinned ? "push_pin" : "push_pin")"
                                  ButtonStyle="ButtonStyle.Light"
                                  Click="@(() => _sidebarPinned = !_sidebarPinned)"
                                  Size="ButtonSize.Small"
                                  Style="@(_sidebarPinned ? "" : "transform: rotate(45deg);")"
                                  title="@(_sidebarPinned ? "Unpin sidebar" : "Pin sidebar")" />
                </div>
            </div>
        </Authorized>
    </AuthorizeView>
    <RadzenBody>
        <main id="main-content" tabindex="-1">
            @Body
        </main>
        <AuthorizeView>
            <NotAuthorized>
                <footer>
                    <div class="container-max">
                        <RadzenRow Gap="2rem">
                            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                                <RadzenStack Gap="1rem">
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                        <RadzenIcon Icon="access_time" />
                                        <RadzenText TextStyle="TextStyle.H5">Tempus</RadzenText>
                                    </RadzenStack>
                                    <RadzenText>Master your time, transform your business. The ultimate time management platform.</RadzenText>
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                                <RadzenStack Gap="0.75rem">
                                    <RadzenText TextStyle="TextStyle.H6">Company</RadzenText>
                                    <RadzenLink Path="/about">About Us</RadzenLink>
                                    <RadzenLink Path="#">Blog</RadzenLink>
                                    <RadzenLink Path="/contact">Contact</RadzenLink>
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                                <RadzenStack Gap="0.75rem">
                                    <RadzenLink Path="/privacy">Privacy Policy</RadzenLink>
                                    <RadzenLink Path="/terms">Terms of Service</RadzenLink>
                                    <RadzenLink Path="/security">Security</RadzenLink>
                                    <RadzenLink Path="/gdpr">GDPR</RadzenLink>
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenText>Â© @DateTime.Now.Year Tempus. All rights reserved.</RadzenText>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.End">
                                    <RadzenButton Icon="share" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" />
                                    <RadzenButton Icon="link" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" />
                                    <RadzenButton Icon="email" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>
                    </div>
                </footer>
            </NotAuthorized>
        </AuthorizeView>
    </RadzenBody>
</RadzenLayout>
</CascadingValue>

<!-- Help Popover Component -->
<HelpPopover @ref="_helpPopover" />

<style>
    /* Custom Collapsible Sidebar */
    .custom-sidebar {
        position: fixed;
        left: 0;
        top: 60px;
        bottom: 0;
        background: var(--rz-sidebar-background-color, var(--rz-base-background-color));
        border-right: 1px solid var(--rz-base-border-color);
        transition: width 0.3s ease, box-shadow 0.3s ease;
        z-index: 999;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* Collapsed state (icon-only) */
    .custom-sidebar.collapsed {
        width: 64px;
    }

    /* Pinned state (expanded inline) */
    .custom-sidebar.pinned {
        width: 260px;
        position: relative;
        z-index: 1;
    }

    /* Hovered state (expanded overlay) */
    .custom-sidebar.collapsed.hovered {
        width: 260px;
        box-shadow: 4px 0 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
    }

    /* Hidden state (mobile) */
    .custom-sidebar.hidden {
        transform: translateX(-100%);
    }

    /* Sidebar menu styling */
    .custom-sidebar .sidebar-menu {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
    }

    /* Hide text in collapsed mode */
    .custom-sidebar.collapsed:not(.hovered) .rz-navigation-item-text {
        opacity: 0;
        width: 0;
        overflow: hidden;
        white-space: nowrap;
    }

    /* Center icons in collapsed mode */
    .custom-sidebar.collapsed:not(.hovered) .rz-navigation-item-icon {
        margin-right: 0 !important;
    }

    .custom-sidebar.collapsed:not(.hovered) .rz-navigation-item-link {
        justify-content: center;
        padding-left: 0;
        padding-right: 0;
    }

    /* Pin button at bottom */
    .sidebar-pin-button {
        padding: 1rem;
        border-top: 1px solid var(--rz-base-border-color);
        display: flex;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .custom-sidebar.collapsed:not(.hovered) .sidebar-pin-button {
        padding: 0.5rem;
    }

    /* Adjust body when sidebar is pinned */
    .custom-sidebar.pinned ~ .rz-body {
        margin-left: 260px;
    }

    .custom-sidebar.collapsed ~ .rz-body {
        margin-left: 64px;
    }

    .custom-sidebar.hidden ~ .rz-body {
        margin-left: 0;
    }

    /* Mobile responsive */
    @@media (max-width: 768px) {
        .custom-sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .custom-sidebar:not(.hidden) {
            transform: translateX(0);
            width: 260px !important;
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.15);
        }

        .custom-sidebar ~ .rz-body {
            margin-left: 0 !important;
        }
    }

    /* Smooth transitions for menu items */
    .custom-sidebar .rz-navigation-item {
        transition: all 0.3s ease;
    }

    /* Tooltip for collapsed items */
    .custom-sidebar.collapsed:not(.hovered) .rz-navigation-item-link {
        position: relative;
    }
</style>

@code {
    private HelpPopover? _helpPopover;
    [CascadingParameter]
    private HttpContext? HttpContext { get; set; }

    private bool _drawerOpen = true;
    private bool _sidebarPinned = false;
    private bool _sidebarHovered = false;

    protected override void OnInitialized()
    {
        base.OnInitialized();

        if (HttpContext != null)
        {
            var theme = HttpContext.Request.Cookies["TempusTheme"];

            if (!string.IsNullOrEmpty(theme))
            {
                ThemeService.SetTheme(theme, true);
            }
            else
            {
                ThemeService.SetTheme("software", true);
                HttpContext.Response.Cookies.Append("TempusTheme", 
                "software" , 
                new CookieOptions {
                    Secure = true, 
                    Expires = DateTimeOffset.Now.Add(Options.Value.Duration) 
                });    
            }
        }
    }
}
