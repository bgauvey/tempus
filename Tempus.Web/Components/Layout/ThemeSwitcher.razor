@inject IJSRuntime JSRuntime
@inject ILogger<ThemeSwitcher> Logger

<div class="theme-switcher">
    <RadzenButton Icon="@(_isDarkMode ? "light_mode" : "dark_mode")"
                  ButtonStyle="ButtonStyle.Light"
                  Variant="Variant.Flat"
                  Size="ButtonSize.Medium"
                  Click="@ToggleTheme"
                  title="@(_isDarkMode ? "Switch to light mode" : "Switch to dark mode")"
                  class="theme-toggle-button" />
</div>

<style>
    .theme-switcher {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .theme-toggle-button {
        border-radius: 50% !important;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .theme-toggle-button:hover {
        transform: rotate(180deg);
        background-color: var(--rz-primary-lighter) !important;
    }

    .theme-toggle-button .rz-button-icon-left {
        margin: 0 !important;
    }
</style>

@code {
    private bool _isDarkMode = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Get the saved theme from localStorage
                var savedTheme = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "theme");

                if (savedTheme == "dark")
                {
                    _isDarkMode = true;
                }
                else if (string.IsNullOrEmpty(savedTheme))
                {
                    // Check system preference
                    var prefersDark = await JSRuntime.InvokeAsync<bool>("eval", "window.matchMedia('(prefers-color-scheme: dark)').matches");
                    _isDarkMode = prefersDark;
                }

                // Apply the theme
                await ApplyTheme(_isDarkMode);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error loading theme preference");
            }
        }
    }

    private async Task ToggleTheme()
    {
        _isDarkMode = !_isDarkMode;
        await ApplyTheme(_isDarkMode);

        try
        {
            // Save preference to localStorage
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "theme", _isDarkMode ? "dark" : "light");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving theme preference");
        }
    }

    private async Task ApplyTheme(bool isDark)
    {
        try
        {
            var theme = isDark ? "dark" : "light";
            await JSRuntime.InvokeVoidAsync("eval", $"document.documentElement.setAttribute('data-theme', '{theme}')");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error applying theme");
        }
    }
}
