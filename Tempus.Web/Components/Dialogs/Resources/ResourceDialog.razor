@using Tempus.Core.Interfaces
@using Tempus.Core.Models
@using Tempus.Core.Enums
@inject IResourceRepository ResourceRepository
@inject ILogger<ResourceDialog> Logger
@inject NotificationService NotificationService
@inject DialogService DialogService

<RadzenStack Gap="1rem">
    <RadzenFormField Text="Resource Name" Variant="@Variant.Outlined">
        <RadzenTextBox @bind-Value="@model.Name" Style="width: 100%;" Placeholder="e.g., Projector, Company Car" />
    </RadzenFormField>

    <RadzenFormField Text="Resource Type" Variant="@Variant.Outlined">
        <RadzenDropDown @bind-Value="@model.ResourceType" Data="@resourceTypes" Style="width: 100%;"
                        TextProperty="Text" ValueProperty="Value" />
    </RadzenFormField>

    <RadzenFormField Text="Description (Optional)" Variant="@Variant.Outlined">
        <RadzenTextArea @bind-Value="@model.Description" Style="width: 100%;" Rows="3"
                        Placeholder="Brief description of the resource" />
    </RadzenFormField>

    <RadzenRow>
        <RadzenColumn Size="6">
            <RadzenFormField Text="Quantity" Variant="@Variant.Outlined">
                <RadzenNumeric @bind-Value="@model.Quantity" Style="width: 100%;" Min="1" Max="1000" />
            </RadzenFormField>
        </RadzenColumn>
        <RadzenColumn Size="6">
            <RadzenFormField Text="Condition" Variant="@Variant.Outlined">
                <RadzenDropDown @bind-Value="@model.Condition" Data="@conditions" Style="width: 100%;"
                                TextProperty="Text" ValueProperty="Value" />
            </RadzenFormField>
        </RadzenColumn>
    </RadzenRow>

    <RadzenFormField Text="Location (Optional)" Variant="@Variant.Outlined">
        <RadzenTextBox @bind-Value="@model.Location" Style="width: 100%;" Placeholder="e.g., Storage Room A, Parking Lot" />
    </RadzenFormField>

    <RadzenRow>
        <RadzenColumn Size="6">
            <RadzenFormField Text="Model (Optional)" Variant="@Variant.Outlined">
                <RadzenTextBox @bind-Value="@model.Model" Style="width: 100%;" Placeholder="e.g., Epson EB-2250U" />
            </RadzenFormField>
        </RadzenColumn>
        <RadzenColumn Size="6">
            <RadzenFormField Text="Serial Number (Optional)" Variant="@Variant.Outlined">
                <RadzenTextBox @bind-Value="@model.SerialNumber" Style="width: 100%;" Placeholder="e.g., SN123456" />
            </RadzenFormField>
        </RadzenColumn>
    </RadzenRow>

    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
        <RadzenCheckBox @bind-Value="@model.IsAvailable" Name="isAvailable" />
        <RadzenLabel Text="Resource is available for reservation" Component="isAvailable" />
    </RadzenStack>

    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End" Gap="0.5rem" Style="margin-top: 1rem;">
        <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@Cancel" />
        <RadzenButton Text="@(isEditMode ? "Update" : "Create")" ButtonStyle="ButtonStyle.Primary" Click="@Save" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter]
    public Resource? Resource { get; set; }

    [Parameter]
    public string UserId { get; set; } = string.Empty;

    private Resource model = new();
    private bool isEditMode = false;

    private class DropDownItem<T>
    {
        public string Text { get; set; } = string.Empty;
        public T Value { get; set; } = default!;
    }

    private List<DropDownItem<ResourceType>> resourceTypes = new()
    {
        new() { Text = "Equipment", Value = ResourceType.Equipment },
        new() { Text = "Vehicle", Value = ResourceType.Vehicle },
        new() { Text = "Software", Value = ResourceType.Software },
        new() { Text = "Furniture", Value = ResourceType.Furniture },
        new() { Text = "Other", Value = ResourceType.Other }
    };

    private List<DropDownItem<ResourceCondition>> conditions = new()
    {
        new() { Text = "Excellent", Value = ResourceCondition.Excellent },
        new() { Text = "Good", Value = ResourceCondition.Good },
        new() { Text = "Fair", Value = ResourceCondition.Fair },
        new() { Text = "Needs Repair", Value = ResourceCondition.NeedsRepair },
        new() { Text = "Out of Service", Value = ResourceCondition.OutOfService }
    };

    protected override void OnInitialized()
    {
        if (Resource != null)
        {
            isEditMode = true;
            model = Resource;
        }
        else
        {
            model = new Resource
            {
                UserId = UserId,
                IsAvailable = true,
                Quantity = 1,
                ResourceType = ResourceType.Equipment,
                Condition = ResourceCondition.Good
            };
        }
    }

    private async Task Save()
    {
        try
        {
            // Validate
            if (string.IsNullOrWhiteSpace(model.Name))
            {
                NotificationService.Notify(NotificationSeverity.Error, "Validation Error", "Resource name is required");
                return;
            }

            if (model.Quantity < 1)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Validation Error", "Quantity must be at least 1");
                return;
            }

            // Check for duplicate name
            var nameExists = await ResourceRepository.ResourceExistsAsync(model.Name, UserId, isEditMode ? model.Id : null);
            if (nameExists)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Validation Error",
                    $"A resource with the name '{model.Name}' already exists");
                return;
            }

            if (isEditMode)
            {
                await ResourceRepository.UpdateAsync(model);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Resource updated successfully");
            }
            else
            {
                await ResourceRepository.CreateAsync(model);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Resource created successfully");
            }

            DialogService.Close(model);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving resource");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to save resource");
        }
    }

    private void Cancel()
    {
        DialogService.Close(null);
    }
}
