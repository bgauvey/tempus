@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Tempus.Core.Interfaces
@using Tempus.Core.Models
@using Tempus.Core.Enums
@using Tempus.Core.Helpers
@using Tempus.Web.Components.Account
@inject IEventRepository EventRepository
@inject ICalendarRepository CalendarRepository
@inject IContactRepository ContactRepository
@inject IAttachmentService AttachmentService
@inject IVideoConferenceService VideoConferenceService
@inject ITimeZoneConversionService TimeZoneService
@inject ISettingsService SettingsService
@inject DialogService DialogService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IdentityUserAccessor IdentityUserAccessor
@inject NotificationService NotificationService
@inject IRoomBookingService RoomBookingService
@inject IResourceReservationService ResourceReservationService
@inject IRoomRepository RoomRepository
@inject IResourceRepository ResourceRepository
@inject ILogger<EventFormDialog> Logger

<style>
    .event-form-container {
        max-height: calc(80vh - 120px);
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    .event-form-section {
        margin-bottom: 1rem;
    }

    .event-form-always-visible {
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
</style>

<RadzenStack Gap="1rem">
    <div class="event-form-container">
        <!-- ALWAYS VISIBLE SECTION -->
        <div class="event-form-always-visible">
            <RadzenStack Gap="1rem">
                <RadzenFormField Text="Title" Variant="Variant.Outlined">
                    <RadzenTextBox @bind-Value="@_event.Title" Style="width: 100%;" />
                </RadzenFormField>

                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="@(IsAllDay ? "Start Date" : "Start Date/Time")" Variant="Variant.Outlined">
                            <RadzenDatePicker @bind-Value="@StartTime" ShowTime="@(!IsAllDay)"
                                            DateFormat="@(IsAllDay ? "MM/dd/yyyy" : DateTimeFormatString)"
                                            HourFormat="@HourFormat"
                                            Style="width: 100%;" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="@(IsAllDay ? "End Date" : "End Date/Time")" Variant="Variant.Outlined">
                            <RadzenDatePicker @bind-Value="@EndTime" ShowTime="@(!IsAllDay)"
                                            DateFormat="@(IsAllDay ? "MM/dd/yyyy" : DateTimeFormatString)"
                                            HourFormat="@HourFormat"
                                            Style="width: 100%;" />
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenFormField Text="Calendar" Variant="Variant.Outlined">
                    <RadzenDropDown @bind-Value="@_selectedCalendarId"
                                    Data="@_calendars"
                                    TextProperty="Name"
                                    ValueProperty="Id"
                                    Style="width: 100%;"
                                    Placeholder="Select a calendar..." />
                </RadzenFormField>

                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenCheckBox @bind-Value="@IsAllDay" />
                    <RadzenLabel Text="All Day Event" Style="margin: 0; cursor: pointer;" />
                </RadzenStack>
            </RadzenStack>
        </div>

        <!-- EVENT DETAILS SECTION -->
        <RadzenExpander class="event-form-section" Expanded="@_eventDetailsExpanded">
            <HeaderTemplate>
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenIcon Icon="event" />
                    <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-weight: 600;">Event Details</RadzenText>
                </RadzenStack>
            </HeaderTemplate>
            <ChildContent>
                <RadzenStack Gap="1rem" Style="padding: 1rem;">
                    <RadzenRow Gap="1rem">
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Event Type" Variant="Variant.Outlined">
                                <RadzenDropDown @bind-Value="@_event.EventType" Data="@_eventTypes"
                                              Change="@OnEventTypeChanged"
                                              Style="width: 100%;" />
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Priority" Variant="Variant.Outlined">
                                <RadzenDropDown @bind-Value="@_event.Priority" Data="@_priorities"
                                              Style="width: 100%;" />
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>

                    <RadzenFormField Text="Location" Variant="Variant.Outlined">
                        <RadzenTextBox @bind-Value="@_event.Location" Style="width: 100%;" />
                    </RadzenFormField>

                    <RadzenFormField Text="Description" Variant="Variant.Outlined">
                        <RadzenTextArea @bind-Value="@_event.Description" Style="width: 100%;" Rows="3" />
                    </RadzenFormField>

                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenLabel Text="Color" Style="margin: 0; min-width: 80px;" />
                        <RadzenColorPicker @bind-Value="@_event.Color" />
                    </RadzenStack>

                    <RadzenFormField Text="Time Zone" Variant="Variant.Outlined">
                        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                            <div style="flex: 1; min-width: 0;">
                                <RadzenDropDown @bind-Value="@SelectedTimeZoneId"
                                              Data="@_availableTimeZones"
                                              TextProperty="DisplayName"
                                              ValueProperty="Id"
                                              FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                              AllowFiltering="true"
                                              Placeholder="Select timezone..."
                                              Style="width: 100%;" />
                            </div>
                            <RadzenButton Icon="refresh"
                                        ButtonStyle="ButtonStyle.Light"
                                        Size="ButtonSize.Small"
                                        Click="@ResetToUserTimeZone"
                                        title="Reset to your timezone"
                                        Style="flex-shrink: 0;" />
                        </div>
                        <RadzenText TextStyle="TextStyle.Caption" Style="color: #718096; margin-top: 0.5rem; display: block;">
                            <RadzenIcon Icon="info" Style="font-size: 0.875rem; vertical-align: middle;" />
                            Set timezone for multi-location meetings. Current: @GetTimeZoneAbbreviation()
                        </RadzenText>
                    </RadzenFormField>
                </RadzenStack>
            </ChildContent>
        </RadzenExpander>

        <!-- MEETING DETAILS SECTION (Conditional) -->
        @if (_event.EventType == EventType.Meeting)
        {
            <RadzenExpander class="event-form-section" Expanded="@_meetingDetailsExpanded">
                <HeaderTemplate>
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="groups" />
                        <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-weight: 600;">Meeting Details</RadzenText>
                    </RadzenStack>
                </HeaderTemplate>
                <ChildContent>
                    <RadzenStack Gap="1rem" Style="padding: 1rem;">
                        <!-- Attendees Section -->
                        <RadzenFieldset Text="Attendees">
                            <RadzenStack Gap="1rem">
                                @if (_event.Attendees.Any())
                                {
                                    <div style="max-height: 200px; overflow-y: auto;">
                                        @foreach (var attendee in _event.Attendees)
                                        {
                                            <RadzenCard Style="padding: 0.75rem; margin-bottom: 0.5rem;">
                                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                                    <RadzenStack Gap="0.25rem">
                                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                            <RadzenText TextStyle="TextStyle.Body1" Style="font-weight: 600;">@attendee.Name</RadzenText>
                                                            @if (attendee.IsOrganizer)
                                                            {
                                                                <RadzenBadge Text="Organizer" BadgeStyle="BadgeStyle.Info" Variant="Variant.Filled" />
                                                            }
                                                        </RadzenStack>
                                                        <RadzenText TextStyle="TextStyle.Body2" Style="color: #718096;">@attendee.Email</RadzenText>
                                                    </RadzenStack>
                                                    @if (!attendee.IsOrganizer)
                                                    {
                                                        <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                                                                    Click="@(() => RemoveAttendee(attendee))" />
                                                    }
                                                </RadzenStack>
                                            </RadzenCard>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <RadzenText TextStyle="TextStyle.Body2" Style="color: #718096; font-style: italic;">No attendees added yet</RadzenText>
                                }

                                <RadzenRow Gap="1rem">
                                    <RadzenColumn Size="12">
                                        <RadzenFormField Text="Search Contacts" Variant="Variant.Outlined">
                                            <RadzenAutoComplete @bind-Value="@_selectedContactEmail"
                                                              Data="@_contacts"
                                                              TextProperty="Email"
                                                              ValueProperty="Email"
                                                              Change="@OnContactSelected"
                                                              Placeholder="Type to search contacts or enter new email..."
                                                              Style="width: 100%;"
                                                              FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                                              AllowCustomValues="true" />
                                        </RadzenFormField>
                                        @if (!string.IsNullOrWhiteSpace(_selectedContactEmail))
                                        {
                                            <RadzenText TextStyle="TextStyle.Caption" Style="color: #718096; margin-top: 0.5rem;">
                                                @if (_contacts.Any(c => c.Email.Equals(_selectedContactEmail, StringComparison.OrdinalIgnoreCase)))
                                                {
                                                    <span>✓ Contact found in address book</span>
                                                }
                                                else if (IsValidEmail(_selectedContactEmail))
                                                {
                                                    <span>⊕ New contact - will be added to address book</span>
                                                }
                                            </RadzenText>
                                        }
                                    </RadzenColumn>
                                </RadzenRow>
                                <RadzenRow Gap="1rem" Style="margin-top: 0.5rem;">
                                    <RadzenColumn Size="12" SizeMD="10">
                                        <RadzenFormField Text="Name (for new contacts)" Variant="Variant.Outlined">
                                            <RadzenTextBox @bind-Value="@_newAttendeeName" Placeholder="Enter name" Style="width: 100%;"
                                                         Disabled="@(_selectedContact != null)" />
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="2" Style="display: flex; align-items: flex-end;">
                                        <RadzenButton Icon="add" Text="Add" ButtonStyle="ButtonStyle.Success"
                                                    Click="AddAttendee" Disabled="@(!CanAddAttendee())" Style="width: 100%;" />
                                    </RadzenColumn>
                                </RadzenRow>
                            </RadzenStack>
                        </RadzenFieldset>

                        <!-- RSVP Configuration Section -->
                        <RadzenFieldset Text="RSVP Settings">
                            <RadzenStack Gap="1rem">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                    <RadzenCheckBox @bind-Value="@_event.RequireRSVP" Name="requireRsvp" />
                                    <RadzenLabel Text="Require RSVP from attendees" Component="requireRsvp" Style="cursor: pointer;" />
                                </RadzenStack>

                                @if (_event.RequireRSVP)
                                {
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="RSVP Deadline (optional)" Variant="@Variant.Outlined">
                                                <RadzenDatePicker @bind-Value="@_event.RSVPDeadline"
                                                                ShowTime="true"
                                                                DateFormat="MM/dd/yyyy"
                                                                TimeFormat="h:mm tt"
                                                                Style="width: 100%;"
                                                                Name="rsvpDeadline"
                                                                Placeholder="No deadline" />
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Guest List Visibility" Variant="@Variant.Outlined">
                                                <RadzenDropDown @bind-Value="@_event.GuestListVisibility"
                                                              Data="@_guestListVisibilityOptions"
                                                              Style="width: 100%;"
                                                              Name="guestListVisibility" />
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                        <RadzenCheckBox @bind-Value="@_event.AllowProposedTimes" Name="allowProposedTimes" />
                                        <RadzenLabel Text="Allow attendees to propose alternative times" Component="allowProposedTimes" Style="cursor: pointer;" />
                                    </RadzenStack>

                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                        <RadzenCheckBox @bind-Value="@_event.SendReminderToNonResponders" Name="sendReminder" />
                                        <RadzenLabel Text="Send reminders to non-responders" Component="sendReminder" Style="cursor: pointer;" />
                                    </RadzenStack>

                                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" Variant="Variant.Flat">
                                        <RadzenText TextStyle="TextStyle.Caption">
                                            Attendees will receive an invitation email and can respond with Accept, Decline, or Tentative.
                                        </RadzenText>
                                    </RadzenAlert>
                                }
                            </RadzenStack>
                        </RadzenFieldset>

                        <!-- Meeting Cost Calculator -->
                        <RadzenFieldset Text="Meeting Cost Calculator">
                            <RadzenStack Gap="1rem">
                                <RadzenRow Gap="1rem">
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Hourly Cost Per Attendee" Variant="Variant.Outlined">
                                            <RadzenNumeric @bind-Value="@_event.HourlyCostPerAttendee"
                                                         Min="0"
                                                         Step="5"
                                                         Format="c"
                                                         Style="width: 100%;" />
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <div style="padding: 1rem; background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-radius: 8px; border: 1px solid #667eea30;">
                                            <RadzenStack Gap="0.5rem">
                                                <RadzenText TextStyle="TextStyle.Caption" Style="color: #718096; font-weight: 600;">ESTIMATED MEETING COST</RadzenText>
                                                <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 800;">
                                                    @CalculateMeetingCost().ToString("C")
                                                </RadzenText>
                                                <RadzenText TextStyle="TextStyle.Caption" Style="color: #718096;">
                                                    @_event.Attendees.Count attendee(s) × @GetMeetingDuration().ToString("0.##") hour(s)
                                                </RadzenText>
                                            </RadzenStack>
                                        </div>
                                    </RadzenColumn>
                                </RadzenRow>
                                <div style="padding: 0.75rem; background: #f8f9fa; border-radius: 8px; font-size: 0.85rem; color: #718096;">
                                    <RadzenIcon Icon="info" Style="font-size: 1rem; vertical-align: middle; margin-right: 0.25rem;" />
                                    <strong>Note:</strong> This cost will be saved and used for monthly meeting analysis reports.
                                </div>
                            </RadzenStack>
                        </RadzenFieldset>
                    </RadzenStack>
                </ChildContent>
            </RadzenExpander>
        }

        <!-- RECURRENCE SECTION (hidden when editing single occurrence) -->
        @if (!EditSingleOccurrence)
        {
            <RadzenExpander class="event-form-section" Expanded="@_recurrenceExpanded">
                <HeaderTemplate>
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="repeat" />
                        <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-weight: 600;">Repeat</RadzenText>
                    </RadzenStack>
                </HeaderTemplate>
                <ChildContent>
                    <RadzenStack Gap="1rem" Style="padding: 1rem;">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                            <RadzenCheckBox @bind-Value="@_event.IsRecurring" />
                            <RadzenLabel Text="Recurring Event" Style="margin: 0; cursor: pointer;" />
                        </RadzenStack>

                        @if (_event.IsRecurring)
                        {
                            <RadzenRow Gap="1rem">
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Pattern" Variant="Variant.Outlined">
                                        <RadzenDropDown @bind-Value="@_event.RecurrencePattern" Data="@_recurrencePatterns"
                                                      Style="width: 100%;" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Every" Variant="Variant.Outlined">
                                        <RadzenNumeric @bind-Value="@_event.RecurrenceInterval" Min="1" Max="99"
                                                     Style="width: 100%;" />
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>

                            @if (_event.RecurrencePattern == RecurrencePattern.Weekly)
                            {
                                <RadzenFormField Text="Repeat On" Variant="Variant.Outlined">
                                    <RadzenCheckBoxList @bind-Value="@_selectedDaysOfWeek" TValue="int"
                                                      Orientation="Orientation.Horizontal"
                                                      Data="@_daysOfWeek" TextProperty="Text" ValueProperty="Value" />
                                </RadzenFormField>
                            }

                            <RadzenFormField Text="Ends" Variant="Variant.Outlined">
                                <RadzenDropDown @bind-Value="@_event.RecurrenceEndType" Data="@_recurrenceEndTypes"
                                              Style="width: 100%;" />
                            </RadzenFormField>

                            @if (_event.RecurrenceEndType == RecurrenceEndType.AfterOccurrences)
                            {
                                <RadzenFormField Text="Number of Occurrences" Variant="Variant.Outlined">
                                    <RadzenNumeric @bind-Value="@_event.RecurrenceCount" Min="1" Max="999"
                                                 Style="width: 100%;" />
                                </RadzenFormField>
                            }
                            else if (_event.RecurrenceEndType == RecurrenceEndType.OnDate)
                            {
                                <RadzenFormField Text="End Date" Variant="Variant.Outlined">
                                    <RadzenDatePicker @bind-Value="@_event.RecurrenceEndDate" Style="width: 100%;" />
                                </RadzenFormField>
                            }

                            <div style="padding: 0.75rem; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem;">
                                <strong>Summary:</strong> @GetRecurrenceSummary()
                            </div>
                        }
                    </RadzenStack>
                </ChildContent>
            </RadzenExpander>
        }

        <!-- REMINDERS SECTION -->
        <RadzenExpander class="event-form-section" Expanded="@_remindersExpanded">
            <HeaderTemplate>
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenIcon Icon="notifications" />
                    <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-weight: 600;">Reminders</RadzenText>
                </RadzenStack>
            </HeaderTemplate>
            <ChildContent>
                <RadzenStack Gap="1rem" Style="padding: 1rem;">
                    <RadzenText TextStyle="TextStyle.Body1" Style="margin-bottom: 0.5rem;">
                        Choose when you want to be reminded about this event
                    </RadzenText>

                    <RadzenFormField Text="Reminder Times" Variant="Variant.Outlined">
                        <RadzenCheckBoxList @bind-Value="@_selectedReminders"
                                            TValue="int"
                                            Orientation="Orientation.Vertical"
                                            Data="@_reminderOptions"
                                            TextProperty="Text"
                                            ValueProperty="Value" />
                    </RadzenFormField>

                    @if (_selectedReminders != null && _selectedReminders.Any())
                    {
                        <div style="padding: 0.75rem; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem;">
                            <RadzenIcon Icon="notifications_active" Style="font-size: 1rem; vertical-align: middle; margin-right: 0.25rem;" />
                            <strong>Active Reminders:</strong>
                            <div style="margin-top: 0.5rem;">
                                @foreach (var minutes in _selectedReminders.OrderBy(m => m))
                                {
                                    <div style="margin-left: 1.5rem; color: #718096;">
                                        • @GetReminderDescription(minutes) before event start
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <div style="padding: 0.75rem; background: #fff3cd; border-radius: 8px; font-size: 0.9rem; color: #856404;">
                            <RadzenIcon Icon="notifications_off" Style="font-size: 1rem; vertical-align: middle; margin-right: 0.25rem;" />
                            No reminders set. You won't receive notifications for this event.
                        </div>
                    }

                    <div style="padding: 0.75rem; background: #e7f3ff; border-radius: 8px; font-size: 0.85rem; color: #0c5394; margin-top: 1rem;">
                        <RadzenIcon Icon="info" Style="font-size: 1rem; vertical-align: middle; margin-right: 0.25rem;" />
                        <strong>Note:</strong> Notifications will be delivered via browser push notifications. Make sure your browser has notification permissions enabled.
                    </div>
                </RadzenStack>
            </ChildContent>
        </RadzenExpander>

        <!-- ATTACHMENTS SECTION -->
        <RadzenExpander class="event-form-section" Expanded="@_attachmentsExpanded">
            <HeaderTemplate>
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenIcon Icon="attach_file" />
                    <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-weight: 600;">Attachments</RadzenText>
                </RadzenStack>
            </HeaderTemplate>
            <ChildContent>
                <RadzenStack Gap="1rem" Style="padding: 1rem;">
                    <EventAttachmentsManager EventId="@EventId"
                                           Attachments="@_attachments"
                                           OnAttachmentsChanged="@OnAttachmentsChanged"
                                           UserId="@_userId" />
                </RadzenStack>
            </ChildContent>
        </RadzenExpander>

        <!-- VIDEO CONFERENCE SECTION -->
        <RadzenExpander class="event-form-section" Expanded="@_videoExpanded">
            <HeaderTemplate>
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenIcon Icon="videocam" />
                    <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-weight: 600;">Video Conference</RadzenText>
                </RadzenStack>
            </HeaderTemplate>
            <ChildContent>
                <RadzenStack Gap="1rem" Style="padding: 1rem;">
                    <VideoConferenceManager EventId="@EventId"
                                          VideoConference="@_videoConference"
                                          OnVideoConferenceChanged="@OnVideoConferenceChanged"
                                          UserId="@_userId" />
                </RadzenStack>
            </ChildContent>
        </RadzenExpander>

        <!-- ROOMS & RESOURCES SECTION -->
        <RadzenExpander class="event-form-section" Expanded="@_roomsExpanded">
            <HeaderTemplate>
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenIcon Icon="meeting_room" />
                    <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-weight: 600;">Rooms & Resources</RadzenText>
                </RadzenStack>
            </HeaderTemplate>
            <ChildContent>
                <RadzenStack Gap="1rem" Style="padding: 1rem;">
                    <!-- Room Booking Section -->
                    <RadzenFieldset Text="Conference Room">
                        <RadzenStack Gap="1rem">
                            @if (_bookedRoom != null)
                            {
                                <RadzenCard Style="background: #f0fdf4; border: 1px solid #86efac;">
                                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                        <RadzenStack Gap="0.5rem">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                <RadzenIcon Icon="meeting_room" Style="color: #16a34a;" />
                                                <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-weight: 600;">@_bookedRoom.Name</RadzenText>
                                                <RadzenBadge Text="Booked" BadgeStyle="BadgeStyle.Success" />
                                            </RadzenStack>
                                            @if (!string.IsNullOrEmpty(_bookedRoom.Location))
                                            {
                                                <RadzenText TextStyle="TextStyle.Body2" Style="color: #15803d;">
                                                    <RadzenIcon Icon="location_on" Style="font-size: 0.875rem;" /> @_bookedRoom.Location
                                                </RadzenText>
                                            }
                                        </RadzenStack>
                                        <RadzenButton Text="Change Room" Icon="swap_horiz" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small"
                                                      Click="@FindRoom" />
                                    </RadzenStack>
                                </RadzenCard>
                            }
                            else
                            {
                                <RadzenButton Text="Find Available Room" Icon="search" ButtonStyle="ButtonStyle.Primary"
                                              Click="@FindRoom" Style="width: 100%;" />
                            }
                        </RadzenStack>
                    </RadzenFieldset>

                    <!-- Resource Reservation Section -->
                    <RadzenFieldset Text="Resources & Equipment">
                        <RadzenStack Gap="1rem">
                            @if (_reservedResources.Any())
                            {
                                <RadzenStack Gap="0.5rem">
                                    @foreach (var reservation in _reservedResources)
                                    {
                                        var resource = _allResources.FirstOrDefault(r => r.Id == reservation.ResourceId);
                                        if (resource != null)
                                        {
                                            <RadzenCard Style="background: #eff6ff; border: 1px solid #93c5fd; padding: 0.75rem;">
                                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                        <RadzenIcon Icon="@GetResourceIcon(resource.ResourceType)" Style="color: #2563eb;" />
                                                        <RadzenText TextStyle="TextStyle.Body1" Style="font-weight: 600;">@resource.Name</RadzenText>
                                                        <RadzenBadge Text="@($"Qty: {reservation.QuantityReserved}")" BadgeStyle="BadgeStyle.Info" />
                                                    </RadzenStack>
                                                    <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                                                                  Click="@(() => RemoveResourceReservation(reservation))" />
                                                </RadzenStack>
                                            </RadzenCard>
                                        }
                                    }
                                </RadzenStack>
                            }
                            else
                            {
                                <RadzenText TextStyle="TextStyle.Body2" Style="color: #718096; font-style: italic;">No resources reserved</RadzenText>
                            }

                            <RadzenButton Text="Add Resources" Icon="add" ButtonStyle="ButtonStyle.Success"
                                          Click="@AddResources" Style="width: 100%;" />
                        </RadzenStack>
                    </RadzenFieldset>

                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" Variant="Variant.Flat">
                        <RadzenText TextStyle="TextStyle.Caption">
                            Room and resource bookings are checked for availability based on the event start and end times.
                            Make sure to set your event times before booking.
                        </RadzenText>
                    </RadzenAlert>
                </RadzenStack>
            </ChildContent>
        </RadzenExpander>
    </div>

    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End" Style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
        <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="Cancel" />
        <RadzenButton Text="@(GetSaveButtonText())" ButtonStyle="ButtonStyle.Primary"
                    Click="Save" Disabled="@(!IsValid())" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter]
    public Guid? EventId { get; set; }

    [Parameter]
    public DateTime? PrefilledDate { get; set; }

    [Parameter]
    public bool EditSingleOccurrence { get; set; }

    [Parameter]
    public Event? InstanceEvent { get; set; }

    private Event _event = new Event
    {
        Title = string.Empty,
        StartTime = DateTime.Now,
        EndTime = DateTime.Now.AddHours(1),
        EventType = EventType.Meeting,
        Priority = Priority.Medium,
        Color = "#1E88E5", // Default blue for meetings
        Attendees = new List<Attendee>(),
        Tags = new List<string>()
    };

    private readonly EventType[] _eventTypes = Enum.GetValues<EventType>();
    private readonly Priority[] _priorities = Enum.GetValues<Priority>();
    private readonly RecurrencePattern[] _recurrencePatterns = Enum.GetValues<RecurrencePattern>();
    private readonly RecurrenceEndType[] _recurrenceEndTypes = Enum.GetValues<RecurrenceEndType>();
    private readonly GuestListVisibility[] _guestListVisibilityOptions = Enum.GetValues<GuestListVisibility>();
    private string _userId = string.Empty;
    private string _userEmail = string.Empty;
    private string _userName = string.Empty;
    private string _userTimeZone = TimeZoneInfo.Local.Id;
    private CalendarSettings? _settings;

    // Computed property for time format based on user settings
    private string TimeFormatString => _settings?.TimeFormat == TimeFormat.TwentyFourHour ? "HH:mm" : "hh:mm tt";
    private string DateTimeFormatString => _settings?.TimeFormat == TimeFormat.TwentyFourHour ? "MM/dd/yyyy HH:mm" : "MM/dd/yyyy hh:mm tt";
    private string HourFormat => _settings?.TimeFormat == TimeFormat.TwentyFourHour ? "24" : "12";

    // Calendar management
    private List<Calendar> _calendars = new();
    private Guid? _selectedCalendarId;

    // Timezone management
    private List<TimeZoneOption> _availableTimeZones = new();

    // Attendee management
    private string _newAttendeeName = string.Empty;
    private string _selectedContactEmail = string.Empty;
    private List<Tempus.Core.Models.Contact> _contacts = new();
    private Tempus.Core.Models.Contact? _selectedContact = null;

    // Track if end time has been manually set
    private bool _endTimeManuallySet = false;
    // Track the duration for existing events
    private TimeSpan _eventDuration = TimeSpan.FromMinutes(30);
    // Track if this is an existing event
    private bool _isExistingEvent = false;

    // Start time property with automatic end time adjustment
    private DateTime StartTime
    {
        get => _event.StartTime;
        set
        {
            _event.StartTime = value;

            if (!_endTimeManuallySet)
            {
                if (_isExistingEvent)
                {
                    // For existing events, maintain the duration
                    _event.EndTime = value.Add(_eventDuration);
                }
                else
                {
                    // For new events, use default 30 minutes
                    _event.EndTime = value.AddMinutes(30);
                }
            }
        }
    }

    // End time property to track manual changes
    private DateTime EndTime
    {
        get => _event.EndTime;
        set
        {
            _event.EndTime = value;
            _endTimeManuallySet = true;
            // Update the duration when manually set
            _eventDuration = _event.EndTime - _event.StartTime;
        }
    }

    // All day property to handle midnight time setting
    private bool IsAllDay
    {
        get => _event.IsAllDay;
        set
        {
            _event.IsAllDay = value;
            if (value)
            {
                // Set times to midnight for all-day events
                _event.StartTime = _event.StartTime.Date;
                _event.EndTime = _event.EndTime.Date;
            }
        }
    }

    private IEnumerable<int> _selectedDaysOfWeek
    {
        get
        {
            if (string.IsNullOrEmpty(_event.RecurrenceDaysOfWeek))
                return new List<int>();

            return _event.RecurrenceDaysOfWeek.Split(',')
                .Select(d => int.TryParse(d.Trim(), out var day) ? day : -1)
                .Where(d => d >= 0);
        }
        set
        {
            _event.RecurrenceDaysOfWeek = value != null && value.Any()
                ? string.Join(",", value.OrderBy(d => d))
                : null;
        }
    }

    // Reminder management
    private IEnumerable<int> _selectedReminders = new List<int>();
    private readonly List<ReminderOption> _reminderOptions = new()
    {
        new ReminderOption { Text = "1 minute before", Value = 1 },
        new ReminderOption { Text = "5 minutes before", Value = 5 },
        new ReminderOption { Text = "15 minutes before", Value = 15 },
        new ReminderOption { Text = "30 minutes before", Value = 30 },
        new ReminderOption { Text = "1 hour before", Value = 60 },
        new ReminderOption { Text = "2 hours before", Value = 120 },
        new ReminderOption { Text = "1 day before", Value = 1440 },
        new ReminderOption { Text = "2 days before", Value = 2880 },
        new ReminderOption { Text = "1 week before", Value = 10080 }
    };

    // Attachment management
    private List<EventAttachment> _attachments = new();

    // Video conference management
    private VideoConference? _videoConference = null;

    private readonly List<DayOfWeekOption> _daysOfWeek = new()
    {
        new DayOfWeekOption { Text = "Sun", Value = 0 },
        new DayOfWeekOption { Text = "Mon", Value = 1 },
        new DayOfWeekOption { Text = "Tue", Value = 2 },
        new DayOfWeekOption { Text = "Wed", Value = 3 },
        new DayOfWeekOption { Text = "Thu", Value = 4 },
        new DayOfWeekOption { Text = "Fri", Value = 5 },
        new DayOfWeekOption { Text = "Sat", Value = 6 }
    };

    private class DayOfWeekOption
    {
        public string Text { get; set; } = string.Empty;
        public int Value { get; set; }
    }

    private class TimeZoneOption
    {
        public string Id { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
    }

    private class ReminderOption
    {
        public string Text { get; set; } = string.Empty;
        public int Value { get; set; }
    }

    // Timezone property that binds to event's TimeZoneId
    private string SelectedTimeZoneId
    {
        get => _event.TimeZoneId ?? _userTimeZone;
        set => _event.TimeZoneId = value;
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            var appUser = await IdentityUserAccessor.GetUserAsync(user);
            if (appUser != null)
            {
                _userId = appUser.Id;
                _userEmail = appUser.Email ?? string.Empty;

                // Get timezone from user settings, or fallback to system timezone
                _userTimeZone = !string.IsNullOrEmpty(appUser.TimeZone)
                    ? appUser.TimeZone
                    : TimeZoneInfo.Local.Id;

                Logger.LogDebug("User timezone: {TimeZone}", _userTimeZone);

                // Load user's calendar settings for time format preference
                _settings = await SettingsService.GetOrCreateDefaultSettingsAsync(_userId);
                Logger.LogDebug("Time format: {TimeFormat}", _settings.TimeFormat);

                // Ensure user has at least one calendar and load all calendars
                await CalendarRepository.EnsureDefaultCalendarExistsAsync(_userId, _userEmail);
                _calendars = await CalendarRepository.GetAllAsync(_userId);
                Logger.LogDebug("Loaded {CalendarCount} calendars", _calendars.Count);

                // Get user's display name from claims or use email
                var name = user.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value;
                _userName = !string.IsNullOrEmpty(name) ? name : _userEmail.Split('@')[0];
            }
        }

        // Load timezones for selection
        LoadTimeZones();

        // Load contacts for autocomplete
        _contacts = await ContactRepository.GetAllAsync(_userId);

        if (EditSingleOccurrence && InstanceEvent != null)
        {
            // Editing a single occurrence - use the instance data but don't save yet
            _event = new Event
            {
                Id = Guid.NewGuid(),
                Title = InstanceEvent.Title,
                Description = InstanceEvent.Description,
                StartTime = InstanceEvent.StartTime,
                EndTime = InstanceEvent.EndTime,
                Location = InstanceEvent.Location,
                EventType = InstanceEvent.EventType,
                Priority = InstanceEvent.Priority,
                IsAllDay = InstanceEvent.IsAllDay,
                Color = InstanceEvent.Color,
                UserId = _userId,
                IsRecurring = false,
                IsRecurrenceException = true,
                RecurrenceExceptionDate = InstanceEvent.StartTime.Date,
                RecurrenceParentId = InstanceEvent.RecurrenceParentId ?? InstanceEvent.Id,
                Tags = InstanceEvent.Tags.ToList(),
                Attendees = InstanceEvent.Attendees.Select(a => new Attendee
                {
                    Id = Guid.Empty, // Use Empty GUID since this will be a new event
                    Name = a.Name,
                    Email = a.Email,
                    IsOrganizer = a.IsOrganizer,
                    Status = a.Status
                }).ToList(),
                CreatedAt = DateTime.UtcNow,
                ReminderMinutes = InstanceEvent.ReminderMinutes, // Copy reminders from parent
                TimeZoneId = InstanceEvent.TimeZoneId
            };

            // Convert event times from UTC to user's timezone for display in form
            // The InstanceEvent may already be converted, but check if it's UTC
            if (!string.IsNullOrEmpty(_event.TimeZoneId) && _event.TimeZoneId == "UTC")
            {
                _event.StartTime = TimeZoneService.ConvertTime(_event.StartTime, "UTC", _userTimeZone);
                _event.EndTime = TimeZoneService.ConvertTime(_event.EndTime, "UTC", _userTimeZone);
                _event.TimeZoneId = _userTimeZone;
            }

            // Calculate duration from existing event
            _eventDuration = _event.EndTime - _event.StartTime;
            _isExistingEvent = true;

            // Load reminders from instance
            LoadReminders();
        }
        else if (EventId.HasValue)
        {
            // Load existing event
            var existingEvent = await EventRepository.GetByIdAsync(EventId.Value, _userId);
            if (existingEvent != null)
            {
                _event = existingEvent;

                // Convert event times from UTC to user's timezone for display in form
                if (!string.IsNullOrEmpty(_event.TimeZoneId) && _event.TimeZoneId == "UTC")
                {
                    _event.StartTime = TimeZoneService.ConvertTime(_event.StartTime, "UTC", _userTimeZone);
                    _event.EndTime = TimeZoneService.ConvertTime(_event.EndTime, "UTC", _userTimeZone);
                    // Temporarily set to user's timezone for editing
                    _event.TimeZoneId = _userTimeZone;
                }

                // Calculate duration from existing event
                _eventDuration = _event.EndTime - _event.StartTime;
                _isExistingEvent = true;

                // Set selected calendar
                _selectedCalendarId = _event.CalendarId;

                // Load existing reminders
                LoadReminders();

                // Load existing attachments
                await LoadAttachments();

                // Load existing video conference
                await LoadVideoConference();

                // Load existing room booking and resource reservations
                await LoadRoomBooking();
                await LoadResourceReservations();
            }
        }
        else
        {
            // Set userId and timezone for new event
            _event.UserId = _userId;
            // IMPORTANT: Times in the form are in user's local timezone
            // This will be converted to UTC when saving
            _event.TimeZoneId = _userTimeZone;

            Logger.LogDebug("New event - setting TimeZoneId to user timezone: {TimeZone}", _userTimeZone);

            // Set default calendar
            var defaultCalendar = _calendars.FirstOrDefault(c => c.IsDefault) ?? _calendars.FirstOrDefault();
            if (defaultCalendar != null)
            {
                _selectedCalendarId = defaultCalendar.Id;
                Logger.LogDebug("Set default calendar: {CalendarName}", defaultCalendar.Name);
            }

            if (PrefilledDate.HasValue)
            {
                // Set start and end times based on prefilled date
                _event.StartTime = PrefilledDate.Value.Date.AddHours(9); // 9 AM
                _event.EndTime = PrefilledDate.Value.Date.AddHours(9).AddMinutes(30); // 9:30 AM
            }

            // Add current user as organizer for new meetings
            if (_event.EventType == EventType.Meeting)
            {
                AddCurrentUserAsOrganizer();
            }
        }
    }

    private bool IsValid()
    {
        return !string.IsNullOrWhiteSpace(_event.Title)
            && _event.EndTime > _event.StartTime;
    }

    private async Task Save()
    {
        try
        {
            // Convert event times from user's local timezone to UTC for storage
            // The StartTime and EndTime are in the user's timezone (from the browser's DateTimePicker)
            // We need to convert them to UTC before saving to the database
            var userTimeZoneId = string.IsNullOrEmpty(_event.TimeZoneId) ? _userTimeZone : _event.TimeZoneId;

            Logger.LogDebug("Converting event '{Title}' to UTC", _event.Title);
            Logger.LogDebug("  Original StartTime: {StartTime:yyyy-MM-dd HH:mm:ss} (Kind: {Kind})", _event.StartTime, _event.StartTime.Kind);
            Logger.LogDebug("  Original EndTime: {EndTime:yyyy-MM-dd HH:mm:ss} (Kind: {Kind})", _event.EndTime, _event.EndTime.Kind);
            Logger.LogDebug("  User TimeZone: {TimeZone}", userTimeZoneId);

            // Convert StartTime and EndTime to UTC
            _event.StartTime = TimeZoneService.ConvertTime(_event.StartTime, userTimeZoneId, "UTC");
            _event.EndTime = TimeZoneService.ConvertTime(_event.EndTime, userTimeZoneId, "UTC");

            // CRITICAL: Mark the DateTime as UTC so Entity Framework and the database know it's UTC
            _event.StartTime = DateTime.SpecifyKind(_event.StartTime, DateTimeKind.Utc);
            _event.EndTime = DateTime.SpecifyKind(_event.EndTime, DateTimeKind.Utc);

            Logger.LogDebug("  Converted StartTime: {StartTime:yyyy-MM-dd HH:mm:ss} (Kind: {Kind})", _event.StartTime, _event.StartTime.Kind);
            Logger.LogDebug("  Converted EndTime: {EndTime:yyyy-MM-dd HH:mm:ss} (Kind: {Kind})", _event.EndTime, _event.EndTime.Kind);

            // Always store events in UTC timezone
            _event.TimeZoneId = "UTC";
            Logger.LogDebug("  Set TimeZoneId to: '{TimeZoneId}'", _event.TimeZoneId);

            // Set the calendar ID from the dropdown selection
            _event.CalendarId = _selectedCalendarId;
            Logger.LogDebug("  Set CalendarId to: '{CalendarId}'", _event.CalendarId);

            // Auto-create contacts for attendees not in address book
            await AutoCreateContactsForAttendeesAsync();

            // Calculate and save meeting cost for meetings
            if (_event.EventType == EventType.Meeting)
            {
                _event.MeetingCost = CalculateMeetingCost();
            }

            // Save reminder selections
            SaveReminders();

            if (EditSingleOccurrence)
            {
                // Create exception event for single occurrence edit
                _event.Id = Guid.NewGuid();
                _event.CreatedAt = DateTime.UtcNow;
                await EventRepository.CreateAsync(_event);
            }
            else if (EventId.HasValue)
            {
                // Update existing event (could be a regular event or the parent of a series)
                _event.UpdatedAt = DateTime.UtcNow;
                await EventRepository.UpdateAsync(_event);
            }
            else
            {
                // Create new event
                _event.Id = Guid.NewGuid();
                _event.CreatedAt = DateTime.UtcNow;
                await EventRepository.CreateAsync(_event);
            }

            DialogService.Close(true);
        }
        catch (Exception ex)
        {
            // Show error notification to user
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error Saving Event",
                Detail = $"An error occurred while saving the event: {ex.Message}",
                Duration = 4000
            });
            Logger.LogError(ex, "Error saving event");
        }
    }

    private async Task AutoCreateContactsForAttendeesAsync()
    {
        // Extract just the data we need to avoid any entity tracking issues
        var attendeesToProcess = _event.Attendees
            .Select(a => new { a.Email, a.Name })
            .ToList();

        foreach (var attendee in attendeesToProcess)
        {
            // Check if contact already exists in address book
            var existingContact = _contacts.FirstOrDefault(c =>
                c.Email.Equals(attendee.Email, StringComparison.OrdinalIgnoreCase));

            if (existingContact == null)
            {
                // Create new contact with IsAutoCreated flag
                var newContact = new Tempus.Core.Models.Contact
                {
                    Id = Guid.NewGuid(),
                    Name = attendee.Name,
                    Email = attendee.Email,
                    UserId = _userId,
                    IsAutoCreated = true,
                    CreatedAt = DateTime.UtcNow
                };

                await ContactRepository.CreateAsync(newContact);

                // Add to local list to avoid duplicates in same session
                _contacts.Add(newContact);
            }
        }
    }

    private string GetRecurrenceSummary()
    {
        return RecurrenceHelper.GetRecurrenceDescription(_event);
    }

    private string GetSaveButtonText()
    {
        if (EditSingleOccurrence)
            return "Update This Occurrence";
        else if (EventId.HasValue)
            return "Update";
        else
            return "Create";
    }

    private string GetReminderDescription(int minutes)
    {
        return minutes switch
        {
            1 => "1 minute",
            5 => "5 minutes",
            15 => "15 minutes",
            30 => "30 minutes",
            60 => "1 hour",
            120 => "2 hours",
            1440 => "1 day",
            2880 => "2 days",
            10080 => "1 week",
            _ => $"{minutes} minutes"
        };
    }

    private void LoadReminders()
    {
        if (!string.IsNullOrEmpty(_event.ReminderMinutes))
        {
            _selectedReminders = _event.ReminderMinutes
                .Split(',')
                .Select(s => int.TryParse(s.Trim(), out var minutes) ? minutes : 0)
                .Where(m => m > 0)
                .ToList();
        }
        else
        {
            _selectedReminders = new List<int>();
        }
    }

    private void SaveReminders()
    {
        if (_selectedReminders != null && _selectedReminders.Any())
        {
            _event.ReminderMinutes = string.Join(",", _selectedReminders.OrderBy(r => r));
        }
        else
        {
            _event.ReminderMinutes = null;
        }
    }

    private void Cancel()
    {
        DialogService.Close(false);
    }

    // Attendee management methods
    private void OnContactSelected()
    {
        if (!string.IsNullOrWhiteSpace(_selectedContactEmail))
        {
            // Find the contact in the list
            _selectedContact = _contacts.FirstOrDefault(c =>
                c.Email.Equals(_selectedContactEmail, StringComparison.OrdinalIgnoreCase));

            if (_selectedContact != null)
            {
                // Pre-fill the name from the contact
                _newAttendeeName = _selectedContact.Name;
            }
            // Don't clear the name for new contacts - let the user type it
        }
    }

    private bool CanAddAttendee()
    {
        if (string.IsNullOrWhiteSpace(_selectedContactEmail) || !IsValidEmail(_selectedContactEmail))
            return false;

        // Check if this email exists in contacts (look it up dynamically to be more robust)
        var existingContact = _contacts.FirstOrDefault(c =>
            c.Email.Equals(_selectedContactEmail, StringComparison.OrdinalIgnoreCase));

        // If it's a new contact (not in address book), name is required
        if (existingContact == null && string.IsNullOrWhiteSpace(_newAttendeeName))
            return false;

        // Check if attendee already added (including organizer)
        if (_event.Attendees.Any(a => a.Email.Equals(_selectedContactEmail, StringComparison.OrdinalIgnoreCase)))
            return false;

        return true;
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private void AddAttendee()
    {
        if (!CanAddAttendee())
            return;

        var attendeeName = _selectedContact?.Name ?? _newAttendeeName;

        var attendee = new Attendee
        {
            Id = Guid.Empty, // Use Empty GUID to indicate this is a new attendee
            Name = attendeeName,
            Email = _selectedContactEmail,
            EventId = _event.Id,
            Status = AttendeeStatus.Pending,
            IsOrganizer = false
        };

        _event.Attendees.Add(attendee);

        // Clear the input fields
        _newAttendeeName = string.Empty;
        _selectedContactEmail = string.Empty;
        _selectedContact = null;
    }

    private void RemoveAttendee(Attendee attendee)
    {
        _event.Attendees.Remove(attendee);
        StateHasChanged();
    }

    // Meeting Cost Calculator Methods
    private decimal CalculateMeetingCost()
    {
        if (_event.EventType != EventType.Meeting)
            return 0;

        var attendeeCount = _event.Attendees.Count;
        var durationHours = GetMeetingDuration();
        var hourlyRate = _event.HourlyCostPerAttendee;

        return attendeeCount * durationHours * hourlyRate;
    }

    private decimal GetMeetingDuration()
    {
        var duration = _event.EndTime - _event.StartTime;
        return (decimal)duration.TotalHours;
    }

    private void OnCostParametersChanged()
    {
        StateHasChanged();
    }

    // Auto-add organizer methods
    private void OnEventTypeChanged()
    {
        // When changing to Meeting type, add current user as organizer if not already present
        if (_event.EventType == EventType.Meeting && !_event.Attendees.Any(a => a.IsOrganizer))
        {
            AddCurrentUserAsOrganizer();
        }
        StateHasChanged();
    }

    private void AddCurrentUserAsOrganizer()
    {
        // Check if current user is already in attendees
        if (_event.Attendees.Any(a => a.Email.Equals(_userEmail, StringComparison.OrdinalIgnoreCase)))
            return;

        if (string.IsNullOrEmpty(_userEmail))
            return;

        var organizer = new Attendee
        {
            Id = Guid.Empty, // Use Empty GUID to indicate this is a new attendee
            Name = _userName,
            Email = _userEmail,
            EventId = _event.Id,
            Status = AttendeeStatus.Accepted,
            IsOrganizer = true
        };

        _event.Attendees.Insert(0, organizer); // Insert at the beginning so organizer is always first
    }

    // Timezone management methods
    private void LoadTimeZones()
    {
        // Get all available timezones from the service
        var allTimeZones = TimeZoneService.GetAvailableTimeZones();

        // Get common timezones for quick access
        var commonTimeZones = TimeZoneService.GetCommonTimeZones();

        // Create option list with common zones first, then separator, then all zones
        _availableTimeZones = new List<TimeZoneOption>();

        // Add common timezones
        _availableTimeZones.Add(new TimeZoneOption
        {
            Id = "",
            DisplayName = "─── Common Timezones ───"
        });

        foreach (var tz in commonTimeZones)
        {
            _availableTimeZones.Add(new TimeZoneOption
            {
                Id = tz.Id,
                DisplayName = $"{tz.DisplayName} (UTC{tz.BaseUtcOffset:hh\\:mm})"
            });
        }

        // Add separator
        _availableTimeZones.Add(new TimeZoneOption
        {
            Id = "",
            DisplayName = "─── All Timezones ───"
        });

        // Add all timezones
        foreach (var tz in allTimeZones)
        {
            // Skip if already in common list
            if (commonTimeZones.Any(c => c.Id == tz.Id))
                continue;

            _availableTimeZones.Add(new TimeZoneOption
            {
                Id = tz.Id,
                DisplayName = $"{tz.DisplayName} (UTC{tz.BaseUtcOffset:hh\\:mm})"
            });
        }
    }

    private void ResetToUserTimeZone()
    {
        _event.TimeZoneId = _userTimeZone;
        StateHasChanged();
    }

    private string GetTimeZoneAbbreviation()
    {
        try
        {
            var tzId = _event.TimeZoneId ?? _userTimeZone;
            var tz = TimeZoneInfo.FindSystemTimeZoneById(tzId);

            // Get the abbreviation (e.g., PST, EST, UTC)
            var abbreviation = tz.IsDaylightSavingTime(DateTime.Now)
                ? tz.DaylightName
                : tz.StandardName;

            // Try to get a shorter abbreviation
            if (abbreviation.Contains("Standard") || abbreviation.Contains("Daylight"))
            {
                var words = abbreviation.Split(' ');
                if (words.Length > 1)
                {
                    abbreviation = string.Join("", words.Select(w => w.First()));
                }
            }

            return abbreviation;
        }
        catch
        {
            return "UTC";
        }
    }

    // Attachment management methods
    private void OnAttachmentsChanged(List<EventAttachment> attachments)
    {
        _attachments = attachments;
        StateHasChanged();
    }

    private async Task LoadAttachments()
    {
        try
        {
            if (EventId.HasValue)
            {
                _attachments = await AttachmentService.GetAttachmentsForEventAsync(EventId.Value);
                Logger.LogDebug("Loaded {AttachmentCount} attachments for event {EventId}", _attachments.Count, EventId.Value);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading attachments for event {EventId}", EventId);
            _attachments = new List<EventAttachment>();
        }
    }

    private void OnVideoConferenceChanged(VideoConference? videoConference)
    {
        _videoConference = videoConference;
        StateHasChanged();
    }

    private async Task LoadVideoConference()
    {
        try
        {
            if (EventId.HasValue)
            {
                _videoConference = await VideoConferenceService.GetVideoConferenceAsync(EventId.Value);
                Logger.LogDebug("Loaded video conference for event {EventId}", EventId.Value);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading video conference for event {EventId}", EventId);
            _videoConference = null;
        }
    }

    // Room and Resource Booking
    private Room? _bookedRoom = null;
    private Guid? _roomBookingId = null;
    private List<ResourceReservation> _reservedResources = new();
    private List<Resource> _allResources = new();

    // Expander state variables
    private bool _eventDetailsExpanded = true;
    private bool _meetingDetailsExpanded = true;
    private bool _recurrenceExpanded = true;
    private bool _remindersExpanded = true;
    private bool _attachmentsExpanded = true;
    private bool _videoExpanded = true;
    private bool _roomsExpanded = true;

    private async Task FindRoom()
    {
        if (_event.StartTime == default || _event.EndTime == default)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Set Event Times",
                "Please set event start and end times before booking a room");
            return;
        }

        // If we already have an event ID, we can book directly
        // Otherwise, we'll need to save the event first
        if (EventId.HasValue)
        {
            var result = await DialogService.OpenAsync<Tempus.Web.Components.Dialogs.Rooms.RoomFinderDialog>(
                "Find Available Room",
                new Dictionary<string, object>
                {
                    { "EventId", EventId.Value },
                    { "UserId", _userId },
                    { "InitialStartTime", _event.StartTime },
                    { "InitialEndTime", _event.EndTime }
                },
                new DialogOptions { Width = "900px", Height = "80vh", Resizable = true, Draggable = true });

            if (result is Room room)
            {
                _bookedRoom = room;
                await LoadRoomBooking();
            }
        }
        else
        {
            NotificationService.Notify(NotificationSeverity.Info, "Save Event First",
                "Please save the event before booking a room");
        }
    }

    private async Task AddResources()
    {
        if (_event.StartTime == default || _event.EndTime == default)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Set Event Times",
                "Please set event start and end times before reserving resources");
            return;
        }

        if (!EventId.HasValue)
        {
            NotificationService.Notify(NotificationSeverity.Info, "Save Event First",
                "Please save the event before reserving resources");
            return;
        }

        // Open resource selection dialog
        var result = await DialogService.OpenAsync<Tempus.Web.Components.Dialogs.Rooms.RoomFinderDialog>(
            "Reserve Resources",
            new Dictionary<string, object>
            {
                { "EventId", EventId.Value },
                { "UserId", _userId },
                { "InitialStartTime", _event.StartTime },
                { "InitialEndTime", _event.EndTime }
            },
            new DialogOptions { Width = "900px", Height = "80vh", Resizable = true, Draggable = true });

        await LoadResourceReservations();
    }

    private async Task RemoveResourceReservation(ResourceReservation reservation)
    {
        var confirmed = await DialogService.Confirm(
            "Are you sure you want to remove this resource reservation?",
            "Remove Resource",
            new ConfirmOptions { OkButtonText = "Remove", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            try
            {
                await ResourceReservationService.CancelReservationAsync(reservation.Id);
                _reservedResources.Remove(reservation);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Resource reservation removed");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error removing resource reservation");
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to remove resource reservation");
            }
        }
    }

    private async Task LoadRoomBooking()
    {
        try
        {
            if (EventId.HasValue)
            {
                var bookings = await RoomBookingService.GetRoomBookingsAsync(Guid.Empty, DateTime.MinValue, DateTime.MaxValue);
                var eventBooking = bookings.FirstOrDefault(b => b.EventId == EventId.Value && b.Status != Core.Enums.RoomBookingStatus.Cancelled);

                if (eventBooking != null)
                {
                    _roomBookingId = eventBooking.Id;
                    _bookedRoom = await RoomRepository.GetByIdAsync(eventBooking.RoomId, _userId);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading room booking");
        }
    }

    private async Task LoadResourceReservations()
    {
        try
        {
            if (EventId.HasValue)
            {
                _reservedResources = await ResourceReservationService.GetResourceReservationsAsync(Guid.Empty, DateTime.MinValue, DateTime.MaxValue);
                _reservedResources = _reservedResources
                    .Where(r => r.EventId == EventId.Value && r.Status != Core.Enums.RoomBookingStatus.Cancelled)
                    .ToList();

                // Load all resources for display
                _allResources = await ResourceRepository.GetAllAsync(_userId);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading resource reservations");
            _reservedResources = new List<ResourceReservation>();
        }
    }

    private string GetResourceIcon(ResourceType type)
    {
        return type switch
        {
            ResourceType.Equipment => "devices",
            ResourceType.Vehicle => "directions_car",
            ResourceType.Software => "computer",
            ResourceType.Furniture => "chair",
            _ => "category"
        };
    }
}
