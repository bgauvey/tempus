@using Tempus.Core.Models
@using Tempus.Core.Interfaces
@inject IRSVPService RSVPService
@inject ILogger<ProposeTimeDialog> Logger
@inject NotificationService NotificationService
@inject DialogService DialogService

<RadzenStack Gap="1rem" Style="width: 550px;">
    <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H3">
        Propose Alternative Time
    </RadzenText>

        <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" Variant="Variant.Flat">
            <RadzenText TextStyle="TextStyle.Body2">
                Suggest a different time that works better for you. Other attendees can vote on your proposal.
            </RadzenText>
        </RadzenAlert>

        <RadzenCard Variant="Variant.Outlined">
            <RadzenStack Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H4">Current Time</RadzenText>
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenIcon Icon="event" />
                    <RadzenText TextStyle="TextStyle.Body2">
                        @OriginalStartTime.ToString("MMM dd, yyyy h:mm tt") - @OriginalEndTime.ToString("h:mm tt")
                    </RadzenText>
                </RadzenStack>
            </RadzenStack>
        </RadzenCard>

        <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H4">Proposed Time</RadzenText>

        <RadzenStack Gap="0.75rem">
            <RadzenRow>
                <RadzenColumn Size="12">
                    <RadzenLabel Text="Start Date & Time" Style="font-weight: 500;" />
                    <RadzenDatePicker @bind-Value="@proposedStartTime"
                                      ShowTime="true"
                                      DateFormat="MM/dd/yyyy"
                                      TimeFormat="h:mm tt"
                                      Style="width: 100%;"
                                      Name="startTime"
                                      Min="@DateTime.Now" />
                </RadzenColumn>
            </RadzenRow>

            <RadzenRow>
                <RadzenColumn Size="12">
                    <RadzenLabel Text="End Date & Time" Style="font-weight: 500;" />
                    <RadzenDatePicker @bind-Value="@proposedEndTime"
                                      ShowTime="true"
                                      DateFormat="MM/dd/yyyy"
                                      TimeFormat="h:mm tt"
                                      Style="width: 100%;"
                                      Name="endTime"
                                      Min="@proposedStartTime" />
                </RadzenColumn>
            </RadzenRow>

            <RadzenRow>
                <RadzenColumn Size="12">
                    <RadzenLabel Text="Reason (optional)" Style="font-weight: 500;" />
                    <RadzenTextArea @bind-Value="@reason"
                                    Placeholder="Explain why this time works better for you..."
                                    Rows="3"
                                    Style="width: 100%;"
                                    MaxLength="500" />
                    <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-tertiary-color);">
                        @(reason?.Length ?? 0) / 500 characters
                    </RadzenText>
                </RadzenColumn>
            </RadzenRow>
        </RadzenStack>

        @if (!string.IsNullOrWhiteSpace(validationError))
        {
            <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" Variant="Variant.Flat">
                @validationError
            </RadzenAlert>
        }

        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End" Style="margin-top: 1rem;">
            <RadzenButton
                Click="@Cancel"
                Variant="Variant.Text"
                ButtonStyle="ButtonStyle.Secondary"
                Text="Cancel" />
            <RadzenButton
                Click="@Submit"
                Variant="Variant.Filled"
                ButtonStyle="ButtonStyle.Primary"
                Disabled="@isSubmitting"
                Text="@(isSubmitting ? "Submitting..." : "Propose Time")" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter] public Guid EventId { get; set; }
    [Parameter] public string AttendeeEmail { get; set; } = string.Empty;
    [Parameter] public DateTime OriginalStartTime { get; set; }
    [Parameter] public DateTime OriginalEndTime { get; set; }

    private DateTime proposedStartTime;
    private DateTime proposedEndTime;
    private string? reason;
    private string? validationError;
    private bool isSubmitting = false;

    protected override void OnInitialized()
    {
        // Initialize with original duration but next day
        var duration = OriginalEndTime - OriginalStartTime;
        proposedStartTime = OriginalStartTime.AddDays(1);
        proposedEndTime = proposedStartTime.Add(duration);
    }

    private bool ValidateProposal()
    {
        validationError = null;

        if (proposedStartTime < DateTime.Now)
        {
            validationError = "Proposed time cannot be in the past.";
            return false;
        }

        if (proposedEndTime <= proposedStartTime)
        {
            validationError = "End time must be after start time.";
            return false;
        }

        var duration = proposedEndTime - proposedStartTime;
        if (duration.TotalHours > 12)
        {
            validationError = "Meeting duration cannot exceed 12 hours.";
            return false;
        }

        return true;
    }

    private async Task Submit()
    {
        if (!ValidateProposal())
            return;

        try
        {
            isSubmitting = true;

            var proposedTime = await RSVPService.ProposeAlternativeTimeAsync(
                EventId,
                AttendeeEmail,
                proposedStartTime,
                proposedEndTime,
                reason);

            Logger.LogInformation("Alternative time proposed for event {EventId} by {Email}: {Start} - {End}",
                EventId, AttendeeEmail, proposedStartTime, proposedEndTime);

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Time Proposed",
                Detail = "Your alternative time has been sent to the organizer and other attendees.",
                Duration = 4000
            });

            DialogService.Close(proposedTime);
        }
        catch (InvalidOperationException ex)
        {
            validationError = ex.Message;
            Logger.LogWarning("Proposal rejected: {Message}", ex.Message);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error proposing alternative time for event {EventId}", EventId);
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = "Failed to propose alternative time. Please try again.",
                Duration = 4000
            });
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        DialogService.Close(null);
    }
}
