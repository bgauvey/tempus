@using Microsoft.AspNetCore.Components.Authorization
@using Tempus.Core.Interfaces
@using Tempus.Core.Enums
@using Tempus.Web.Services
@inject INotificationRepository NotificationRepository
@inject IBrowserNotificationService BrowserNotificationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILogger<NotificationPoller> Logger
@implements IAsyncDisposable

@code {
    private Timer? _timer;
    private string _userId = string.Empty;
    private bool _isPolling = false;
    private bool _permissionRequested = false;

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("========================================");
        Logger.LogInformation("OnInitializedAsync called");
        Logger.LogInformation("========================================");

        try
        {
            // Get current user
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            Logger.LogDebug("User authenticated: {IsAuthenticated}", user.Identity?.IsAuthenticated);

            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
                if (userIdClaim != null)
                {
                    _userId = userIdClaim.Value;
                    Logger.LogDebug("User ID: {UserId}", _userId);

                    // Request browser notification permission
                    Logger.LogDebug("Requesting notification permission...");
                    await RequestNotificationPermission();

                    // Start polling every 15 seconds
                    Logger.LogDebug("Starting polling timer (15 second interval)...");
                    _timer = new Timer(async _ => await PollForNotifications(), null, TimeSpan.Zero, TimeSpan.FromSeconds(15));

                    Logger.LogInformation("NotificationPoller fully initialized for user {UserId}", _userId);
                }
                else
                {
                    Logger.LogError("User ID claim not found");
                }
            }
            else
            {
                Logger.LogDebug("User not authenticated, skipping initialization");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing NotificationPoller");
        }
    }

    private async Task RequestNotificationPermission()
    {
        try
        {
            if (!_permissionRequested)
            {
                var isSupported = await BrowserNotificationService.IsSupportedAsync();
                Logger.LogDebug("Browser notifications supported: {IsSupported}", isSupported);

                if (isSupported)
                {
                    var permission = await BrowserNotificationService.GetPermissionStatusAsync();
                    Logger.LogDebug("Current permission status: {Permission}", permission);

                    if (permission == "default")
                    {
                        var result = await BrowserNotificationService.RequestPermissionAsync();
                        Logger.LogInformation("Requested browser notification permission for user {UserId}. Result: {Result}", _userId, result);
                        _permissionRequested = true;
                    }
                    else if (permission == "granted")
                    {
                        Logger.LogInformation("Browser notification permission already granted for user {UserId}", _userId);
                    }
                    else
                    {
                        Logger.LogWarning("Browser notification permission denied for user {UserId}", _userId);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error requesting notification permission");
        }
    }

    private async Task PollForNotifications()
    {
        Logger.LogDebug("Poll triggered at {Time:HH:mm:ss}", DateTime.Now);

        if (_isPolling)
        {
            Logger.LogDebug("Already polling, skipping...");
            return;
        }

        if (string.IsNullOrEmpty(_userId))
        {
            Logger.LogDebug("User ID empty, skipping...");
            return;
        }

        try
        {
            _isPolling = true;
            Logger.LogDebug("Fetching notifications for user: {UserId}", _userId);

            // Get unsent notifications (notifications created by backend but not yet displayed to user)
            var notifications = await NotificationRepository.GetAllAsync(_userId);
            Logger.LogDebug("Retrieved {NotificationCount} total notifications", notifications.Count);

            // Log what we retrieved
            Logger.LogDebug("Notification breakdown:");
            foreach (var n in notifications)
            {
                Logger.LogDebug("  - {Title} | Type: {Type} | IsSent: {IsSent} | IsRead: {IsRead}", n.Title, n.Type, n.IsSent, n.IsRead);
            }

            // Filter for event reminders that haven't been shown in browser yet
            var unshownNotifications = notifications
                .Where(n => n.Type == NotificationType.EventReminder &&
                           n.IsSent && // Backend created it
                           !n.IsRead) // Not yet shown to user
                .OrderBy(n => n.CreatedAt)
                .ToList();

            Logger.LogDebug("Filtered to {UnshownCount} unshown event reminders", unshownNotifications.Count);

            if (unshownNotifications.Any())
            {
                Logger.LogInformation("Found {Count} notifications to display for user {UserId}",
                    unshownNotifications.Count, _userId);
            }
            else
            {
                Logger.LogDebug("No notifications to show (all already read or not event reminders)");
            }

            foreach (var notification in unshownNotifications)
            {
                try
                {
                    Logger.LogDebug("Attempting to show notification: {Title}", notification.Title);
                    Logger.LogDebug("  Message: {Message}", notification.Message);
                    Logger.LogDebug("  EventId: {EventId}", notification.EventId);

                    // Check permission before showing
                    var permission = await BrowserNotificationService.GetPermissionStatusAsync();
                    Logger.LogDebug("  Current permission: {Permission}", permission);

                    if (permission != "granted")
                    {
                        Logger.LogWarning("Cannot show notification - permission not granted. Status: {Status}", permission);
                        continue;
                    }

                    // Show browser notification
                    await BrowserNotificationService.ShowNotificationAsync(
                        notification.Title,
                        notification.Message,
                        notification.EventId.HasValue ? $"/calendar?eventId={notification.EventId}" : null
                    );

                    Logger.LogDebug("  Notification shown successfully!");

                    // Mark as read (displayed)
                    await NotificationRepository.MarkAsReadAsync(notification.Id, _userId);

                    Logger.LogInformation(
                        "Displayed notification '{Title}' for user {UserId}",
                        notification.Title,
                        _userId
                    );
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error displaying notification {NotificationId}", notification.Id);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error polling for notifications");
        }
        finally
        {
            _isPolling = false;
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_timer != null)
        {
            await _timer.DisposeAsync();
            Logger.LogInformation("NotificationPoller stopped for user {UserId}", _userId);
        }
    }
}
