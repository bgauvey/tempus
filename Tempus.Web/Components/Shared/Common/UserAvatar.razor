@using Microsoft.AspNetCore.Components.Authorization
@using Tempus.Core.Models
@using Microsoft.AspNetCore.Identity
@using Tempus.Core.Interfaces
@inject Tempus.Web.Components.Account.IdentityUserAccessor IdentityUserAccessor
@inject NavigationManager NavigationManager
@inject INotificationRepository NotificationRepository
@rendermode InteractiveServer

<AuthorizeView>
    <Authorized>
        <RadzenProfileMenu>
            <Template>
                <div class="user-avatar" title="@_userEmail">
                    <span class="avatar-initials">@_initials</span>
                </div>
            </Template>
            <ChildContent>
                <RadzenProfileMenuItem>
                    <div class="profile-header">
                        <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin: 0; font-weight: 600;">@_fullName</RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; opacity: 0.7;">@_userEmail</RadzenText>
                    </div>
                </RadzenProfileMenuItem>
                <RadzenProfileMenuItem Text="Profile" Path="/profile" Icon="person" />
                <RadzenProfileMenuItem Text="Settings" Path="/settings" Icon="settings" />
                <RadzenProfileMenuItem Text="Notifications" Path="/notifications" Icon="notifications" >
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <RadzenIcon Icon="notifications" />
                        <span>Notifications</span>
                        @if (_unreadCount > 0)
                        {
                            <span class="notification-badge-inline">@_unreadCount</span>
                        }
                    </div>
                </RadzenProfileMenuItem>
                <div class="menu-divider"></div>
                <li class="rz-navigation-item">
                    <form action="/Account/Logout" method="post" style="width: 100%; margin: 0;">
                        <input type="hidden" name="returnUrl" value="/" />
                        <button type="submit" class="sign-out-button">
                            <RadzenIcon Icon="logout" Style="margin-right: 0.5rem;" />
                            Sign Out
                        </button>
                    </form>
                </li>
            </ChildContent>
        </RadzenProfileMenu>
    </Authorized>
    <NotAuthorized>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
            <RadzenButton Text="Login" Click="@(() => NavigationManager.NavigateTo("/Account/Login"))"
                          ButtonStyle="ButtonStyle.Light" Style="border-radius: 10px;" />
            <RadzenButton Text="Register" Click="@(() => NavigationManager.NavigateTo("/Account/Register"))"
                          ButtonStyle="ButtonStyle.Primary" Style="border-radius: 10px;" />
        </RadzenStack>
    </NotAuthorized>
</AuthorizeView>

<style>
    /* Remove background from RadzenProfileMenu dropdown */
    ::ng-deep .rz-profile-menu,
    ::ng-deep ul.rz-profile-menu,
    ::ng-deep .rz-dropdown-menu,
    ::ng-deep .rz-menu,
    ::ng-deep .rz-context-menu {
        background-color: transparent !important;
        background: none !important;
        box-shadow: none !important;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .user-avatar:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .avatar-initials {
        color: white;
        font-size: 0.875rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .profile-header {
        padding: 1rem;
        border-bottom: 1px solid var(--rz-border-color);
    }

    .menu-divider {
        height: 1px;
        background: var(--rz-border-color);
        margin: 0.5rem 0;
    }

    .sign-out-button {
        width: 100%;
        text-align: left;
        background: none;
        border: none;
        padding: 0.75rem 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        color: var(--rz-text-color);
        font-size: 0.875rem;
        transition: background-color 0.2s;
    }

    .sign-out-button:hover {
        background-color: var(--rz-secondary);
    }

    .notification-menu-item {
        display: flex;
        align-items: center;
        width: 100%;
        position: relative;
    }

    .notification-badge {
        background: #ef4444;
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.125rem 0.5rem;
        border-radius: 12px;
        margin-left: auto;
        min-width: 20px;
        text-align: center;
    }

    .notification-badge-inline {
        background: #ef4444;
        color: white;
        font-size: 0.65rem;
        font-weight: 600;
        padding: 0.125rem 0.4rem;
        border-radius: 10px;
        margin-left: 0.5rem;
        min-width: 18px;
        text-align: center;
        display: inline-block;
        vertical-align: middle;
    }

    /* Hide the dropdown arrow */
    ::ng-deep .rz-profile-menu-toggle::after,
    .rz-profile-menu-toggle::after {
        display: none !important;
    }
</style>

@code {
    private string _fullName = "User";
    private string _userEmail = "";
    private string _initials = "U";
    private int _unreadCount = 0;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user?.Identity?.IsAuthenticated == true)
        {
            // Get email from claims
            _userEmail = user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value ?? "";

            // Try to get full name from claims
            var name = user.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value;

            if (!string.IsNullOrEmpty(name))
            {
                _fullName = name;
            }
            else if (!string.IsNullOrEmpty(_userEmail))
            {
                // Use email username part as fallback
                _fullName = _userEmail.Split('@')[0];
            }

            // Generate initials
            _initials = GenerateInitials(_fullName);

            // Load unread notification count
            var appUser = await IdentityUserAccessor.GetUserAsync(user);
            if (appUser != null)
            {
                _unreadCount = await NotificationRepository.GetUnreadCountAsync(appUser.Id);
            }
        }
    }

    private string GenerateInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "U";

        var parts = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);

        if (parts.Length == 0)
            return "U";

        if (parts.Length == 1)
        {
            // Single name - take first two letters
            return parts[0].Length >= 2
                ? parts[0].Substring(0, 2).ToUpper()
                : parts[0].ToUpper();
        }

        // Multiple names - take first letter of first and last name
        return $"{parts[0][0]}{parts[^1][0]}".ToUpper();
    }

    [Inject]
    private AuthenticationStateProvider AuthenticationStateProvider { get; set; } = default!;
}
