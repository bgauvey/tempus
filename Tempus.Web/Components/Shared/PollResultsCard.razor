@using Tempus.Core.Interfaces
@using Tempus.Core.Models
@inject IPollService PollService
@inject ILogger<PollResultsCard> Logger

<RadzenCard Variant="Variant.Outlined" Style="@Style">
    <RadzenStack Gap="1rem">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
            <RadzenText TextStyle="TextStyle.Subtitle1" TagName="TagName.H4">
                Poll Results
            </RadzenText>
            @if (Poll?.FinalizedAt.HasValue == true)
            {
                <RadzenBadge Text="Finalized" BadgeStyle="BadgeStyle.Success" />
            }
            else if (Poll?.IsActive == true)
            {
                <RadzenBadge Text="Active" BadgeStyle="BadgeStyle.Info" />
            }
            else
            {
                <RadzenBadge Text="Inactive" BadgeStyle="BadgeStyle.Secondary" />
            }
        </RadzenStack>

        @if (Poll != null)
        {
            <RadzenStack Gap="0.75rem">
                @foreach (var slot in Poll.TimeSlots.OrderByDescending(ts => ts.GetPopularityScore()))
                {
                    var isSelected = Poll.SelectedTimeSlotId == slot.Id;
                    var borderColor = isSelected ? "var(--rz-success)" : "transparent";

                    <RadzenCard Variant="Variant.Outlined" Style="@($"padding: 1rem; border-left: 4px solid {borderColor};")">
                        <RadzenStack Gap="0.5rem">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenStack Gap="0.25rem">
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                        <RadzenText TextStyle="TextStyle.Subtitle2" Style="font-weight: 600;">
                                            @slot.StartTime.ToString("ddd, MMM dd, yyyy h:mm tt")
                                        </RadzenText>
                                        @if (isSelected)
                                        {
                                            <RadzenBadge Text="Selected" BadgeStyle="BadgeStyle.Success" />
                                        }
                                    </RadzenStack>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">
                                        @slot.StartTime.ToString("h:mm tt") - @slot.EndTime.ToString("h:mm tt")
                                    </RadzenText>
                                </RadzenStack>
                                <RadzenStack Gap="0.25rem" Style="text-align: right;">
                                    <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-tertiary-color);">
                                        Score: @slot.GetPopularityScore().ToString("F1")
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption">
                                        @slot.ResponseCount responses
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenStack>

                            @if (slot.ResponseCount > 0)
                            {
                                <RadzenStack Gap="0.5rem">
                                    <!-- Response breakdown -->
                                    <RadzenRow>
                                        <RadzenColumn Size="4">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.25rem">
                                                <RadzenIcon Icon="check_circle" Style="color: var(--rz-success); font-size: 1.25rem;" />
                                                <RadzenStack Gap="0">
                                                    <RadzenText TextStyle="TextStyle.H6" Style="font-weight: 600;">
                                                        @slot.YesCount
                                                    </RadzenText>
                                                    <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-tertiary-color);">
                                                        Yes (@slot.GetYesPercentage().ToString("F0")%)
                                                    </RadzenText>
                                                </RadzenStack>
                                            </RadzenStack>
                                        </RadzenColumn>
                                        <RadzenColumn Size="4">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.25rem">
                                                <RadzenIcon Icon="help" Style="color: var(--rz-warning); font-size: 1.25rem;" />
                                                <RadzenStack Gap="0">
                                                    <RadzenText TextStyle="TextStyle.H6" Style="font-weight: 600;">
                                                        @slot.MaybeCount
                                                    </RadzenText>
                                                    <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-tertiary-color);">
                                                        Maybe
                                                    </RadzenText>
                                                </RadzenStack>
                                            </RadzenStack>
                                        </RadzenColumn>
                                        <RadzenColumn Size="4">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.25rem">
                                                <RadzenIcon Icon="cancel" Style="color: var(--rz-danger); font-size: 1.25rem;" />
                                                <RadzenStack Gap="0">
                                                    <RadzenText TextStyle="TextStyle.H6" Style="font-weight: 600;">
                                                        @slot.NoCount
                                                    </RadzenText>
                                                    <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-tertiary-color);">
                                                        No
                                                    </RadzenText>
                                                </RadzenStack>
                                            </RadzenStack>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <!-- Visual bar chart -->
                                    <RadzenStack Orientation="Orientation.Horizontal" Style="height: 20px; border-radius: 4px; overflow: hidden;">
                                        @if (slot.YesCount > 0)
                                        {
                                            <div style="@($"flex: {slot.YesCount}; background: var(--rz-success); opacity: 0.8;")" title="@($"{slot.YesCount} Yes")"></div>
                                        }
                                        @if (slot.MaybeCount > 0)
                                        {
                                            <div style="@($"flex: {slot.MaybeCount}; background: var(--rz-warning); opacity: 0.8;")" title="@($"{slot.MaybeCount} Maybe")"></div>
                                        }
                                        @if (slot.NoCount > 0)
                                        {
                                            <div style="@($"flex: {slot.NoCount}; background: var(--rz-danger); opacity: 0.8;")" title="@($"{slot.NoCount} No")"></div>
                                        }
                                    </RadzenStack>
                                </RadzenStack>
                            }
                            else
                            {
                                <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-tertiary-color); text-align: center; padding: 1rem;">
                                    No responses yet
                                </RadzenText>
                            }

                            @if (ShowActions && IsOrganizer && !Poll.FinalizedAt.HasValue)
                            {
                                <RadzenButton Click="@(() => SelectTimeSlot(slot.Id))"
                                              ButtonStyle="ButtonStyle.Success"
                                              Variant="Variant.Flat"
                                              Size="ButtonSize.Small"
                                              Text="Select This Time"
                                              Icon="check"
                                              Style="width: 100%; margin-top: 0.5rem;" />
                            }
                        </RadzenStack>
                    </RadzenCard>
                }
            </RadzenStack>

            @if (Poll.Responses.Any() && Poll.ShowParticipantNames)
            {
                <RadzenFieldset Text="Participants">
                    <RadzenStack Gap="0.25rem">
                        @foreach (var respondent in Poll.Responses.Select(r => r.RespondentEmail).Distinct())
                        {
                            <RadzenText TextStyle="TextStyle.Body2">
                                <RadzenIcon Icon="person" Style="font-size: 1rem;" /> @respondent
                            </RadzenText>
                        }
                    </RadzenStack>
                </RadzenFieldset>
            }
        }
        else
        {
            <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color); text-align: center; padding: 2rem;">
                No poll data available
            </RadzenText>
        }
    </RadzenStack>
</RadzenCard>

@code {
    [Parameter] public SchedulingPoll? Poll { get; set; }
    [Parameter] public Guid? PollId { get; set; }
    [Parameter] public bool ShowActions { get; set; } = true;
    [Parameter] public bool IsOrganizer { get; set; } = false;
    [Parameter] public EventCallback<Guid> OnTimeSlotSelected { get; set; }
    [Parameter] public string? Style { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        if (Poll == null && PollId.HasValue)
        {
            try
            {
                Poll = await PollService.GetPollResultsAsync(PollId.Value);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error loading poll results for {PollId}", PollId);
            }
        }
    }

    private async Task SelectTimeSlot(Guid timeSlotId)
    {
        await OnTimeSlotSelected.InvokeAsync(timeSlotId);
    }
}
